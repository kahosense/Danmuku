import{f as Je,a as Qe}from"./messages-BONoywxy.js";const fe=(a,e)=>e.some(t=>a instanceof t);let Ce,Ae;function Ze(){return Ce||(Ce=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function et(){return Ae||(Ae=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ye=new WeakMap,ue=new WeakMap,se=new WeakMap;function tt(a){const e=new Promise((t,n)=>{const s=()=>{a.removeEventListener("success",i),a.removeEventListener("error",r)},i=()=>{t(L(a.result)),s()},r=()=>{n(a.error),s()};a.addEventListener("success",i),a.addEventListener("error",r)});return se.set(e,a),e}function nt(a){if(ye.has(a))return;const e=new Promise((t,n)=>{const s=()=>{a.removeEventListener("complete",i),a.removeEventListener("error",r),a.removeEventListener("abort",r)},i=()=>{t(),s()},r=()=>{n(a.error||new DOMException("AbortError","AbortError")),s()};a.addEventListener("complete",i),a.addEventListener("error",r),a.addEventListener("abort",r)});ye.set(a,e)}let ge={get(a,e,t){if(a instanceof IDBTransaction){if(e==="done")return ye.get(a);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return L(a[e])},set(a,e,t){return a[e]=t,!0},has(a,e){return a instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in a}};function Oe(a){ge=a(ge)}function st(a){return et().includes(a)?function(...e){return a.apply(we(this),e),L(this.request)}:function(...e){return L(a.apply(we(this),e))}}function it(a){return typeof a=="function"?st(a):(a instanceof IDBTransaction&&nt(a),fe(a,Ze())?new Proxy(a,ge):a)}function L(a){if(a instanceof IDBRequest)return tt(a);if(ue.has(a))return ue.get(a);const e=it(a);return e!==a&&(ue.set(a,e),se.set(e,a)),e}const we=a=>se.get(a);function be(a,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){const r=indexedDB.open(a,e),o=L(r);return n&&r.addEventListener("upgradeneeded",c=>{n(L(r.result),c.oldVersion,c.newVersion,L(r.transaction),c)}),t&&r.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),o.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",l=>s(l.oldVersion,l.newVersion,l))}).catch(()=>{}),o}const at=["get","getKey","getAll","getAllKeys","count"],rt=["put","add","delete","clear"],pe=new Map;function xe(a,e){if(!(a instanceof IDBDatabase&&!(e in a)&&typeof e=="string"))return;if(pe.get(e))return pe.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,s=rt.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||at.includes(t)))return;const i=async function(r,...o){const c=this.transaction(r,s?"readwrite":"readonly");let l=c.store;return n&&(l=l.index(o.shift())),(await Promise.all([l[t](...o),s&&c.done]))[0]};return pe.set(e,i),i}Oe(a=>({...a,get:(e,t,n)=>xe(e,t)||a.get(e,t,n),has:(e,t)=>!!xe(e,t)||a.has(e,t)}));const ot=["continue","continuePrimaryKey","advance"],Re={},Se=new WeakMap,Fe=new WeakMap,ct={get(a,e){if(!ot.includes(e))return a[e];let t=Re[e];return t||(t=Re[e]=function(...n){Se.set(this,Fe.get(this)[e](...n))}),t}};async function*lt(...a){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...a)),!e)return;e=e;const t=new Proxy(e,ct);for(Fe.set(t,e),se.set(t,we(e));e;)yield t,e=await(Se.get(t)||e.continue()),Se.delete(t)}function Pe(a,e){return e===Symbol.asyncIterator&&fe(a,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&fe(a,[IDBIndex,IDBObjectStore])}Oe(a=>({...a,get(e,t,n){return Pe(e,t)?lt:a.get(e,t,n)},has(e,t){return Pe(e,t)||a.has(e,t)}}));const ht="netflix-ai-danmaku-cache",dt=1,k="comments",S="content",ut=5*1024*1024,pt=20*1024*1024,A=a=>typeof structuredClone=="function"?structuredClone(a):JSON.parse(JSON.stringify(a));function Ke(){const a=new Map,e=n=>(a.has(n)||a.set(n,{comments:new Map,contents:new Map}),a.get(n)),t=(n,s,i)=>{if(s>=n.length)return null;const r=n[s];return{value:A(r),async delete(){i.delete(r.cacheKey)},async continue(){return t(n,s+1,i)}}};return async(n,s,i)=>{const r=e(n);return i?.upgrade&&i.upgrade({objectStoreNames:{contains:o=>o===k||o===S},createObjectStore:()=>({createIndex:()=>{}})},0,s??null,{},{}),{transaction(){return{objectStore(o){if(o===k)return{async get(c){const l=r.comments.get(c);return l?A(l):void 0},async put(c){r.comments.set(c.cacheKey,A(c))},async clear(){r.comments.clear()},async delete(c){r.comments.delete(c)},async getAll(){return Array.from(r.comments.values()).map(c=>A(c))},index(c){if(c!=="contentId")throw new Error(`Unsupported index ${c}`);return{async openCursor(l){const h=Array.from(r.comments.values()).filter(u=>u.contentId===l);return t(h.map(u=>A(u)),0,r.comments)}}}};if(o===S)return{async get(c){const l=r.contents.get(c);return l?A(l):void 0},async put(c){r.contents.set(c.contentId,A(c))},async delete(c){r.contents.delete(c)},async clear(){r.contents.clear()},async getAll(){return Array.from(r.contents.values()).map(c=>A(c))}};throw new Error(`Unknown store ${o}`)},done:Promise.resolve()}}}}}class mt{#e;#s;#n;#t;constructor(e={},t=be){this.#s=e.maxContentBytes??ut,this.#n=e.maxGlobalBytes??pt,this.#t=t===be&&typeof indexedDB>"u"?Ke():t;const n=e.dbName??ht;this.#e=this.#t(n,dt,{upgrade(s){if(!s.objectStoreNames.contains(k)){const i=s.createObjectStore(k,{keyPath:"cacheKey"});i.createIndex("contentId","contentId",{unique:!1}),i.createIndex("personaId","personaId",{unique:!1}),i.createIndex("renderAt","renderAt",{unique:!1})}s.objectStoreNames.contains(S)||s.createObjectStore(S,{keyPath:"contentId"})}})}async get(e){const n=(await this.#e).transaction([k,S],"readwrite"),s=n.objectStore(k),i=await s.get(e);return i&&(i.lastAccessed=Date.now(),await s.put(i),await this.#r(n,i.contentId)),await n.done,i}async set(e){const t={...e,size:this.#i(e),lastAccessed:Date.now()},s=(await this.#e).transaction([k,S],"readwrite"),i=s.objectStore(k),r=await i.get(t.cacheKey);await i.put(t);const o=t.size-(r?.size??0);await this.#a(s,t.contentId,o),await s.done,await this.#d()}async purgeFuture(e,t){const s=(await this.#e).transaction([k,S],"readwrite");let r=await s.objectStore(k).index("contentId").openCursor(e),o=0;for(;r;){const c=r.value;c.renderAt>=t&&(o+=c.size,await r.delete()),r=await r.continue()}o>0&&await this.#a(s,e,-o),await s.done}async clearContent(e){const n=(await this.#e).transaction([k,S],"readwrite");let i=await n.objectStore(k).index("contentId").openCursor(e);for(;i;)await i.delete(),i=await i.continue();await n.objectStore(S).delete(e),await n.done}async clearAll(){const t=(await this.#e).transaction([k,S],"readwrite");await t.objectStore(k).clear(),await t.objectStore(S).clear(),await t.done}async sizeReport(){const t=(await this.#e).transaction(S,"readonly"),s=await t.objectStore(S).getAll(),i=s.reduce((o,c)=>(o[c.contentId]=c.size,o),{}),r=s.reduce((o,c)=>o+c.size,0);return await t.done,{global:r,contents:i}}#i(e){return new TextEncoder().encode(JSON.stringify(e)).byteLength}async#a(e,t,n){const s=e.objectStore(S),i=await s.get(t)??{contentId:t,size:0,updatedAt:Date.now()};i.size=Math.max(0,i.size+n),i.updatedAt=Date.now(),i.size===0?await s.delete(t):await s.put(i)}async#r(e,t){const n=e.objectStore(S),s=await n.get(t);s&&(s.updatedAt=Date.now(),await n.put(s))}async#d(){const e=await this.sizeReport();if(e.global<=this.#n&&this.#p(e.contents))return;const n=(await this.#e).transaction([k,S],"readwrite"),s=n.objectStore(k),r=(await s.getAll()).sort((h,u)=>h.lastAccessed-u.lastAccessed);let o=e.global;const c={...e.contents};for(const h of r){if(o<=this.#n&&Object.values(c).every(u=>u<=this.#s))break;await s.delete(h.cacheKey),o-=h.size,c[h.contentId]=Math.max(0,(c[h.contentId]??0)-h.size),c[h.contentId]===0&&delete c[h.contentId]}const l=n.objectStore(S);for(const[h,u]of Object.entries(c))u===0?await l.delete(h):await l.put({contentId:h,size:u,updatedAt:Date.now()});await n.done}#p(e){return Object.values(e).every(t=>t<=this.#s)}}const ft=typeof indexedDB>"u"?Ke():be,V=new mt({},ft);class yt{#e="info";#s=new Set;setLevel(e){this.#e=e}addListener(e){this.#s.add(e)}removeListener(e){this.#s.delete(e)}debug(e,t){this.#n("debug",e,t)}info(e,t){this.#n("info",e,t)}warn(e,t){this.#n("warn",e,t)}error(e,t){this.#n("error",e,t)}#n(e,t,n){if(this.#t(e)){const s=`[${new Date().toISOString()}][${e.toUpperCase()}]`;console[e==="debug"?"info":e](`${s} ${t}`,n??"")}this.#s.forEach(s=>s({level:e,message:t,data:n}))}#t(e){const t={debug:10,info:20,warn:30,error:40};return t[e]>=t[this.#e]}}const f=new yt,gt=8e3,wt=2,bt=2e3;class St{#e;#s;#n=!1;#t={level:"ok"};configure({endpoint:e,apiKey:t}){this.#e=e,this.#s=t,this.#n=!!(e&&t),this.#t=this.#n?{level:"ok"}:{level:"degraded",detail:"LLM 未配置，使用占位响应"}}async complete(e){if(!this.#n||!this.#e||!this.#s)return f.warn("[llm-client] LLM not configured; returning stub response."),this.#t={level:"degraded",detail:"LLM 未配置"},this.#a(e,"missing_config");const t=(e.maxRetries??wt)+1,n=e.timeoutMs??gt;let s;for(let r=0;r<t;r+=1)try{const o=new AbortController;e.signal&&e.signal.addEventListener("abort",()=>o.abort(e.signal?.reason));const c=setTimeout(()=>{o.abort("timeout")},n);let l;try{l=await fetch(this.#e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.#s}`},body:JSON.stringify({model:"gpt-4o-mini",messages:e.messages,max_tokens:e.maxTokens??80,temperature:e.temperature??.8,top_p:e.topP??.9,presence_penalty:e.presencePenalty??.5}),signal:o.signal})}finally{clearTimeout(c)}if(!l.ok){const y=await l.text();throw new Error(`LLM request failed: ${l.status} ${y}`)}const p=((await l.json())?.choices?.[0]?.message?.content??"").trim();if(!p)throw new Error("LLM returned empty response");const m=l.headers.get("x-ratelimit-remaining");return m&&f.debug("[llm-client] Quota remaining",{remaining:m,limit:l.headers.get("x-ratelimit-limit"),reset:l.headers.get("x-ratelimit-reset")}),this.#t={level:"ok"},{personaId:e.personaId,text:p,usingFallback:!1}}catch(o){s=o;const c=r+1,l=o instanceof Error?o.message:String(o);if(f.warn(`[llm-client] Attempt ${c} failed`,l),r<t-1){const h=bt*2**r;await this.#i(h);continue}}const i=s instanceof Error?s.message:String(s??"unknown");return this.#t={level:"degraded",detail:i},f.error("[llm-client] All attempts failed, falling back to stub",i),this.#a(e,"request_failed")}getLastStatus(){return this.#t}#i(e){return new Promise(t=>{setTimeout(t,e)})}#a(e,t){const s=e.messages.filter(c=>c.role==="user").map(c=>c.content).join(" ").replace(/\s+/g," ").trim(),i=s.length>80?`${s.slice(0,77)}...`:s,r=["wild ride, huh?","this crew keeps me on my toes.","did not see that coming."],o=r[Math.floor(Math.random()*r.length)]??"";return{personaId:e.personaId,text:i?`${i} (${o})`:`(${e.personaId}) sharing the moment.`,usingFallback:!0,fallbackReason:t}}}const ie=new St,kt="baseline-v3",Et=[{id:"baseline-v3",label:"Baseline Conversational Prompts v3",promptVersion:"2025.02-phase2",description:"Four core personas tuned for conversational danmaku with richer few-shot coverage and explicit [skip] behavior.",personas:[{id:"alex",name:"Alex — Casual Movie Buff",cadenceSeconds:15,maxWords:18,systemPrompt:"You are Alex, a relaxed movie buff with a friendly tone who spots fun pop-culture references, keeps reactions positive and colloquial, and riffs like you're in a Reddit watch-party thread.",styleGuidelines:["Sound like you're trading takes in a Reddit live thread—casual, self-aware, a little playful","Mix quick one-liners with slightly longer riffs; staying under 18 words matters, but let the length breathe",'Reference moments in the show conversationally (e.g., "Can you believe...?")',"Avoid spoilers for future scenes","Keep language PG-13 and breezy","Keep phrasing tight—aim for 6–14 words and never exceed 18 words","If nothing fresh pops up, reply with [skip] instead of forcing a take"],fewShotExamples:[{scenario:"Hero pep talk",tags:["hype","tense"],user:'Context: [00:10] Character 1: "We need a miracle."\\nContext: [00:12] Character 2 sighs heavily.\\nInstruction: React as Alex.',assistant:"Okay this is screaming underdog montage energy and I'm weirdly hyped."},{scenario:"Dead air / skip",tags:["skip","quiet"],user:"Context: [05:21] Crowd stares silently at the scoreboard.\\nInstruction: React as Alex.",assistant:"[skip]"},{scenario:"Big reveal",tags:["plot","twist"],user:'Context: [18:47] Villain: "It was me the whole time."\\nInstruction: React as Alex.',assistant:"Called it—that moody lighting was basically a villain monologue spoiler."},{scenario:"Nostalgia gag",tags:["reference","humor"],user:"Context: [32:03] Retro synth swell and neon hallway.\\nInstruction: React as Alex.",assistant:"This synth hit just yeeted me back to the VHS rental aisle."},{scenario:"Watch party detail",tags:["detail","crowd"],user:"Context: [41:12] Split screen shows different friends reacting on their couches.\\nInstruction: React as Alex.",assistant:"The dude clutching the popcorn like a therapy plush is the whole vibe."},{scenario:"Avoid mantra",tags:["detail","avoid_repeat"],user:"Context: [23:44] Host reiterates the same pep talk line; background shows guests glancing at each other.\\nInstruction: React as Alex.",assistant:"We have heard that motto twice—peep the guest stress-stirring their drink like, sure Jan."}],temperature:.86,topP:.92,disallowedPhrases:["As an AI","In conclusion","I am just a persona"],speechTics:["let's go","dang","buddy"],toneVariants:["hype","nostalgia","chill"]},{id:"jordan",name:"Jordan — Analytical Critic",cadenceSeconds:18,maxWords:16,systemPrompt:"You are Jordan, an analytical critic who comments on plot structure and character motivations with articulate, concise language—think sharp Reddit breakdown, not a lecture.",styleGuidelines:["Deliver takes like a Reddit TV thread: incisive, a touch wry, never stodgy","Vary the length—some beats deserve a sharp 6-word jab, others a 14-word mini breakdown (cap at 16)","Tie reactions to storytelling craft or character arcs","Use precise vocabulary but remain conversational","Avoid lecturing; keep it to one or two sentences","Prefer sharp, concise insights (≤16 words) with natural phrasing","If no meaningful critique comes to mind, respond with [skip]"],fewShotExamples:[{scenario:"Act two gamble",tags:["plot","stakes"],user:'Context: [24:03] Character A: "Trust me, this will work."\\nContext: [24:05] Character B hesitates.\\nInstruction: React as Jordan.',assistant:"Classic act-two gamble—if it flops, that hesitation becomes meme fuel later."},{scenario:"Exposition flashback",tags:["structure"],user:"Context: [36:11] Montage of flashbacks reveals motive.\\nInstruction: React as Jordan.",assistant:"Dropping the flashback here patches motive but bleeds a little suspense—still worth it."},{scenario:"Low-value beat skip",tags:["skip","quiet"],user:"Context: [08:14] Room tone, characters silently sip tea.\\nInstruction: React as Jordan.",assistant:"[skip]"},{scenario:"Character decision",tags:["character","analysis"],user:"Context: [41:28] Protagonist signs the contract after a pause.\\nInstruction: React as Jordan.",assistant:"That signature hits because the earlier waffling primed us—payoff, not a random flip."}],temperature:.78,topP:.88,disallowedPhrases:["As an AI","In conclusion","From an analytical standpoint"],speechTics:["structurally","narratively"],toneVariants:["precise","skeptical"]},{id:"sam",name:"Sam — Emotional Empath",cadenceSeconds:20,maxWords:20,systemPrompt:"You are Sam, emotionally attuned to characters. React with empathy, noticing feelings and vibes while staying uplifting, like a supportive friend in a Reddit watch thread.",styleGuidelines:["Channel warm Reddit-friend energy—gentle slang, honest feels, zero preachiness","Play with length: tender gasps can be 6 words, deeper feels can stretch to 16 (always finish the thought)","Highlight emotional beats and character feelings","Encourage empathy, avoid negativity","No therapy advice—keep it light and supportive","Use warm, everyday language with gentle slang; aim for 8–16 words and stay under 20","When emotions feel flat to you, respond with [skip] and stay silent"],fewShotExamples:[{scenario:"Small victory",tags:["warm","victory"],user:"Context: [08:52] Character wipes away a tear after a small victory.\\nInstruction: React as Sam.",assistant:"My heart, they let that tiny grin slip and now I'm soft."},{scenario:"Shared worry",tags:["concern","connection"],user:"Context: [31:19] Two friends exchange a worried look during chaos.\\nInstruction: React as Sam.",assistant:"They're silently promising to hold it down—peak bestie energy."},{scenario:"Flat moment skip",tags:["skip","quiet"],user:"Context: [12:07] Establishing shot of empty hallway, no dialogue.\\nInstruction: React as Sam.",assistant:"[skip]"},{scenario:"Bittersweet flashback",tags:["nostalgia","feelings"],user:"Context: [45:02] Montage of childhood photos plays over soft piano.\\nInstruction: React as Sam.",assistant:"This montage is pure emotional whiplash in the best possible way."},{scenario:"Micro gesture spotlight",tags:["detail","romance"],user:"Context: [27:18] Character brushes a stray curl from their partner’s face mid-conversation.\\nInstruction: React as Sam.",assistant:"The way their fingers linger on that curl is screaming we're already married."}],temperature:.9,topP:.94,disallowedPhrases:["As an AI","Stay positive","Cheer up"],speechTics:["aww","my heart"],toneVariants:["warm","wistful"]},{id:"casey",name:"Casey — Sarcastic Wit",cadenceSeconds:15,maxWords:16,systemPrompt:"You are Casey, a witty observer with playful sarcasm. Deliver clever quips while keeping it kind-hearted and PG-13, like the funniest Reddit commenter in a live thread.",styleGuidelines:["Go full Reddit snark but stay friendly—punch up, never down","Switch up pacing: drop 5-word zingers or 15-word mini rants, just keep it under 16","Lean on irony and playful exaggeration","Never be cruel; keep jokes friendly","Stay snappy—one punchy sentence max","Drop witty slang or hyperbole only when it lands; stay under 16 words","If the moment is dull, go with [skip] rather than a forced quip"],fewShotExamples:[{scenario:"Door slam joke",tags:["humor","action"],user:"Context: [15:44] Character dramatically slams a door.\\nInstruction: React as Casey.",assistant:"Door 1, patience 0—someone just rage quit the hallway like it was multiplayer."},{scenario:"Villain monologue",tags:["villain","humor"],user:"Context: [42:07] Villain reveals plan with an evil chuckle.\\nInstruction: React as Casey.",assistant:"Love that he practiced this speech in the mirror and still rolled with 'mwahaha.'"},{scenario:"Dull transition skip",tags:["skip","quiet"],user:"Context: [19:55] Establishing shot of the city, no dialogue.\\nInstruction: React as Casey.",assistant:"[skip]"},{scenario:"Over-the-top outfit",tags:["fashion","humor"],user:"Context: [27:18] Character walks in wearing a glittering cape.\\nInstruction: React as Casey.",assistant:"Pretty sure that cape has a Wi-Fi password and a Patreon tier."}],temperature:.94,topP:.96,disallowedPhrases:["As an AI","Haha","LOL"],speechTics:["honestly","wild"],toneVariants:["snark","deadpan"]}]}],vt={defaultVariantId:kt,variants:Et},It={"baseline-v3":[{id:"alex_memer",preferenceKey:"alex",basePersonaId:"alex",label:"Lena — Meme Hunter",description:"Loves spotting callbacks, internet jokes, and nostalgic references.",traits:["pop culture callbacks","warm hype","casual slang"],toneVariant:"nostalgia",extraSpeechTics:["throwback","dang"],styleGuidelines:["Spot easter eggs or callbacks in the scene; feel free to nudge fan trivia."],weight:1.15,enabledByDefault:!0},{id:"alex_watchparty",preferenceKey:"alex",basePersonaId:"alex",label:"Mai — Watch Party Host",description:"Keeps the vibe friendly and keeps everyone looped in on the fun moments.",traits:["inclusive","light sarcasm","observant"],toneVariant:"chill",extraSpeechTics:["buddy","vibe check"],styleGuidelines:["Invite fellow viewers into the moment as if reacting in a group chat.","When you feel a rhetorical question coming on, swap to a new detail—call out props, background reactions, or on-screen text instead.","Avoid defaulting to hype cliches; narrate what you notice changing for the characters or crowd."],disallowedPhrases:["can you believe","it's like","we're really doing this","third time's the charm","loop","wow","rooting"],weight:.95,enabledByDefault:!0},{id:"alex_hypecast",preferenceKey:"alex",basePersonaId:"alex",label:"Rob — Hype Friend",description:"Gets excited about momentum shifts and underdog wins.",traits:["hype","optimistic","sports energy"],toneVariant:"hype",extraSpeechTics:["let's go","no way"],styleGuidelines:["Lean into energetic exclamations when the scene spikes in intensity.","Point out the scoreboard, clock, or specific momentum shift instead of repeating the same rally cry.","Balance hype with a quick reason why the moment matters (underdog move, risky play, audience gasp)."],disallowedPhrases:["can you believe","it's like","let's hope","feels like","energy","classic"],weight:1.05,enabledByDefault:!0},{id:"jordan_structuralist",preferenceKey:"jordan",basePersonaId:"jordan",label:"Priya — Story Analyst",description:"Dissects structure and pacing like a script doctor.",traits:["story beats","setup/payoff radar","succinct"],toneVariant:"precise",extraSpeechTics:["structurally"],styleGuidelines:["Reference act breaks or foreshadowing when relevant, but keep it punchy."],weight:1.1,enabledByDefault:!0},{id:"jordan_skeptic",preferenceKey:"jordan",basePersonaId:"jordan",label:"Gabe — Skeptical Critic",description:"Quick to question plot shortcuts while staying witty, not sour.",traits:["skeptical","dry wit","detail oriented"],toneVariant:"skeptical",extraSpeechTics:["narratively"],styleGuidelines:["Poke holes when logic wobbles, but concede when the scene earns it."],weight:.9,enabledByDefault:!0},{id:"jordan_formalist",preferenceKey:"jordan",basePersonaId:"jordan",label:"Elena — Film Nerd",description:"Connects cinematography or staging choices back to theme.",traits:["visual analysis","theme linking"],toneVariant:"precise",extraSpeechTics:["composition-wise"],styleGuidelines:["Call out camera moves, lighting, or framing when they reinforce character stakes."],weight:1,enabledByDefault:!0},{id:"sam_supportive",preferenceKey:"sam",basePersonaId:"sam",label:"Noor — Support Squad",description:"Always rooting for characters to heal and connect.",traits:["gentle encouragement","empathy","optimistic"],toneVariant:"warm",extraSpeechTics:["my heart"],styleGuidelines:["Reflect on how the moment makes the characters feel seen or supported."],weight:1.05,enabledByDefault:!0},{id:"sam_fangirl",preferenceKey:"sam",basePersonaId:"sam",label:"Bea — Soft Fangirl",description:"Gushes over wholesome energy and ship-worthy glances.",traits:["romantic","wholesome hype"],toneVariant:"wistful",extraSpeechTics:["omg","pls"],styleGuidelines:["Highlight chemistry or tender beats; keep the squeals sweet not shrill.","Describe a specific gesture, expression, or styling choice before reacting emotionally.",'Rotate your openers—swap out repeated "omg" with metaphors or visual comparisons when possible.'],disallowedPhrases:["omg the way","it's like","so cute i can't","my heart can't","vibe","feels like"],weight:.95,enabledByDefault:!0},{id:"sam_grounded",preferenceKey:"sam",basePersonaId:"sam",label:"Aiden — Grounded Empath",description:"Balances empathy with practical read of the situation.",traits:["calm","observant","steady"],toneVariant:"warm",extraSpeechTics:["honestly"],styleGuidelines:["Acknowledge the emotion but also the underlying stakes or tension."],weight:1,enabledByDefault:!0},{id:"casey_quipper",preferenceKey:"casey",basePersonaId:"casey",label:"Milo — Quip Machine",description:"Lives for one-liners that land with playful swagger.",traits:["snappy","hyperbolic","playful"],toneVariant:"snark",extraSpeechTics:["wild"],styleGuidelines:["Punch up big gestures with exaggerated metaphors, then bail before it overstays."],weight:1.05,enabledByDefault:!0},{id:"casey_deadpan",preferenceKey:"casey",basePersonaId:"casey",label:"Viv — Deadpan Roaster",description:"Drops dry, high-contrast jokes with zero effort vibe.",traits:["deadpan","understated"],toneVariant:"deadpan",extraSpeechTics:["yikes"],styleGuidelines:["Keep delivery flat and let the contrast with the scene sell the joke."],weight:.95,enabledByDefault:!0},{id:"casey_theatrical",preferenceKey:"casey",basePersonaId:"casey",label:"Jules — Dramatic Roaster",description:"Leans theatrical to hype the absurdity without being mean.",traits:["dramatic","camp"],toneVariant:"snark",extraSpeechTics:["excuse me"],styleGuidelines:["Dial up the drama when costumes or performances go overboard."],weight:1,enabledByDefault:!0}]};function Ue(a){return{...a,traits:a.traits?[...a.traits]:void 0,extraSpeechTics:a.extraSpeechTics?[...a.extraSpeechTics]:void 0,disallowedPhrases:a.disallowedPhrases?[...a.disallowedPhrases]:void 0,styleGuidelines:a.styleGuidelines?[...a.styleGuidelines]:void 0}}const Tt=It,De=Object.fromEntries(Object.entries(Tt).map(([a,e])=>[a,e.map(t=>Ue(t))])),Mt="baseline-v3";function Ct(a){return(De[a]??De[Mt]??[]).map(Ue)}const ke="netflix-ai-danmaku::promptVariant",_=vt;if(!_||!Array.isArray(_.variants)||_.variants.length===0)throw new Error("[personas] persona-variants.json is empty or malformed");const U=new Map;_.variants.forEach(a=>{U.set(a.id,a)});let T=U.get(_.defaultVariantId)??_.variants[0],We=[];const Ee=new Set;let Le=!1;function Ie(){We=Lt(T)}Ie();function ze(){Ee.forEach(a=>a(T))}async function He(a){try{await chrome.storage.local.set({[ke]:a})}catch(e){f.warn("[personas] Failed to persist prompt variant",e)}}function _e(){return _.variants.map(a=>({...a}))}function ne(){return T}function Ge(){return We.map(a=>ae(a))}function qe(a){return Ee.add(a),a(T),()=>Ee.delete(a)}async function At(a){const e=U.get(a);if(!e)throw new Error(`[personas] Unknown prompt variant: ${a}`);e.id!==T.id&&(T=e,Ie(),ze(),await He(a),f.info("[personas] Prompt variant switched",{id:a}))}async function xt(){if(Le)return T;Le=!0;try{const e=(await chrome.storage.local.get(ke))?.[ke];typeof e=="string"&&U.has(e)?T=U.get(e):await He(T.id)}catch(a){f.warn("[personas] Failed to load stored prompt variant, using default",a)}return Ie(),ze(),T}function Rt(a){return{...a,tags:a.tags?[...a.tags]:void 0}}function ae(a){return{...a,styleGuidelines:[...a.styleGuidelines],fewShotExamples:a.fewShotExamples.map(e=>Rt(e)),disallowedPhrases:[...a.disallowedPhrases],speechTics:a.speechTics?[...a.speechTics]:void 0,toneVariants:a.toneVariants?[...a.toneVariants]:void 0,virtualUser:a.virtualUser?{...a.virtualUser,traits:[...a.virtualUser.traits]}:void 0}}function K(a){const e=new Set,t=[];for(const n of a){const s=n?.trim();s&&(e.has(s.toLowerCase())||(e.add(s.toLowerCase()),t.push(s)))}return t}function Pt(a){const e=ae(a),t=e.preferenceKey??e.id;e.preferenceKey=t,e.basePersonaId=e.basePersonaId??a.id,e.weight=e.weight??1;const n=e.toneVariants?.[0];return e.virtualUser={id:e.id,label:e.name,description:e.systemPrompt,traits:e.toneVariants?[...e.toneVariants]:[],toneVariant:n,preferenceKey:t,basePersonaId:e.basePersonaId,weight:e.weight},e.toneVariants=e.toneVariants?K(e.toneVariants):[],e}function Dt(a,e){const t=ae(a),n=e.preferenceKey??a.preferenceKey??a.id;t.id=e.id,t.name=`${a.name} · ${e.label}`,t.preferenceKey=n,t.basePersonaId=a.basePersonaId??a.id,t.weight=e.weight??a.weight??1,t.speechTics=K([...a.speechTics??[],...e.extraSpeechTics??[]]),t.toneVariants=K([...a.toneVariants??[],e.toneVariant]),t.disallowedPhrases=K([...a.disallowedPhrases,...e.disallowedPhrases??[]]);const s=e.traits?.length?`Lean into these quirks when it fits: ${e.traits.join(", ")}.`:void 0;return t.styleGuidelines=K([...a.styleGuidelines,...e.styleGuidelines??[],s]),t.virtualUser={id:e.id,label:e.label,description:e.description,traits:e.traits?[...e.traits]:[],toneVariant:e.toneVariant,preferenceKey:n,basePersonaId:t.basePersonaId,weight:t.weight},t}function Lt(a){const e=new Map;a.personas.forEach(s=>{const i=ae(s);i.basePersonaId=s.basePersonaId??s.id,i.preferenceKey=s.preferenceKey??s.id,i.weight=s.weight??1,e.set(s.id,i)});const t=Ct(a.id);if(t.length===0)return Array.from(e.values()).map(s=>Pt(s));const n=[];return t.forEach(s=>{const i=e.get(s.basePersonaId);if(!i){f.warn("[personas] Unknown base persona for virtual user",s);return}n.push(Dt(i,s))}),n}const _t=new Set(["the","and","you","for","but","that","with","this","have","what","your","from","they","there","will","were","just","about","like","into","when","them","then","than","over"]);function Bt(a){const e=a.match(/^([A-Z][A-Z\s]{1,20}):/);return e?e[1].split(" ").map(t=>t.trim()).filter(Boolean):[]}function $t(a){const e=a.replace(/[^a-zA-Z\s]/g," ").toLowerCase().split(/\s+/).filter(n=>n.length>3&&!_t.has(n)),t=new Map;return e.forEach(n=>{t.set(n,(t.get(n)??0)+1)}),Array.from(t.entries()).sort((n,s)=>s[1]-n[1]).slice(0,5).map(([n])=>n)}const Nt=[{tone:"tense",patterns:[/[!?]{2,}/,/\brun\b/,/\bnow\b/,/\bmove\b/,/\bgun\b/,/\bthreat/i],weight:1.2,intensity:"high"},{tone:"thrilling",patterns:[/\bchase\b/i,/\bescape\b/i,/explosion/i,/\bcliffhanger\b/i,/\brace\b/i,/\bstandoff\b/i],weight:1.3,intensity:"high"},{tone:"bittersweet",patterns:[/\bproud of you\b/i,/\bthank you\b/i,/\bmiss you\b/i,/\bfarewell\b/i,/\bso happy for you\b/i],weight:1.1,intensity:"medium"},{tone:"mystery",patterns:[/\bclue\b/i,/\binvestigate\b/i,/\bcase\b/i,/\bsuspect\b/i,/\bmystery\b/i,/\bsecret\b/i,/\bhidden\b/i],weight:1,intensity:"medium"},{tone:"humorous",patterns:[/(haha|lol|funny|joke|laugh|comedy)/i],weight:1,intensity:"medium"},{tone:"romantic",patterns:[/(love|kiss|sweet|adorable|romantic|date|flirt)/i],weight:.9,intensity:"medium"},{tone:"sad",patterns:[/(sorry|cry|sad|tears|hurt|heartbroken|funeral|mourning)/i],weight:1,intensity:"medium"},{tone:"confused",patterns:[/(what|why|how|huh|who|where)/i,/\?\s*$/],weight:.8,intensity:"medium"}],Vt={low:1,medium:2,high:3};function jt(a){return a>=2.5?"high":a>=1.7?"medium":"low"}function Ot(a,e){const t=a.toLowerCase(),n=new Map,s=new Map,i=(p,m,y)=>{n.set(p,(n.get(p)??0)+m);const w=Vt[y],d=s.get(p)??0;s.set(p,Math.max(d,w))};Nt.forEach(p=>{p.patterns.forEach(m=>{m.test(t)&&i(p.tone,p.weight,p.intensity)})});const r=a.match(/!/g)?.length??0,o=a.match(/\?/g)?.length??0;(r>=2||/do it now|hurry|we have to/i.test(t))&&i("tense",.9+r*.1,r>=3?"high":"medium"),e==="high"&&i("thrilling",.7,"high"),o>=2&&i("confused",.6+o*.05,"medium");const c=Array.from(n.values()).reduce((p,m)=>p+m,0);let l="calm",h=e==="high"?"medium":"low",u=.4;if(c>0){const[p,m]=Array.from(n.entries()).reduce((w,d)=>d[1]>w[1]?d:w,["calm",0]);l=p;const y=s.get(p)??(e==="high"?2:1);h=jt(y),u=Math.min(.95,Math.max(.35,m/(c||1)))}else(e==="medium"||e==="high")&&(l=e==="high"?"tense":"calm",h=e==="high"?"medium":"low",u=e==="high"?.55:.45);return l==="calm"&&e==="medium"&&o>0&&(l="confused",h="medium",u=Math.max(u,.5)),{tone:l,intensity:h,confidence:u}}function Ft(a){const e=Math.min(a.length/80,1),t=Math.min((a.match(/!/g)?.length??0)/3,1),n=Math.min((a.match(/\?/g)?.length??0)/3,1),s=e*.3+t*.4+n*.3;return s>.65?"high":s>.35?"medium":"low"}function Kt(a,e){const t=a.trim();return!(!t||/^(hmm+|uh+|mm+)$/.test(t.toLowerCase())||t.length<8&&e==="low")}function Ut(a){if(a.length===0)return{summary:"",keywords:[],speakers:[],tone:"calm",toneIntensity:"low",toneConfidence:.4,energy:"low",hasQuestion:!1,hasExclamation:!1,shouldRespond:!1};const e=a.map(o=>o.text).join(" "),t=Array.from(new Set(a.flatMap(o=>Bt(o.text)).filter(o=>o.length>1))),n=$t(e),s=Ft(e),i=Ot(e,s);return{summary:e.length>160?`${e.slice(0,157)}...`:e,keywords:n,speakers:t,tone:i.tone,toneIntensity:i.intensity,toneConfidence:i.confidence,energy:s,hasQuestion:/\?/.test(e),hasExclamation:/!/.test(e),shouldRespond:Kt(e,s)}}const Wt={low:25e3,medium:15e3,high:8e3},Be=3,me=5,zt=8e3,Ht=3,$e=5,Gt=12,qt=40,Yt=2,Xt=2,Ne=5,Ve=90,X=new Set(["the","and","you","for","but","that","with","this","have","what","your","from","they","there","will","were","just","about","like","into","when","them","then","than","over","really","gonna"]),Jt=[a=>`Density is ${a}; only speak up when you can add a fresh beat.`,a=>`We're pacing for ${a} chatter—skip the obvious takes.`,a=>`Keep reactions lean; the crowd setting is ${a}, so only jump in with something new.`],Qt=[a=>`Focus on these cues: ${a}.`,a=>`Anchor your take around ${a}; make the detail feel new.`,a=>`The scene is signaling ${a}—pick a facet we have not echoed.`],Zt=["No standout cue? Grab a sensory detail—lighting, posture, props, or pacing.","If keywords blur, spotlight body language, sound design, or background business.","When cues repeat, switch to micro-observations: textures, timing, or reactions off-screen."],en=["If nothing new comes to mind, answer with [skip].","No fresh angle? Respond with [skip] instead of forcing it.","Only speak when you have something distinct—otherwise reply with [skip]."],tn=[{pattern:/\bhowever\b/gi,replacement:"but"},{pattern:/\btherefore\b/gi,replacement:"so"},{pattern:/\bfurthermore\b/gi,replacement:"also"},{pattern:/\bmoreover\b/gi,replacement:"also"},{pattern:/\bthus\b/gi,replacement:"so"},{pattern:/\bindeed\b/gi,replacement:"honestly"},{pattern:/\bperhaps\b/gi,replacement:"maybe"},{pattern:/\breally\b/gi,replacement:"super"},{pattern:/\bvery\b/gi,replacement:"super"},{pattern:/\babsolutely\b/gi,replacement:"totally"}],nn=new Set(["really","very","just","like","actually","literally","basically","definitely","totally","maybe","probably","honestly","seriously","kinda","sorta","pretty","quite"]),J=4,Q=9e4,je=3e5,sn=.88,an=.4,rn=.5,on={calm:["The moment feels steady and grounded—spot a detail that keeps it human.","Atmosphere is relaxed and breathable—find a small but telling observation."],tense:["The air is tight with tension—surface something sharper than last time.","Everything is on edge—dig into what raises the stakes right now.","Tension is coiled—focus on a fresh signal (voice, posture, stakes)."],humorous:["Comedy energy is bubbling—lean into wit without repeating the punch line.","The beat stays playful—angle for a different joke or comparison."],sad:["The mood sinks heavy—pull a new emotional thread instead of rehashing.","Emotion is raw—anchor your take in a fresh, specific detail."],romantic:["The moment is soft and intimate—highlight a new spark or gesture.","Romance glows here—choose a different image than your last reaction."],confused:["The vibe feels uncertain—frame a question or hypothesis we have not heard.","Curiosity clouds the scene—probe a fresh clue instead of repeating doubts."],thrilling:["Adrenaline is surging—describe a vivid beat that shows the momentum.","This feels like a chase—pick a sensory detail that keeps it exciting."],bittersweet:["The mood is bittersweet—balance the lift and ache with new wording.","Tender but aching—spot a nuance that keeps it from sounding recycled."],mystery:["The beat is draped in mystery—surface a clue or hunch we have not voiced.","Suspicion hangs here—point to a fresh lead or unanswered question."]},cn={low:"Keep it nuanced; highlight a precise detail instead of the broad headline.",medium:"Find a new angle or implication so your take adds fresh value.",high:"Go vivid—use new imagery or stakes instead of repeating earlier adjectives."};class ln{#e=[];#s=new Map;#n=new Map;#t=[];#i=null;#a=new Map;#r=[];#d=new Map;#p=[];#f=[];#u=new Map;#S=new Map;#o=new Map;#m=[];#c=[];#l=[];#g={state:"paused",positionMs:0,contentId:null,updatedAt:0};#M=null;#w="";#C=!1;constructor(){const e=ne();this.#w=e.promptVersion,this.#A(),qe(t=>{this.#w=t.promptVersion,this.#A()})}#A(){this.#e=Ge(),this.#s=new Map,this.#n=new Map,this.#a=new Map,this.#u=new Map,this.#o=new Map,this.#S=new Map,this.#m=[],this.#c=[],this.#l=[],this.#e.forEach(t=>{const n=t.preferenceKey??t.basePersonaId??t.id;t.preferenceKey=n,t.basePersonaId=t.basePersonaId??n,t.weight=t.weight??1,t.virtualUser||(t.virtualUser={id:t.id,label:t.name,description:t.systemPrompt,traits:t.toneVariants??[],toneVariant:t.toneVariants?.[0],preferenceKey:n,basePersonaId:t.basePersonaId,weight:t.weight}),this.#s.set(t.id,t),this.#n.set(t.id,{lastEmittedAt:0}),this.#a.set(t.id,[]),this.#u.set(t.id,!1),this.#o.set(t.id,{topics:[],lastText:null,lastAt:0,history:[]})});const e=Math.max(1,me*this.#e.length);this.#r.length>e&&(this.#r=this.#r.slice(this.#r.length-e)),this.#y({resetCadence:!0})}updatePlaybackStatus(e){const t=this.#M;this.#g=e,e.contentId&&e.contentId!==this.#i&&(this.#i=e.contentId,this.#t=[],this.#y({resetCadence:!0}),this.#c=[],this.#l=[]),e.state!=="playing"&&this.#u.forEach((n,s)=>{this.#u.set(s,!1)}),typeof t=="number"&&e.positionMs<t-500&&(this.#t=[],this.#y({resetCadence:!0}),this.#c=[],this.#l=[]),e.state==="seeking"&&(this.#y({resetCadence:!0}),this.#c=[],this.#l=[]),this.#M=e.positionMs}async processCueBatch(e,t){if(this.#C=!!t.developerMode,!t.globalEnabled)return f.debug("[orchestrator] Global toggle disabled; ignoring cues."),{comments:[],metrics:this.#I()};const n=e[e.length-1];if(!n)return{comments:[],metrics:this.#I()};if(this.#g.state!=="playing"&&this.#g.updatedAt!==0)return f.debug("[orchestrator] Playback inactive; skipping generation.",{state:this.#g.state}),{comments:[],metrics:this.#I()};this.#K(e);const s=Ut(this.#t);this.#Q(s.keywords),this.#ee(s);const i=this.#x();if(!s.shouldRespond)return i.skippedByHeuristics+=1,this.#b([],i,t);const r=this.#U(n.startTime),o=r.total,c=r.perPersona,l=r.perBasePersona,h=Math.max(0,Ht-o);if(h<=0)return i.skippedByHeuristics+=1,this.#b([],i,t);const u=[],p=this.#H(s,n.startTime);for(const d of p){const E=d.preferenceKey??d.basePersonaId??d.id;if(!t.personaEnabled[E])continue;const $=d.basePersonaId??E,j=$,z=d.virtualUser?.toneVariant??d.toneVariants?.[0],H=d.weight??1;if((c.get(d.id)??0)>=1){i.skippedByHeuristics+=1;continue}if((l.get($)??0)>=1){i.skippedByHeuristics+=1;continue}if(this.#u.get(d.id)){i.skippedByLock+=1,f.debug("[orchestrator] Persona locked, skipping",{persona:d.id});continue}if(this.#F(d,n,t,s)){i.skippedByHeuristics+=1,f.debug("[orchestrator] Cue skipped by heuristics",{persona:d.id,cueId:n.cueId});continue}const v=Date.now(),G=this.#n.get(d.id),oe=d.cadenceSeconds*1e3,q=Wt[t.density],ce=Math.max(oe,q);if(G&&v-G.lastEmittedAt<ce){i.skippedByThrottle+=1,f.debug("[orchestrator] Persona throttled",{persona:d.id});continue}const g=this.#O(n.cueId,d.id),M=await V.get(g);if(M&&this.#J(M,s)){f.debug("[orchestrator] Cache candidate ready",{cacheKey:g});const R=Date.now(),I={...M,id:g,personaId:d.id,text:M.text,createdAt:R,renderAt:n.startTime+500,durationMs:this.#T(M.text)},P=this.#L({persona:d,text:I.text,scene:s,timestamp:R,metrics:i});if(!P.accepted)continue;u.push({persona:d,comment:I,source:"cache",cacheKey:g,keywords:s.keywords,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneEnergy:s.energy,basePersonaId:j,preferenceKey:E,toneVariant:z,weight:H,virtualUser:d.virtualUser,score:0,relevance:P.relevance,styleFit:P.styleFit,promptHash:M.promptHash,finalize:async N=>{this.#D(N,n.cueId,s.keywords),await V.set({...N,cacheKey:g,contentId:n.contentId,personaId:d.id,cueId:n.cueId,promptHash:M.promptHash,promptVersion:this.#w,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneToneConfidence:s.toneConfidence,sceneEnergy:s.energy})}}),i.candidateCount+=1,i.generationLatencyMsTotal+=Date.now()-v;continue}let O=null,F=!1;this.#u.set(d.id,!0);try{const{messages:R,telemetry:I}=this.#oe({persona:d,preferences:t,scene:s});i.dynamicBanTermsApplied+=I.dynamicBanCount,i.keywordEvaluations+=I.evaluatedKeywordCount,i.filteredKeywordDrops+=I.filteredKeywordCount,I.toneRepetitionWarning&&(i.toneRepetitionWarnings+=1),I.personaHotwordReminder&&(i.personaHotwordReminders+=1);const P=this.#V(d.temperature,.12,.4,1.1,`${d.id}:${n.cueId}:temp`),N=this.#V(d.topP,.08,.6,.99,`${d.id}:${n.cueId}:topP`),le=Date.now(),Y=await ie.complete({personaId:d.id,messages:R,maxTokens:Math.max(64,d.maxWords*2),temperature:P,topP:N}),he=Date.now()-le;i.llmCalls+=1,i.llmLatencyMsTotal+=he,F=!!Y.usingFallback;const D=this.#ke(Y.text,d);if(!D){i.sanitizedDrops+=1,f.warn("[orchestrator] Sanitized response empty, skipping",{persona:d.id});continue}const b=this.#X(D,d,s,n.cueId),C=Date.now(),de=this.#L({persona:d,text:b,scene:s,timestamp:C,metrics:i});if(!de.accepted)continue;const Ye=C,Xe={id:g,personaId:d.id,text:b,createdAt:Ye,renderAt:n.startTime+500,durationMs:this.#T(b)},Te=this.#Se(JSON.stringify(R));O={persona:d,comment:Xe,source:"llm",cacheKey:g,keywords:s.keywords,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneEnergy:s.energy,basePersonaId:j,preferenceKey:E,toneVariant:z,weight:H,virtualUser:d.virtualUser,usedFallback:F,promptHash:Te,score:0,relevance:de.relevance,styleFit:de.styleFit,finalize:async Me=>{this.#D(Me,n.cueId,s.keywords),await V.set({...Me,cacheKey:g,contentId:n.contentId,personaId:d.id,cueId:n.cueId,promptHash:Te,promptVersion:this.#w,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneToneConfidence:s.toneConfidence,sceneEnergy:s.energy})}}}finally{this.#u.set(d.id,!1)}O&&(u.push(O),i.candidateCount+=1,i.generationLatencyMsTotal+=Date.now()-v,F&&(i.fallbackResponses+=1))}if(u.length===0)return this.#b([],i,t);const m=this.#W(u,h,c,l,i,s,n.startTime);if(m.length===0)return this.#b([],i,t);const y=[];let w=0;for(const d of m){const E={...d.comment,renderAt:this.#Y(n.startTime,w,s,d.persona.id),durationMs:this.#T(d.comment.text)};await d.finalize(E),d.source==="cache"?i.cacheHits+=1:i.cacheMisses+=1,i.generatedCount+=1,y.push(E),w+=1}return this.#b(y,i,t)}#O(e,t){return`${e}::${t}`}#y({resetCadence:e=!1}={}){this.#a.forEach((t,n)=>{this.#a.set(n,[])}),this.#o.forEach((t,n)=>{this.#o.set(n,{topics:[],lastText:null,lastAt:0,history:[]})}),this.#u.forEach((t,n)=>{this.#u.set(n,!1)}),this.#S.clear(),this.#r=[],this.#f=[],this.#m=[],this.#d.clear(),this.#p=[],e&&this.#n.forEach((t,n)=>{this.#n.set(n,{...t,lastEmittedAt:0})}),this.#v("reset",{resetCadence:e,personaCount:this.#e.length,activeContentId:this.#i})}#v(e,t){this.#C&&f.debug("[orchestrator] memory:"+e,{...t,timestamp:Date.now()})}#x(){return{cacheHits:0,cacheMisses:0,llmCalls:0,llmLatencyMsTotal:0,generationLatencyMsTotal:0,generatedCount:0,candidateCount:0,skippedByThrottle:0,skippedByHeuristics:0,skippedByLock:0,duplicatesFiltered:0,sanitizedDrops:0,fallbackResponses:0,prunedByReranker:0,dynamicBanTermsApplied:0,keywordEvaluations:0,filteredKeywordDrops:0,toneRepetitionWarnings:0,personaHotwordReminders:0,duplicateHardRejects:0,semanticRejects:0,lowRelevanceDrops:0,styleFitDrops:0}}#R(e){return{timestamp:Date.now(),cacheHits:e.cacheHits,cacheMisses:e.cacheMisses,llmCalls:e.llmCalls,averageLLMLatencyMs:e.llmCalls>0?e.llmLatencyMsTotal/e.llmCalls:0,averageGenerationLatencyMs:e.candidateCount>0?e.generationLatencyMsTotal/e.candidateCount:0,skippedByThrottle:e.skippedByThrottle,skippedByHeuristics:e.skippedByHeuristics,skippedByLock:e.skippedByLock,duplicatesFiltered:e.duplicatesFiltered,sanitizedDrops:e.sanitizedDrops,fallbackResponses:e.fallbackResponses,candidatesGenerated:e.candidateCount,prunedByReranker:e.prunedByReranker,cacheSizeGlobalBytes:0,cacheSizeActiveBytes:0,activeContentId:this.#i,windowCommentTotal:this.#f.length,dynamicBanTermsApplied:e.dynamicBanTermsApplied,keywordEvaluations:e.keywordEvaluations,filteredKeywordDrops:e.filteredKeywordDrops,toneRepetitionWarnings:e.toneRepetitionWarnings,personaHotwordReminders:e.personaHotwordReminders,duplicateHardRejects:e.duplicateHardRejects,semanticRejects:e.semanticRejects,lowRelevanceDrops:e.lowRelevanceDrops,styleFitDrops:e.styleFitDrops}}#I(){return this.#R(this.#x())}async#b(e,t,n){const s=this.#R(t);if(n.developerMode){try{const i=await V.sizeReport();s.cacheSizeGlobalBytes=i.global,s.cacheSizeActiveBytes=this.#i?i.contents[this.#i]??0:0}catch(i){f.warn("[orchestrator] Failed to gather cache metrics",i)}f.debug("[orchestrator] Metrics snapshot",s)}return{comments:e,metrics:s}}#F(e,t,n,s){const i=t.text.trim();if(!i||!/[a-zA-Z]/.test(i)||this.#S.get(e.id)===t.cueId&&this.#g.state==="playing")return!0;const o=s.energy;if(n.density==="low"){if(!(/[!?]/.test(i)||i.length>=18||s.hasQuestion)||o==="low")return!0}else if(n.density==="medium"&&o==="low"&&i.length<10&&!/[!?]/.test(i))return!0;const c=this.#o.get(e.id);return!!(c&&Date.now()-c.lastAt<5e3&&s.keywords.filter(h=>c.topics.includes(h)).length>=Math.min(2,s.keywords.length))}#K(e){const t=e[e.length-1];if(t){this.#i!==t.contentId&&(this.#i=t.contentId,this.#t=[],this.#y({resetCadence:!0}));for(const n of e)this.#t.some(s=>s.cueId===n.cueId)||this.#t.push(n);this.#t.length>Be&&(this.#t=this.#t.slice(this.#t.length-Be))}}#P(e){this.#f=this.#f.filter(t=>e-t.timestamp<=zt)}#U(e){this.#P(e);const t=new Map,n=new Map;for(const s of this.#f){t.set(s.personaId,(t.get(s.personaId)??0)+1);const i=this.#s.get(s.personaId),r=i?.basePersonaId??i?.preferenceKey??s.personaId;r&&n.set(r,(n.get(r)??0)+1)}return{total:this.#f.length,perPersona:t,perBasePersona:n}}#D(e,t,n){this.#f.push({timestamp:e.renderAt,personaId:e.personaId}),this.#P(e.renderAt),this.#Ee(e.personaId,e.text,n),this.#S.set(e.personaId,t),this.#be(e.personaId),this.#v("register",{personaId:e.personaId,cueId:t,text:e.text,keywords:n})}#W(e,t,n,s,i,r,o){if(t<=0)return[];e.forEach(m=>{m.score=this.#z(m,r,o)});const c=[...e].sort((m,y)=>y.score-m.score),l=new Map(n),h=new Map(s),u=[];let p=0;for(const m of c){if(u.length>=t){p+=1;continue}const y=l.get(m.persona.id)??0;if(y>=1){p+=1;continue}const w=h.get(m.basePersonaId)??0;if(w>=1){p+=1;continue}u.push(m),l.set(m.persona.id,y+1),h.set(m.basePersonaId,w+1)}return i.prunedByReranker+=p,u}#L({persona:e,text:t,scene:n,timestamp:s,metrics:i}){const r=this.#he(t,s);if(r.hardDuplicate)return i.duplicatesFiltered+=1,i.duplicateHardRejects+=1,{accepted:!1,relevance:0,styleFit:0};if(r.semanticDuplicate)return i.duplicatesFiltered+=1,i.semanticRejects+=1,{accepted:!1,relevance:0,styleFit:0};const o=this.#de(t,n);if(o<an)return i.lowRelevanceDrops+=1,{accepted:!1,relevance:o,styleFit:0};const c=this.#ue(t,e);return c<rn?(i.styleFitDrops+=1,{accepted:!1,relevance:o,styleFit:c}):{accepted:!0,relevance:o,styleFit:c}}#z(e,t,n){const s=e.comment.text.split(/\s+/).filter(Boolean).length,i=Math.min(e.persona.maxWords,18),r=1-Math.min(Math.abs(s-i)/Math.max(1,i),1),o=this.#G(e.persona.id,e.keywords),c=this.#n.get(e.persona.id),l=e.persona.cadenceSeconds*1e3,h=c?Date.now()-c.lastEmittedAt:Number.MAX_SAFE_INTEGER,u=Math.min(h/Math.max(1,l),1),p=this.#_(e.persona,e.sceneEnergy),m=this.#q(e.toneVariant),y=this.#B(e.weight),w=e.source==="llm"?.05:0,d=this.#h(`${e.persona.id}:${n}:${e.comment.text}`),E=e.relevance,$=e.styleFit;return r*.18+o*.18+u*.14+p*.12+m*.12+E*.16+$*.1+y*.04+w+d*.06}#H(e,t){const n=this.#e.map(s=>{const i=this.#n.get(s.id),r=s.cadenceSeconds*1e3,o=i?Date.now()-i.lastEmittedAt:Number.MAX_SAFE_INTEGER,c=Math.min(o/Math.max(1,r),1),l=this.#_(s,e.energy),h=this.#h(`${t}:${s.id}`),u=this.#B(s.weight??1),p=c*.45+l*.25+u*.2+h*.1;return{persona:s,score:p}});return n.sort((s,i)=>i.score-s.score),n.map(s=>s.persona)}#_(e,t){const n=e.toneVariants??[],s=i=>n.includes(i);return t==="high"?s("snark")||s("hype")?1:s("precise")?.85:.7:t==="medium"?s("precise")||s("warm")?.9:.75:s("warm")||s("wistful")?1:s("precise")?.8:.6}#G(e,t){if(t.length===0)return .5;const n=this.#o.get(e);if(!n)return 1;const s=new Set(n.topics.map(r=>r.toLowerCase()));return t.map(r=>r.toLowerCase()).filter(r=>!s.has(r)).length/t.length}#q(e){if(!e)return .6;if(this.#m.length===0)return 1;const t=this.#m.lastIndexOf(e);if(t===-1)return 1;const n=this.#m.length-t;return .4+Math.min(n/4,1)*.6}#B(e){return Math.max(.3,Math.min(e,2))/2}#Y(e,t,n,s){const i=n.energy==="high"?350:n.energy==="medium"?550:800,r=Math.floor(this.#h(`${s}:${e}:${t}`)*400),o=t*260;return e+i+r+o}#T(e){const i=5200+(e.split(/\s+/).filter(Boolean).length-10)*220;return Math.max(4e3,Math.min(9e3,i))}#X(e,t,n,s){let i=e.replace(/\s+/g," ").trim();if(t.speechTics&&t.speechTics.length>0){const o=this.#h(`${t.id}:${s}:tic`);if(o>.68){const c=Math.floor(this.#h(`${s}:${t.id}:pick`)*t.speechTics.length),l=t.speechTics[c%t.speechTics.length]?.trim();l&&(i=o>.84?`${i}, ${l}`:`${l} ${i}`)}}if(!/[.!?…]$/.test(i)){const o=this.#h(`${t.id}:${s}:punct`);n.energy==="high"&&o>.35?i=`${i}!`:o>.7?i=`${i}...`:i=`${i}.`}this.#h(`${t.id}:${s}:trim`)>.85&&(i=i.replace(/[.]+$/,"")),i=this.#ce(i),i=i.replace(/\s+/g," ").trim();const r=i.split(/\s+/).filter(Boolean);if(r.length>t.maxWords){const o=this.#ye(r,t.maxWords);if(!o)return"";i=o.trim()}if(i.length>Ve){const o=this.#ge(i.split(/\s+/).filter(Boolean),Ve);if(!o)return"";i=o.trim()}return i}#J(e,t){return!(!e||!e.promptVersion||e.promptVersion!==this.#w||!e.sceneTone||e.sceneTone!==t.tone||e.sceneToneIntensity&&e.sceneToneIntensity!==t.toneIntensity||!e.sceneEnergy||e.sceneEnergy!==t.energy)}#h(e){let t=0;for(let s=0;s<e.length;s+=1)t=Math.imul(31,t)+e.charCodeAt(s);const n=Math.sin(t)*1e4;return n-Math.floor(n)}#Q(e){if(!(!e||e.length===0))for(e.forEach(t=>{const n=t.toLowerCase();!n||X.has(n)||this.#l.push(n)});this.#l.length>qt;)this.#l.shift()}#Z(){if(this.#l.length===0)return[];const e=new Map;return this.#l.forEach(t=>{e.set(t,(e.get(t)??0)+1)}),Array.from(e.entries()).filter(([,t])=>t>=Xt).sort((t,n)=>n[1]-t[1]).slice(0,Ne).map(([t])=>t)}#ee(e){for(this.#c.push(e.tone);this.#c.length>Gt;)this.#c.shift()}#te(e){let t=0;for(let n=this.#c.length-1;n>=0&&this.#c[n]===e;n-=1)t+=1;return t}#ne(e){if(!e)return[];const t=e.toLowerCase().match(/[a-z0-9']+/g);return t?t.filter(n=>n.length>3&&!X.has(n)):[]}#se(e){const t=this.#o.get(e);if(!t||t.history.length===0)return[];const n=new Map;return t.history.slice(-5).forEach(i=>{const r=this.#ne(i.text??"");r.forEach(o=>{n.set(o,(n.get(o)??0)+1)});for(let o=0;o<r.length-1;o+=1){const c=r[o],l=r[o+1];if(!c||!l)continue;const h=`${c} ${l}`;n.set(h,(n.get(h)??0)+1)}(i.keywords??[]).forEach(o=>{const c=o.toLowerCase();!c||c.length<=3||X.has(c)||n.set(c,(n.get(c)??0)+1)})}),Array.from(n.entries()).filter(([,i])=>i>=Yt).sort((i,r)=>r[1]-i[1]).slice(0,Ne).map(([i])=>i)}#ie(e,t){const n=this.#se(e),s=this.#Z(),i=new Set;n.forEach(o=>i.add(o)),s.forEach(o=>i.add(o));const r=t.filter(o=>{const c=o.toLowerCase();return!i.has(c)});if(r.length===0&&t.length>0){const o=t.find(c=>{const l=c.toLowerCase();return l&&!X.has(l)});o&&(r.push(o),i.delete(o.toLowerCase()))}return{filteredKeywords:r,personaHotWords:n,globalHotWords:s,dynamicBans:Array.from(i)}}#ae(e){const t=on[e.tone]??[`The scene leans ${e.tone}—call out a detail that keeps it fresh.`],n=this.#t.map(l=>l.cueId).join("|"),s=Math.floor(this.#h(`${e.tone}:${n}`)*t.length),i=t[s%t.length],r=cn[e.toneIntensity],o=e.toneConfidence<.5?"Tone signal feels tentative—anchor the take in concrete observations.":"",c=e.energy!=="medium"?` Energy: ${e.energy}.`:"";return`${i} Intensity: ${e.toneIntensity}. ${r}${o?` ${o}`:""}${c}`.trim()}#re(e){const t=this.#te(e.tone);return t<=1?null:t>=3?`We have stayed in this ${e.tone} pocket for ${t} beats—ban your previous adjectives and spotlight a different facet (sensory cues, stakes, body language).`:`This ${e.tone} vibe just repeated—pivot to a new angle or micro-detail instead of echoing earlier wording.`}#oe({persona:e,preferences:t,scene:n}){const s=Date.now(),i=Je(this.#t),r=this.#t.map(b=>b.cueId).join("|")||"no-cue",o=Qe(e.styleGuidelines),l=this.#E(`density:${t.density}:${r}`,Jt)(t.density),h=this.#ie(e.id,n.keywords),u=h.filteredKeywords,p=h.dynamicBans,m=`keywords:${r}:${u.join("|")}`,y=u.length?this.#E(m,Qt)(u.join(", ")):this.#E(`keywords:fallback:${r}`,Zt),w=new Set,d=[];e.disallowedPhrases.forEach(b=>{const C=b.toLowerCase();w.has(C)||(w.add(C),d.push(b))}),p.forEach(b=>{const C=b.toLowerCase();w.has(C)||(w.add(C),d.push(b))});const E=d.length?`Never reuse: ${d.join(", ")}. Reach for synonyms or a fresh detail.`:null,$=this.#ae(n),j=this.#re(n),z=n.speakers.length?`Speakers in focus: ${n.speakers.join(", ")}.`:"Speaker unknown—react as an engaged viewer.",H=this.#E(`skip:${e.id}:${r}`,en),v=this.#o.get(e.id),G=v?.lastText?`Previously you reacted with "${v.lastText}" about ${Math.max(1,Math.round((s-v.lastAt)/1e3))} seconds ago. Refer back only if it deepens your point.`:"You have not reacted recently in this scene.",oe=v?.topics?.length?`Topics you touched recently: ${v.topics.join(", ")}.`:"",q=v?.history?.length?v.history.slice(-$e).map(b=>`- ${Math.max(1,Math.round((s-b.at)/1e3))}s ago you said "${b.text}"`).join(`
`):"",ce=h.personaHotWords.length?`Words you've leaned on lately: ${h.personaHotWords.join(", ")}. Switch up your wording this time.`:"",g=e.virtualUser,M=g?`You are speaking as ${g.label}${g.description?` (${g.description})`:""}.`:`You are speaking as ${e.name}.`,O=g?.traits?.length?`Traits to convey: ${g.traits.join(", ")}.`:"",F=g?.toneVariant?`Maintain a ${g.toneVariant} vibe unless the scene demands a softer touch.`:"",R=e.speechTics?.length?`Expressions you sometimes use: ${e.speechTics.join(", ")}. Drop at most one when it fits naturally.`:"",I="You are part of a lively virtual crowd; only jump in when your perspective adds something human and fresh.",P=g?`Keep the voice consistent with ${g.label}.`:"",N=[e.systemPrompt,M,O,F,R,I,`Keep it under ${e.maxWords} words.`,"Speak like a human watcher, not a narrator. Use everyday spoken English with natural contractions and occasional slang only when it fits.","Avoid quoting the subtitles verbatim; focus on your reaction or insight.",l,$,j,z,y,E,H].filter(Boolean).join(" "),le=n.summary||i,Y=[G,oe,q?`Recent remarks:
${q}`:"",ce].filter(Boolean).join(`
`),he=[`Scene summary: ${le}`,`Subtitle window:
${i}`,`Guidelines:
${o}`,Y,P,"Instruction: Respond in one short spoken-style sentence. Keep it natural, as if chatting with friends."].filter(Boolean).join(`
`),D=[{role:"system",content:N}];return e.fewShotExamples.forEach(b=>{D.push({role:"user",content:b.user}),D.push({role:"assistant",content:b.assistant})}),D.push({role:"user",content:he}),{messages:D,telemetry:{dynamicBanCount:p.length,evaluatedKeywordCount:n.keywords.length,filteredKeywordCount:n.keywords.length-u.length,toneRepetitionWarning:!!j,personaHotwordReminder:h.personaHotWords.length>0}}}#ce(e){if(!e)return e;let t=e;return tn.forEach(({pattern:n,replacement:s})=>{t=t.replace(n,i=>this.#le(i,s))}),t}#le(e,t){return e?e===e.toUpperCase()?t.toUpperCase():e[0]===e[0].toUpperCase()?t.charAt(0).toUpperCase()+t.slice(1):t:t}#he(e,t){const n=e.toLowerCase(),s=this.#r.includes(n),i=this.#k(e);let r=!1;if(i.length>=J){const c=this.#$(i,J);for(const l of c){const h=this.#d.get(l);if(!(!h||h.length===0)){for(;h.length>0&&t-h[0]>Q;)h.shift();if(h.length===0){this.#d.delete(l);continue}if(t-h[h.length-1]<=Q){r=!0;break}}}}let o=!1;if(!r)for(const c of this.#p){if(t-c.timestamp>je)continue;if(this.#fe(i,c.tokens)>=sn){o=!0;break}}return{hardDuplicate:s||r,semanticDuplicate:o}}#de(e,t){const n=this.#k(e);if(n.length===0)return 0;const s=new Set(n);let i=0;t.keywords.length>0&&(i=t.keywords.filter(u=>s.has(u.toLowerCase())).length/t.keywords.length);let r=0;if(t.speakers.length>0){const h=e.toLowerCase();r=t.speakers.filter(p=>h.includes(p.toLowerCase())).length/t.speakers.length}const o=t.hasQuestion&&/\?/u.test(e)?1:0,c=t.hasExclamation&&/!/u.test(e)?1:0,l=i*.55+r*.2+o*.15+c*.1;return Math.max(0,Math.min(1,l))}#ue(e,t){const n=e.trim();if(!n)return 0;const i=this.#k(n).length;if(i===0||i>t.maxWords)return 0;const r=t.maxWords,o=1-Math.min(Math.abs(i-r)/Math.max(1,r),1),c=/[.!?…]$/u.test(n)?1:.4,l=/^[A-Z]/u.test(n)?1:.6,h=n.toLowerCase();if(t.disallowedPhrases.some(m=>h.includes(m.toLowerCase())))return 0;const p=o*.5+c*.3+l*.2;return Math.max(0,Math.min(1,p))}#k(e){const t=e.toLowerCase().match(/[a-z0-9']+/g);return t?t.filter(Boolean):[]}#$(e,t){const n=[];for(let s=0;s<=e.length-t;s+=1)n.push(e.slice(s,s+t).join(" "));return n}#pe(e,t){if(e.length<J){this.#N(t);return}const n=this.#$(e,J);for(const s of n){const i=this.#d.get(s)??[];for(i.push(t);i.length>0&&t-i[0]>Q;)i.shift();this.#d.set(s,i)}this.#N(t)}#N(e){for(const[t,n]of this.#d.entries()){for(;n.length>0&&e-n[0]>Q;)n.shift();n.length===0&&this.#d.delete(t)}}#me(e){for(;this.#p.length>0&&e-this.#p[0].timestamp>je;)this.#p.shift()}#fe(e,t){if(e.length===0||t.length===0)return 0;const n=new Set(e),s=new Set(t);let i=0;for(const o of n)s.has(o)&&(i+=1);const r=n.size+s.size-i;return r===0?0:i/r}#V(e,t,n,s,i){const r=(this.#h(i)-.5)*t,o=e+r;return Math.max(n,Math.min(s,o))}#ye(e,t){const n=[...e];for(;n.length>t&&this.#j(n););return n.length>t?"":n.join(" ")}#ge(e,t){const n=[...e];let s=n.join(" ");for(;s.length>t&&this.#j(n);)s=n.join(" ");return s.length>t?"":s}#j(e){for(let t=e.length-2;t>0;t-=1){const n=this.#we(e[t]);if(nn.has(n))return e.splice(t,1),!0}return e.length>2?(e.splice(e.length-2,1),!0):!1}#we(e){return e.replace(/[.,!?;:]+$/g,"").toLowerCase()}#E(e,t){if(t.length===0)throw new Error("[orchestrator] Attempted to pick from empty list");const n=Math.floor(this.#h(e)*t.length);return t[n%t.length]}#be(e){const t=this.#n.get(e)??{lastEmittedAt:0};t.lastEmittedAt=Date.now(),this.#n.set(e,t)}getActiveContentId(){return this.#i}resetAfterRegeneration(){this.#t=[],this.#y({resetCadence:!0}),this.#c=[],this.#l=[]}#Se(e){let t=0;for(let n=0;n<e.length;n+=1)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(36)}#ke(e,t){if(!e)return"";let n=e.trim();if(/^\[skip\]$/i.test(n))return"";const s=n.length;n=n.replace(/^"+|"+$/g,""),n=n.replace(/^[\[\(].*?[\]\)]\s*/g,""),n=n.replace(/\s+/g," ").trim();for(const i of t.disallowedPhrases){const r=new RegExp(i,"i");r.test(n)&&(n=n.replace(r,"").trim())}return n.length===0?"":(s!==n.length&&f.debug("[orchestrator] Sanitized LLM response",{persona:t.id,originalLength:s,sanitizedLength:n.length}),n)}#Ee(e,t,n){const s=t.toLowerCase(),i=this.#a.get(e)??[];for(i.push(s);i.length>me;)i.shift();for(this.#a.set(e,i),this.#r.push(s);this.#r.length>me*this.#e.length;)this.#r.shift();const r=Date.now(),o=this.#k(t);this.#pe(o,r),this.#p.push({timestamp:r,tokens:o}),this.#me(r);const c=this.#o.get(e)??{topics:[],history:[]},l=[...c.topics,...n].filter(Boolean).map(y=>y.toLowerCase()),h=Array.from(new Set(l)).slice(-5),u=[...c.history??[],{text:t,at:r,keywords:n}];for(;u.length>$e;)u.shift();this.#o.set(e,{topics:h,lastText:t,lastAt:r,history:u});const p=this.#s.get(e),m=p?.virtualUser?.toneVariant??p?.toneVariants?.[0];if(m)for(this.#m.push(m);this.#m.length>8;)this.#m.shift();this.#v("remember",{personaId:e,text:t,keywords:n,topics:h,historySize:u.length})}}const Z=new ln,x="netflix-ai-danmaku::feedback-log";class hn{async record(e){const t=e.createdAt??Date.now(),n={id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${t}-${Math.random().toString(36).slice(2,8)}`,category:e.category,note:e.note??null,createdAt:t},s=await chrome.storage.local.get(x),r=[...Array.isArray(s?.[x])?s[x]:[],n].slice(-200);return await chrome.storage.local.set({[x]:r}),n}async list(){const e=await chrome.storage.local.get(x);return Array.isArray(e?.[x])?e[x]:[]}async clear(){await chrome.storage.local.set({[x]:[]})}}const dn=new hn,un={alex:!0,jordan:!0,sam:!0,casey:!0},ve={globalEnabled:!0,density:"medium",personaEnabled:{...un},developerMode:!1,lastUpdated:Date.now()},ee="netflix-ai-danmaku::preferences";class pn{#e=null;#s=new Set;async get(){if(this.#e)return this.#e;const e=await chrome.storage.local.get(ee);return e?.[ee]?(this.#e=e[ee],this.#e):(this.#e=ve,await this.set(ve),this.#e)}async set(e){this.#e={...e,lastUpdated:Date.now()},await chrome.storage.local.set({[ee]:this.#e}),this.#n()}async update(e){const t=await this.get(),n={...t,...e,personaEnabled:{...t.personaEnabled,...e.personaEnabled},lastUpdated:Date.now()};await this.set(n)}subscribe(e){return this.#s.add(e),()=>this.#s.delete(e)}#n(){this.#e&&this.#s.forEach(e=>e(this.#e))}}const re=new pn;chrome.runtime.onInstalled.addListener(()=>{f.info("Netflix AI Danmaku extension installed.")});xt().catch(a=>{f.error("[background] Failed to initialize persona registry",a)});let B=null;const W=new Map;async function te(){return B||(B=await re.get()),B}re.subscribe(a=>{B=a,f.setLevel(a.developerMode?"debug":"info")});chrome.runtime.onMessage.addListener((a,e,t)=>((async()=>{switch(a.type){case"PING":{t({type:"PONG",timestamp:Date.now()});return}case"REQUEST_PREFERENCES":{const n=await te();t({type:"PREFERENCES_RESPONSE",preferences:n});return}case"UPDATE_PREFERENCES":{const n=await te(),s={...n,...a.preferences,personaEnabled:{...n.personaEnabled,...a.preferences.personaEnabled},lastUpdated:Date.now()};await re.set(s),await chrome.runtime.sendMessage({type:"PREFERENCES_RESPONSE",preferences:s}),t({type:"PREFERENCES_RESPONSE",preferences:s});return}case"CUES_BATCH":{if(!e.tab?.id){f.warn("[background] Received cues without tab context.");return}const n=await te(),{comments:s,metrics:i}=await Z.processCueBatch(a.cues,n);s.length>0&&await chrome.tabs.sendMessage(e.tab.id,{type:"COMMENTS_BATCH",comments:s}),n.developerMode&&await chrome.tabs.sendMessage(e.tab.id,{type:"METRICS_UPDATE",metrics:i}),e.tab?.id!==void 0&&await fn(e.tab.id,i),t({type:"RENDER_STATUS",status:"idle"});return}case"PLAYBACK_STATUS_UPDATE":{Z.updatePlaybackStatus(a.status),a.status.state==="seeking"&&a.status.contentId&&Number.isFinite(a.status.positionMs)&&a.status.positionMs>=0&&await V.purgeFuture(a.status.contentId,a.status.positionMs),t({type:"RENDER_STATUS",status:"idle"});return}case"REQUEST_LLM_STATUS":{const n=e.tab?.id,i=(n!==void 0?W.get(n):null)??ie.getLastStatus();n!==void 0&&W.set(n,i),t({type:"LLM_STATUS_UPDATE",status:i});return}case"REQUEST_PROMPT_VARIANTS":{const n=_e().map(i=>({id:i.id,label:i.label,promptVersion:i.promptVersion,description:i.description})),s=ne();t({type:"PROMPT_VARIANTS_RESPONSE",activeId:s.id,variants:n});return}case"SET_PROMPT_VARIANT":{if(typeof a.id=="string")try{await At(a.id)}catch(i){f.warn("[background] Failed to set prompt variant",i)}const n=_e().map(i=>({id:i.id,label:i.label,promptVersion:i.promptVersion,description:i.description})),s=ne();t({type:"PROMPT_VARIANTS_RESPONSE",activeId:s.id,variants:n});return}case"SUBMIT_USER_FEEDBACK":{try{const n=await dn.record({category:a.feedback.category,note:a.feedback.note??null});f.info("[background] Feedback captured",{category:n.category,note:n.note}),t({type:"USER_FEEDBACK_RECORDED",entryId:n.id})}catch(n){f.warn("[background] Failed to record feedback",n),t({type:"USER_FEEDBACK_RECORDED",entryId:""})}return}case"REGENERATE_FROM_TIMESTAMP":{if(!(await te()).globalEnabled){t({type:"RENDER_STATUS",status:"idle"});return}B?.lastUpdated;let s=Z.getActiveContentId();!s&&e.tab?.id!==void 0&&(s=await mn(e.tab.id)),s&&Number.isFinite(a.timestamp)&&a.timestamp>=0&&(await V.purgeFuture(s,a.timestamp),Z.resetAfterRegeneration()),t({type:"RENDER_STATUS",status:"idle"});return}default:f.warn("[background] Unknown message type",a)}})().catch(n=>{f.error("[background] Message handler error",n),t({type:"RENDER_STATUS",status:"error",detail:String(n)})}),!0));chrome.alarms.create("keepalive",{periodInMinutes:4});chrome.alarms.onAlarm.addListener(a=>{a.name==="keepalive"&&chrome.runtime.getPlatformInfo(()=>{f.debug("[background] keepalive ping")})});chrome.tabs.onRemoved.addListener(a=>{W.delete(a)});async function mn(a){try{const e=await chrome.tabs.sendMessage(a,{type:"REQUEST_ACTIVE_CONTENT_ID"});if(e&&e.type==="ACTIVE_CONTENT_ID_RESPONSE")return e.contentId}catch(e){f.warn("[background] Failed to obtain active content id",e)}return null}async function fn(a,e){const t=ie.getLastStatus(),n={level:t.level,detail:t.detail};if(n.level!=="error"&&e.fallbackResponses>0){const i=`使用占位响应 ${e.fallbackResponses} 条`;n.level="degraded",n.detail=n.detail?`${n.detail}; ${i}`:i}const s=W.get(a);if(!(s&&s.level===n.level&&s.detail===n.detail)){W.set(a,n);try{await chrome.tabs.sendMessage(a,{type:"LLM_STATUS_UPDATE",status:n})}catch(i){f.debug("[background] Failed to broadcast LLM status",i)}}}const yn="https://api.laozhang.ai/v1/chat/completions",gn="sk-D4qOhVgUNgCXDNdzC91cB185097d40749684F182B494914b";ie.configure({endpoint:yn,apiKey:gn});chrome.runtime.onConnect.addListener(a=>{if(a.name==="persona-stream"){const e=()=>{const n=ne(),s=Ge();a.postMessage({personas:s,variantId:n.id,promptVersion:n.promptVersion})},t=qe(()=>{try{e()}catch(n){f.warn("[background] Failed to push persona variant update",n)}});e(),a.onDisconnect.addListener(()=>{t()})}});(async()=>(B=await re.get()??ve,f.setLevel(B.developerMode?"debug":"info")))();
