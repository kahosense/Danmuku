import{s as g}from"./messages-BONoywxy.js";const q=200,X=5e3;function Y(){return window.netflix?.appContext?.state?.playerApp?.getAPI().videoPlayer}async function U(){const t=Date.now();return new Promise(e=>{const n=()=>{const i=Y(),s=i?.getAllPlayerSessionIds()[0];if(i&&s){const a=i.getVideoPlayerBySessionId(s);if(a){e(a);return}}if(Date.now()-t>=X){e(null);return}window.setTimeout(n,q)};n()})}const K=400,Q=3,R='.player-timedtext, [data-uia="player-timedtext"]';function J(){const t={player:null,teardownFns:[],batch:[],batchTimer:null,lastDomCueSignature:null};function e(a,o){!a.text.trim()||a.text.trim().length<Q||(t.batch.push(a),t.batchTimer===null&&(t.batchTimer=window.setTimeout(()=>{const c=[...t.batch];t.batch=[],t.batchTimer=null,c.length>0&&o(c)},K)))}function n(a){const o=c=>{if(!(c.text?.trim()??""))return;const h=D(t.player),r=_(c,h,"netflix-api");e(r,a)};!t.player||typeof t.player.on!="function"||(t.player.on("timedTextCueEntered",o),t.teardownFns.push(()=>{try{t.player?.off?.("timedTextCueEntered",o)}catch(c){console.warn("[content] Failed to detach Netflix cue handler",c)}}))}function i(a){let o=null;const c=new MutationObserver(()=>{const r=document.querySelector(R);!r||r===o||(o=r,l.disconnect(),l.observe(r,{childList:!0,subtree:!0}))}),l=new MutationObserver(()=>{const r=o??document.querySelector(R);if(!r)return;const m=ee(r);if(!m)return;const p=`${m}::${Math.floor(Date.now()/1e3)}`;if(t.lastDomCueSignature===p)return;t.lastDomCueSignature=p;const f=t.player?.getCurrentTime?.()??performance.now(),d={text:m,startTime:f,endTime:f+3e3},u=_(d,D(t.player),"dom-fallback");e(u,a)});c.observe(document.body,{childList:!0,subtree:!0});const h=document.querySelector(R);h&&(o=h,l.observe(h,{childList:!0,subtree:!0})),t.teardownFns.push(()=>{c.disconnect(),l.disconnect(),o=null})}async function s(a){return t.player=await U(),t.player?(console.info("[content] Netflix video player attached."),n(a)):console.warn("[content] Netflix video player not detected within timeout. Falling back to DOM observer."),i(a),()=>{t.batchTimer!==null&&(window.clearTimeout(t.batchTimer),t.batchTimer=null),t.teardownFns.forEach(o=>{try{o()}catch(c){console.warn("[content] Error during subtitle observer teardown",c)}}),t.teardownFns=[],t.player=null,t.lastDomCueSignature=null}}return{start:s}}function _(t,e,n){const i=Math.max(0,t.startTime??0),s=t.endTime??i,a=Math.max(0,s-i),o=t.id||`${Math.round(i)}-${Math.round(s)}-${Z(t.text)}`;return{contentId:e,text:t.text.trim(),startTime:i,endTime:s,duration:a,cueId:`${e}-${o}`,source:n}}function Z(t){let e=0;for(let n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e).toString(36)}function D(t){const e=t?.getVideoData?.(),n=e?.movieId??e?.title??"unknown";return String(n)}function ee(t){return Array.from(t.querySelectorAll("span")).map(n=>n.textContent?.trim()??"").filter(Boolean).join(" ").trim()}const te=200,ne=5e3;let E=null,$=null,I=0,F=0;function ie(t){return new Promise(e=>{window.setTimeout(e,t)})}async function oe(){for(let e=0;e<25;e+=1){const n=document.querySelector("video");if(n)return n;await ie(te)}return document.querySelector("video")}function se(t,e){const n=t?.getCurrentTime?.();return typeof n=="number"&&Number.isFinite(n)?Math.max(0,Math.round(n*1e3)):e?Math.max(0,Math.round(e.currentTime*1e3)):0}function y(t,e,n,{force:i}={force:!1}){const s=se(e,n),a=D(e),o={state:t,positionMs:s,contentId:a,updatedAt:Date.now()};!i&&$===t&&Math.abs(s-I)<750||($=t,I=s,F=s,g({type:"PLAYBACK_STATUS_UPDATE",status:o}).catch(c=>{console.warn("[content] Failed to send playback status",c)}))}function k(t,e){M(),E=window.setInterval(()=>{y("playing",t,e,{force:!0})},ne)}function M(){E!==null&&(window.clearInterval(E),E=null)}async function ae(){try{const[t,e]=await Promise.all([U(),oe()]);if(!e){console.warn("[content] No video element found for playback observer.");return}const n=e.paused?"paused":"playing";y(n,t,e,{force:!0}),n==="playing"&&k(t,e),e.addEventListener("playing",()=>{y("playing",t,e,{force:!0}),k(t,e)}),e.addEventListener("pause",()=>{y("paused",t,e,{force:!0}),M()}),e.addEventListener("seeking",()=>{y("seeking",t,e,{force:!0}),M()}),e.addEventListener("seeked",()=>{const i=e.paused?"paused":"playing";y(i,t,e,{force:!0}),i==="playing"&&k(t,e)}),window.addEventListener("beforeunload",()=>{M()})}catch(t){console.error("[content] Failed to initialize playback observer",t)}}function ce(){return F}function O(){const t=document.querySelector("video");return t?Math.max(0,Math.round(t.currentTime*1e3)):F}const re=":host{position:absolute;inset:0;pointer-events:none;z-index:2147483647;font-family:Inter,Helvetica Neue,Arial,sans-serif}.danmaku-container{position:absolute;inset:8% 2% auto;height:35%;display:flex;flex-direction:column;justify-content:space-between;gap:8px}.danmaku-lane{position:relative;flex:1;overflow:hidden}.danmaku-comment{position:absolute;top:0;white-space:normal;max-width:60%;padding:4px 12px;border-radius:999px;background:#1e293bbf;color:#f8fafc;font-size:15px;letter-spacing:.01em;transform:translate(100%);will-change:transform;transition:opacity .3s ease;opacity:.95;line-height:1.35}.danmaku-comment.persona-alex{background:#3b82f6cc}.danmaku-comment.persona-jordan{background:#22c55ecc}.danmaku-comment.persona-sam{background:#ec4899cc}.danmaku-comment.persona-casey{background:#f59e0bd9}@media (prefers-reduced-motion: reduce){.danmaku-comment{transition:transform .3s ease}}",le=4,T=6e3,B=32,H=350,C=90,de=190,he=150,ue=115,me=90,pe=200;class fe{constructor(e){this.host=e,this.#t=e.attachShadow({mode:"open"});const n=document.createElement("style");n.textContent=re,this.#t.appendChild(n);const i=document.createElement("div");i.className="danmaku-container",this.#t.appendChild(i);for(let s=0;s<le;s+=1){const a=document.createElement("div");a.className="danmaku-lane",i.appendChild(a),this.#e.push({element:a,busyUntil:0})}}#t;#e=[];#n=!0;#a=new Set;#o=0;#c=0;#i=new Map;#r=new Map;#s=new Map;setEnabled(e){this.#n=e,e||this.clear()}clear(){this.#s.forEach(e=>{window.clearTimeout(e)}),this.#s.clear(),this.#e.forEach(e=>{e.element.innerHTML="",e.busyUntil=0}),this.#a.clear()}renderBatch(e){if(!this.#n)return;this.#o=0,this.#c=0;const n=[...e].sort((i,s)=>i.renderAt-s.renderAt);for(const i of n){if(this.#a.has(i.id))continue;const s=this.#m(i),a=i.id;this.#r.set(a,s.length),this.#o+=s.length,i.text.trim().length>C&&(this.#c+=1),s.forEach(o=>{this.#a.has(o.id)||(this.#a.add(o.id),this.#d(o,a))})}this.#f()}#d(e,n){if(!this.#n)return;const i=O(),s=ce(),a=i>0?i:s,o=Math.max(0,e.renderAt-a);if(o>0){const c=this.#s.get(e.id);c!==void 0&&window.clearTimeout(c);const l=window.setTimeout(()=>{this.#s.delete(e.id),this.#n&&this.#l(e,n)},o);this.#s.set(e.id,l);return}this.#l(e,n)}#l(e,n){const i=this.#s.get(e.id);i!==void 0&&(window.clearTimeout(i),this.#s.delete(e.id));const s=n??this.#p(e.id),a=this.#h(s);if(a.waitMs>0){window.setTimeout(()=>{this.#n&&this.#l(e,s)},a.waitMs);return}const o=a.lane,c=Date.now(),l=Number.isFinite(e.durationMs)?Math.max(e.durationMs,T):T,h=c+l+H;o.busyUntil<h&&(o.busyUntil=h);const r=document.createElement("div");r.className=`danmaku-comment persona-${e.personaId}`,r.textContent=e.text,r.dataset.commentId=e.id,o.element.appendChild(r),requestAnimationFrame(()=>{const m=o.element.clientWidth||window.innerWidth,p=r.clientWidth,f=m+p+B,d=this.#u(f,e.text.length,e.durationMs),u=[{transform:`translateX(${m}px)`},{transform:`translateX(-${p+B}px)`}],v=r.animate(u,{duration:d,easing:"linear"}),W=Date.now()+d;o.busyUntil=Math.max(o.busyUntil,W+H);const V=o.busyUntil;v.finished.catch(()=>{}).finally(()=>{if(r.remove(),o.busyUntil===V&&(o.busyUntil=Date.now()),this.#a.delete(e.id),s){const N=(this.#r.get(s)??1)-1;N<=0?(this.#r.delete(s),this.#i.delete(s)):this.#r.set(s,N)}})})}#h(e){const n=Date.now();if(e){const a=this.#i.get(e);if(a)return{lane:a,waitMs:Math.max(0,a.busyUntil-n)}}let i=this.#e[0],s=Math.max(0,i.busyUntil-n);for(const a of this.#e){const o=Math.max(0,a.busyUntil-n);if(o===0){i=a,s=0;break}o<s&&(i=a,s=o)}return e&&this.#i.set(e,i),{lane:i,waitMs:s}}#u(e,n,i){let s=de;n>70?s=ue:n>45&&(s=he),s=Math.max(me,s);const a=e/s*1e3;return Math.max(a+pe,i,T)}#m(e){const n=e.text.trim();if(n.length<=C)return[{...e,text:n}];const i=n.slice(0,C-1).trimEnd();return[{...e,text:`${i}…`}]}#p(e){const n=e.indexOf("::");return n===-1?e:e.slice(0,n)}#f(){requestAnimationFrame(()=>{const e=this.#e.filter(n=>n.busyUntil>Date.now()).length;document.dispatchEvent(new CustomEvent("danmaku-metrics",{detail:{activeLanes:e,segmentsGenerated:this.#o,truncated:this.#c}}))})}}let S=null;function ve(){if(S)return S;let t=document.getElementById("danmaku-overlay-host");return t||(t=document.createElement("div"),t.id="danmaku-overlay-host",t.style.position="absolute",t.style.inset="0",t.style.pointerEvents="none",(document.querySelector(".watch-video--player-container")??document.querySelector(".watch-video--player-view")??document.body).appendChild(t)),S=new fe(t),S}const ge=".danmaku-control-panel{position:absolute;top:10%;right:2%;width:220px;padding:12px;border-radius:12px;background:#0f172aeb;color:#f1f5f9;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;font-size:14px;pointer-events:auto;z-index:2147483647;box-shadow:0 12px 24px #0f172a59}.danmaku-control-panel.panel-collapsed .panel-body{display:none}.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:600}.panel-collapse{appearance:none;border:none;background:transparent;color:#94a3b8;font-size:16px;cursor:pointer}.panel-body{display:flex;flex-direction:column;gap:10px}.panel-row{display:flex;justify-content:space-between;align-items:center}.switch-row input[type=checkbox]{width:36px;height:18px}.panel-row select{background:#1e293bf2;color:#f8fafc;border:1px solid rgba(148,163,184,.3);border-radius:6px;padding:4px}.persona-group{flex-direction:column;gap:6px;align-items:flex-start}.persona-toggle{display:flex;justify-content:space-between;width:100%;gap:8px}.panel-button{appearance:none;border:none;border-radius:8px;padding:8px 12px;background:#2563eb;color:#f8fafc;cursor:pointer;font-weight:500}.panel-button:hover{background:#1d4ed8}.panel-status{font-size:12px;color:#cbd5f5;min-height:16px}.panel-disabled{opacity:.6}.panel-status-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#cbd5f5;margin-top:6px}.panel-status-badge{padding:2px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;background:#3b82f626;color:#bfdbfe}.panel-status-badge.status-ok{background:#22c55e33;color:#4ade80}.panel-status-badge.status-degraded{background:#eab30833;color:#facc15}.panel-status-badge.status-error{background:#ef444433;color:#f87171}.danmaku-dev-hud{position:fixed;bottom:24px;right:24px;background:#0f172ae6;color:#f8fafc;padding:12px;border-radius:10px;font-size:12px;line-height:1.4;pointer-events:none;z-index:2147483647}";class ye{#t;#e;#n;#a=new Map;#o;#c;#i;#r=!1;constructor({getPreferences:e}){this.#t=document.createElement("div"),this.#t.className="danmaku-control-panel";const n=document.createElement("style");n.textContent=ge,this.#t.appendChild(n);const i=document.createElement("div");i.className="panel-header";const s=document.createElement("span");s.textContent="AI Danmaku",i.appendChild(s);const a=document.createElement("button");a.type="button",a.className="panel-collapse",a.textContent="≡",a.addEventListener("click",()=>this.#s()),i.appendChild(a),this.#t.appendChild(i);const o=document.createElement("div");o.className="panel-body",this.#t.appendChild(o);const c=document.createElement("label");c.className="panel-row switch-row",c.textContent="启用弹幕",this.#e=document.createElement("input"),this.#e.type="checkbox",this.#e.addEventListener("change",()=>{g({type:"UPDATE_PREFERENCES",preferences:{globalEnabled:this.#e.checked}})}),c.appendChild(this.#e),o.appendChild(c);const l=document.createElement("label");l.className="panel-row",l.textContent="弹幕密度",this.#n=document.createElement("select"),["low","medium","high"].forEach(d=>{const u=document.createElement("option");u.value=d,u.textContent=d==="low"?"低":d==="medium"?"中":"高",this.#n.appendChild(u)}),this.#n.addEventListener("change",()=>{g({type:"UPDATE_PREFERENCES",preferences:{density:this.#n.value}})}),l.appendChild(this.#n),o.appendChild(l);const h=document.createElement("div");h.className="panel-row persona-group",h.innerHTML="<strong>虚拟观众</strong>",o.appendChild(h),[{id:"alex",label:"Alex"},{id:"jordan",label:"Jordan"},{id:"sam",label:"Sam"},{id:"casey",label:"Casey"}].forEach(d=>{const u=document.createElement("label");u.className="persona-toggle",u.textContent=d.label;const v=document.createElement("input");v.type="checkbox",v.addEventListener("change",()=>{g({type:"UPDATE_PREFERENCES",preferences:{personaEnabled:{[d.id]:v.checked}}})}),u.appendChild(v),h.appendChild(u),this.#a.set(d.id,v)}),this.#o=document.createElement("button"),this.#o.type="button",this.#o.className="panel-button",this.#o.textContent="重新生成",this.#o.addEventListener("click",()=>{const d=O();g({type:"REGENERATE_FROM_TIMESTAMP",timestamp:d}),this.setStatus("重新生成请求已发送"),window.setTimeout(()=>this.setStatus(""),2e3)}),o.appendChild(this.#o),this.#c=document.createElement("span"),this.#c.className="panel-status",o.appendChild(this.#c);const m=document.createElement("div");m.className="panel-status-row";const p=document.createElement("span");p.textContent="LLM 状态",m.appendChild(p),this.#i=document.createElement("span"),this.#i.className="panel-status-badge status-ok",this.#i.textContent="正常",m.appendChild(this.#i),o.appendChild(m),document.body.appendChild(this.#t);const f=e();f&&this.update(f)}update(e){this.#e.checked=e.globalEnabled,this.#n.value=e.density;for(const[n,i]of this.#a.entries())i.checked=!!e.personaEnabled[n];this.#t.classList.toggle("panel-disabled",!e.globalEnabled)}setStatus(e){this.#c.textContent=e}setLLMStatus(e){const n={ok:"正常",degraded:"降级",error:"错误"},i=e.level;this.#i.textContent=n[i]??i,this.#i.className=`panel-status-badge status-${i}`,this.#i.title=e.detail??""}#s(){this.#r=!this.#r,this.#t.classList.toggle("panel-collapsed",this.#r)}}let L=null;function be(t){return L||(L=new ye(t)),L}const we=["calm","active","peak","cooldown"];class Se{#t;#e={cues:0,comments:0,cacheHitRate:0,avgLLMLatencyMs:0,avgGenerationLatencyMs:0,cacheSizeActiveMb:0,cacheSizeGlobalMb:0,fallbackResponses:0,llmCalls:0,windowCommentTotal:0,activeLanes:0,segmentsGenerated:0,truncatedComments:0,avgCommentLength:0,dynamicBans:0,toneWarnings:0,hotwordReminders:0,keywordFilterRate:0,duplicateHardRejects:0,semanticRejects:0,lowRelevanceDrops:0,styleFitDrops:0,stateGatedSkips:0,stateSoftSkips:0,stateForcedEmissions:0,energyState:"calm",stateOccupancy:{},lengthMean:0,lengthStdDev:0,lengthRollingMean:0,lengthRollingStdDev:0,lengthDeviation:0,lengthSamples:0,dynamicBanReleases:0,speechTicBans:0,speechTicViolations:0,toneAlignmentHits:0,toneAlignmentMisses:0,fewShotSelections:0,fewShotCooldownSkips:0};constructor(){this.#t=document.createElement("div"),this.#t.className="danmaku-dev-hud",this.#t.innerHTML=this.#n(),document.body.appendChild(this.#t)}update(e){e.cues!==void 0&&(this.#e.cues+=e.cues),e.comments!==void 0&&(this.#e.comments+=e.comments),e.cacheHitRate!==void 0&&(this.#e.cacheHitRate=e.cacheHitRate),e.avgLLMLatencyMs!==void 0&&(this.#e.avgLLMLatencyMs=e.avgLLMLatencyMs),e.avgGenerationLatencyMs!==void 0&&(this.#e.avgGenerationLatencyMs=e.avgGenerationLatencyMs),e.cacheSizeActiveMb!==void 0&&(this.#e.cacheSizeActiveMb=e.cacheSizeActiveMb),e.cacheSizeGlobalMb!==void 0&&(this.#e.cacheSizeGlobalMb=e.cacheSizeGlobalMb),e.fallbackResponses!==void 0&&(this.#e.fallbackResponses=e.fallbackResponses),e.llmCalls!==void 0&&(this.#e.llmCalls=e.llmCalls),e.windowCommentTotal!==void 0&&(this.#e.windowCommentTotal=e.windowCommentTotal),e.activeLanes!==void 0&&(this.#e.activeLanes=e.activeLanes),e.segmentsGenerated!==void 0&&(this.#e.segmentsGenerated=e.segmentsGenerated),e.truncatedComments!==void 0&&(this.#e.truncatedComments=e.truncatedComments),e.avgCommentLength!==void 0&&(this.#e.avgCommentLength=e.avgCommentLength),e.dynamicBans!==void 0&&(this.#e.dynamicBans=e.dynamicBans),e.toneWarnings!==void 0&&(this.#e.toneWarnings=e.toneWarnings),e.hotwordReminders!==void 0&&(this.#e.hotwordReminders=e.hotwordReminders),e.keywordFilterRate!==void 0&&(this.#e.keywordFilterRate=e.keywordFilterRate),e.duplicateHardRejects!==void 0&&(this.#e.duplicateHardRejects=e.duplicateHardRejects),e.semanticRejects!==void 0&&(this.#e.semanticRejects=e.semanticRejects),e.lowRelevanceDrops!==void 0&&(this.#e.lowRelevanceDrops=e.lowRelevanceDrops),e.styleFitDrops!==void 0&&(this.#e.styleFitDrops=e.styleFitDrops),e.stateGatedSkips!==void 0&&(this.#e.stateGatedSkips=e.stateGatedSkips),e.stateSoftSkips!==void 0&&(this.#e.stateSoftSkips=e.stateSoftSkips),e.stateForcedEmissions!==void 0&&(this.#e.stateForcedEmissions=e.stateForcedEmissions),e.energyState!==void 0&&(this.#e.energyState=e.energyState),e.stateOccupancy!==void 0&&(this.#e.stateOccupancy={...e.stateOccupancy}),e.lengthMean!==void 0&&(this.#e.lengthMean=e.lengthMean),e.lengthStdDev!==void 0&&(this.#e.lengthStdDev=e.lengthStdDev),e.lengthRollingMean!==void 0&&(this.#e.lengthRollingMean=e.lengthRollingMean),e.lengthRollingStdDev!==void 0&&(this.#e.lengthRollingStdDev=e.lengthRollingStdDev),e.lengthDeviation!==void 0&&(this.#e.lengthDeviation=e.lengthDeviation),e.lengthSamples!==void 0&&(this.#e.lengthSamples=e.lengthSamples),e.dynamicBanReleases!==void 0&&(this.#e.dynamicBanReleases=e.dynamicBanReleases),e.speechTicBans!==void 0&&(this.#e.speechTicBans=e.speechTicBans),e.speechTicViolations!==void 0&&(this.#e.speechTicViolations=e.speechTicViolations),e.toneAlignmentHits!==void 0&&(this.#e.toneAlignmentHits=e.toneAlignmentHits),e.toneAlignmentMisses!==void 0&&(this.#e.toneAlignmentMisses=e.toneAlignmentMisses),e.fewShotSelections!==void 0&&(this.#e.fewShotSelections=e.fewShotSelections),e.fewShotCooldownSkips!==void 0&&(this.#e.fewShotCooldownSkips=e.fewShotCooldownSkips),this.#t.innerHTML=this.#n()}destroy(){this.#t.remove()}#n(){const e=(this.#e.cacheHitRate*100).toFixed(1),n=this.#e.avgLLMLatencyMs.toFixed(0),i=this.#e.avgGenerationLatencyMs.toFixed(0),s=this.#e.cacheSizeActiveMb.toFixed(2),a=this.#e.cacheSizeGlobalMb.toFixed(2),o=this.#e.avgCommentLength.toFixed(1),c=(this.#e.keywordFilterRate*100).toFixed(1),l=we.map(u=>{const v=(this.#e.stateOccupancy?.[u]??0)*100;return`${u}:${v.toFixed(0)}%`}).join(" "),h=this.#e.lengthMean.toFixed(1),r=this.#e.lengthStdDev.toFixed(1),m=this.#e.lengthRollingMean.toFixed(1),p=this.#e.lengthRollingStdDev.toFixed(1),f=this.#e.lengthDeviation.toFixed(1),d=this.#e.toneAlignmentHits+this.#e.toneAlignmentMisses>0?(this.#e.toneAlignmentHits/(this.#e.toneAlignmentHits+this.#e.toneAlignmentMisses)*100).toFixed(0):"—";return`
      <div><strong>Dev HUD</strong></div>
      <div>字幕批次: ${this.#e.cues}</div>
      <div>弹幕输出: ${this.#e.comments}</div>
      <div>缓存命中率: ${e}%</div>
      <div>LLM延迟: ${n}ms</div>
      <div>生成耗时: ${i}ms</div>
      <div>缓存占用: ${s} / ${a} MB</div>
      <div>Fallback: ${this.#e.fallbackResponses}</div>
      <div>LLM调用: ${this.#e.llmCalls}</div>
      <div>窗口总弹幕: ${this.#e.windowCommentTotal}</div>
      <div>活跃车道: ${this.#e.activeLanes}</div>
      <div>分段数: ${this.#e.segmentsGenerated} 截断: ${this.#e.truncatedComments}</div>
      <div>平均长度: ${o}</div>
      <div>禁词触发: ${this.#e.dynamicBans}</div>
      <div>Tone 警示: ${this.#e.toneWarnings}</div>
      <div>热词提醒: ${this.#e.hotwordReminders}</div>
      <div>关键词过滤率: ${c}%</div>
      <div>硬去重拒绝: ${this.#e.duplicateHardRejects}</div>
      <div>语义拒绝: ${this.#e.semanticRejects}</div>
      <div>低关联拒绝: ${this.#e.lowRelevanceDrops}</div>
      <div>风格拒绝: ${this.#e.styleFitDrops}</div>
      <div>状态: ${this.#e.energyState} | 强制发声: ${this.#e.stateForcedEmissions} | 状态拦截: ${this.#e.stateGatedSkips} | 偏好跳过: ${this.#e.stateSoftSkips}</div>
      <div>状态占比: ${l}</div>
      <div>长度(窗口): μ ${h} σ ${r} Δ ${f} n=${this.#e.lengthSamples}</div>
      <div>长度(滚动): μ ${m} σ ${p}</div>
      <div>禁词释放: ${this.#e.dynamicBanReleases} | 口头禅封禁: ${this.#e.speechTicBans} | 违规: ${this.#e.speechTicViolations}</div>
      <div>Tone 对齐: ${d}% (命中:${this.#e.toneAlignmentHits} 丢失:${this.#e.toneAlignmentMisses})</div>
      <div>Few-shot: 取样 ${this.#e.fewShotSelections} | 冷却跳过 ${this.#e.fewShotCooldownSkips}</div>
    `}}let b=null;function Ee(t){t&&!b&&(b=new Se),!t&&b&&(b.destroy(),b=null)}function x(t){b?.update(t)}const G="danmaku-extension-marker";let A=null,w=null;const z=ve(),P=be({getPreferences:()=>w});function Me(){if(document.getElementById(G))return!1;const t=document.createElement("div");return t.id=G,t.style.display="none",document.documentElement.appendChild(t),!0}function j(t){w=t,z.setEnabled(t.globalEnabled),P.update(t),Ee(t.developerMode)}async function xe(t){if(t.length===0)return;A=t[t.length-1]?.contentId??A,x({cues:t.length});const e=await g({type:"CUES_BATCH",cues:t});e?.type==="RENDER_STATUS"&&e.status==="error"&&console.error("[content] Render status error",e.detail)}function Re(){if(!Me()){console.info("[content] Netflix AI Danmaku already initialized; skipping re-attach.");return}console.info("[content] Netflix AI Danmaku content script booting."),g({type:"PING"}),g({type:"REQUEST_PREFERENCES"}).then(n=>{n?.type==="PREFERENCES_RESPONSE"&&j(n.preferences)}),g({type:"REQUEST_LLM_STATUS"}).then(n=>{n?.type==="LLM_STATUS_UPDATE"&&P.setLLMStatus(n.status)}),J().start(n=>{xe(n).catch(i=>{console.error("[content] Failed to send cue batch",i)})}).then(n=>{window.addEventListener("beforeunload",n,{once:!0})}).catch(n=>{console.error("[content] Failed to start subtitle observer",n)}),ae().catch(n=>{console.error("[content] Failed to start playback observer",n)})}chrome.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="COMMENTS_BATCH"){z.renderBatch(t.comments);const i=t.comments.reduce((a,o)=>a+o.text.length,0),s=t.comments.length>0?i/t.comments.length:0;x({comments:t.comments.length,avgCommentLength:s});return}if(t.type==="PREFERENCES_RESPONSE"){j(t.preferences);return}if(t.type==="METRICS_UPDATE"){const i=t.metrics.cacheHits+t.metrics.cacheMisses,s=i>0?t.metrics.cacheHits/i:0,a=t.metrics.dynamicBanTermsApplied??0,o=t.metrics.keywordEvaluations??0,c=t.metrics.filteredKeywordDrops??0,l=o>0?c/o:0;x({cacheHitRate:s,avgLLMLatencyMs:t.metrics.averageLLMLatencyMs,avgGenerationLatencyMs:t.metrics.averageGenerationLatencyMs,cacheSizeActiveMb:t.metrics.cacheSizeActiveBytes/(1024*1024),cacheSizeGlobalMb:t.metrics.cacheSizeGlobalBytes/(1024*1024),fallbackResponses:t.metrics.fallbackResponses,llmCalls:t.metrics.llmCalls,windowCommentTotal:t.metrics.windowCommentTotal??0,dynamicBans:a,toneWarnings:t.metrics.toneRepetitionWarnings??0,hotwordReminders:t.metrics.personaHotwordReminders??0,keywordFilterRate:l,duplicateHardRejects:t.metrics.duplicateHardRejects??0,semanticRejects:t.metrics.semanticRejects??0,lowRelevanceDrops:t.metrics.lowRelevanceDrops??0,styleFitDrops:t.metrics.styleFitDrops??0,stateGatedSkips:t.metrics.skippedByState??0,stateSoftSkips:t.metrics.stateSoftSkips??0,stateForcedEmissions:t.metrics.stateForcedEmissions??0,energyState:t.metrics.energyState??"calm",...t.metrics.stateOccupancy?{stateOccupancy:t.metrics.stateOccupancy}:{},lengthMean:t.metrics.lengthMean??0,lengthStdDev:t.metrics.lengthStdDev??0,lengthRollingMean:t.metrics.lengthRollingMean??0,lengthRollingStdDev:t.metrics.lengthRollingStdDev??0,lengthDeviation:t.metrics.lengthDeviation??0,lengthSamples:t.metrics.lengthSampleSize??0,dynamicBanReleases:t.metrics.dynamicBanReleases??0,speechTicBans:t.metrics.speechTicBans??0,speechTicViolations:t.metrics.speechTicViolations??0,toneAlignmentHits:t.metrics.toneAlignmentHits??0,toneAlignmentMisses:t.metrics.toneAlignmentMisses??0,fewShotSelections:t.metrics.fewShotSelections??0,fewShotCooldownSkips:t.metrics.fewShotCooldownSkips??0}),w?.developerMode&&(console.debug("[content] Metrics update",t.metrics),t.metrics.fallbackResponses>0&&console.warn("[content] LLM fallback responses",t.metrics.fallbackResponses));return}if(t.type==="LLM_STATUS_UPDATE"){P.setLLMStatus(t.status),w?.developerMode&&console.debug("[content] LLM status update",t.status);return}if(t.type==="REQUEST_ACTIVE_CONTENT_ID")return n({type:"ACTIVE_CONTENT_ID_RESPONSE",contentId:A}),!0});document.addEventListener("danmaku-metrics",t=>{if(!w?.developerMode)return;const e=t.detail;e&&x({activeLanes:e.activeLanes,segmentsGenerated:e.segmentsGenerated,truncatedComments:e.truncated})});Re();
