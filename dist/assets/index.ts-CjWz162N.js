const W=(s,e)=>e.some(t=>s instanceof t);let J,Q;function le(){return J||(J=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function de(){return Q||(Q=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const G=new WeakMap,$=new WeakMap,B=new WeakMap;function ue(s){const e=new Promise((t,n)=>{const a=()=>{s.removeEventListener("success",r),s.removeEventListener("error",i)},r=()=>{t(E(s.result)),a()},i=()=>{n(s.error),a()};s.addEventListener("success",r),s.addEventListener("error",i)});return B.set(e,s),e}function he(s){if(G.has(s))return;const e=new Promise((t,n)=>{const a=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",i),s.removeEventListener("abort",i)},r=()=>{t(),a()},i=()=>{n(s.error||new DOMException("AbortError","AbortError")),a()};s.addEventListener("complete",r),s.addEventListener("error",i),s.addEventListener("abort",i)});G.set(s,e)}let K={get(s,e,t){if(s instanceof IDBTransaction){if(e==="done")return G.get(s);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return E(s[e])},set(s,e,t){return s[e]=t,!0},has(s,e){return s instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in s}};function se(s){K=s(K)}function me(s){return de().includes(s)?function(...e){return s.apply(H(this),e),E(this.request)}:function(...e){return E(s.apply(H(this),e))}}function pe(s){return typeof s=="function"?me(s):(s instanceof IDBTransaction&&he(s),W(s,le())?new Proxy(s,K):s)}function E(s){if(s instanceof IDBRequest)return ue(s);if($.has(s))return $.get(s);const e=pe(s);return e!==s&&($.set(s,e),B.set(e,s)),e}const H=s=>B.get(s);function V(s,e,{blocked:t,upgrade:n,blocking:a,terminated:r}={}){const i=indexedDB.open(s,e),c=E(i);return n&&i.addEventListener("upgradeneeded",o=>{n(E(i.result),o.oldVersion,o.newVersion,E(i.transaction),o)}),t&&i.addEventListener("blocked",o=>t(o.oldVersion,o.newVersion,o)),c.then(o=>{r&&o.addEventListener("close",()=>r()),a&&o.addEventListener("versionchange",l=>a(l.oldVersion,l.newVersion,l))}).catch(()=>{}),c}const fe=["get","getKey","getAll","getAllKeys","count"],ge=["put","add","delete","clear"],F=new Map;function X(s,e){if(!(s instanceof IDBDatabase&&!(e in s)&&typeof e=="string"))return;if(F.get(e))return F.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,a=ge.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(a||fe.includes(t)))return;const r=async function(i,...c){const o=this.transaction(i,a?"readwrite":"readonly");let l=o.store;return n&&(l=l.index(c.shift())),(await Promise.all([l[t](...c),a&&o.done]))[0]};return F.set(e,r),r}se(s=>({...s,get:(e,t,n)=>X(e,t)||s.get(e,t,n),has:(e,t)=>!!X(e,t)||s.has(e,t)}));const ye=["continue","continuePrimaryKey","advance"],Z={},q=new WeakMap,ae=new WeakMap,we={get(s,e){if(!ye.includes(e))return s[e];let t=Z[e];return t||(t=Z[e]=function(...n){q.set(this,ae.get(this)[e](...n))}),t}};async function*be(...s){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...s)),!e)return;e=e;const t=new Proxy(e,we);for(ae.set(t,e),B.set(t,H(e));e;)yield t,e=await(q.get(t)||e.continue()),q.delete(t)}function ee(s,e){return e===Symbol.asyncIterator&&W(s,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&W(s,[IDBIndex,IDBObjectStore])}se(s=>({...s,get(e,t,n){return ee(e,t)?be:s.get(e,t,n)},has(e,t){return ee(e,t)||s.has(e,t)}}));const Se="netflix-ai-danmaku-cache",Ee=1,f="comments",p="content",ke=5*1024*1024,Ie=20*1024*1024,w=s=>typeof structuredClone=="function"?structuredClone(s):JSON.parse(JSON.stringify(s));function re(){const s=new Map,e=n=>(s.has(n)||s.set(n,{comments:new Map,contents:new Map}),s.get(n)),t=(n,a,r)=>{if(a>=n.length)return null;const i=n[a];return{value:w(i),async delete(){r.delete(i.cacheKey)},async continue(){return t(n,a+1,r)}}};return async(n,a,r)=>{const i=e(n);return r?.upgrade&&r.upgrade({objectStoreNames:{contains:c=>c===f||c===p},createObjectStore:()=>({createIndex:()=>{}})},0,a??null,{},{}),{transaction(){return{objectStore(c){if(c===f)return{async get(o){const l=i.comments.get(o);return l?w(l):void 0},async put(o){i.comments.set(o.cacheKey,w(o))},async clear(){i.comments.clear()},async delete(o){i.comments.delete(o)},async getAll(){return Array.from(i.comments.values()).map(o=>w(o))},index(o){if(o!=="contentId")throw new Error(`Unsupported index ${o}`);return{async openCursor(l){const u=Array.from(i.comments.values()).filter(m=>m.contentId===l);return t(u.map(m=>w(m)),0,i.comments)}}}};if(c===p)return{async get(o){const l=i.contents.get(o);return l?w(l):void 0},async put(o){i.contents.set(o.contentId,w(o))},async delete(o){i.contents.delete(o)},async clear(){i.contents.clear()},async getAll(){return Array.from(i.contents.values()).map(o=>w(o))}};throw new Error(`Unknown store ${c}`)},done:Promise.resolve()}}}}}class Me{#e;#t;#n;#s;constructor(e={},t=V){this.#t=e.maxContentBytes??ke,this.#n=e.maxGlobalBytes??Ie,this.#s=t===V&&typeof indexedDB>"u"?re():t;const n=e.dbName??Se;this.#e=this.#s(n,Ee,{upgrade(a){if(!a.objectStoreNames.contains(f)){const r=a.createObjectStore(f,{keyPath:"cacheKey"});r.createIndex("contentId","contentId",{unique:!1}),r.createIndex("personaId","personaId",{unique:!1}),r.createIndex("renderAt","renderAt",{unique:!1})}a.objectStoreNames.contains(p)||a.createObjectStore(p,{keyPath:"contentId"})}})}async get(e){const n=(await this.#e).transaction([f,p],"readwrite"),a=n.objectStore(f),r=await a.get(e);return r&&(r.lastAccessed=Date.now(),await a.put(r),await this.#r(n,r.contentId)),await n.done,r}async set(e){const t={...e,size:this.#o(e),lastAccessed:Date.now()},a=(await this.#e).transaction([f,p],"readwrite"),r=a.objectStore(f),i=await r.get(t.cacheKey);await r.put(t);const c=t.size-(i?.size??0);await this.#a(a,t.contentId,c),await a.done,await this.#c()}async purgeFuture(e,t){const a=(await this.#e).transaction([f,p],"readwrite");let i=await a.objectStore(f).index("contentId").openCursor(e),c=0;for(;i;){const o=i.value;o.renderAt>=t&&(c+=o.size,await i.delete()),i=await i.continue()}c>0&&await this.#a(a,e,-c),await a.done}async clearContent(e){const n=(await this.#e).transaction([f,p],"readwrite");let r=await n.objectStore(f).index("contentId").openCursor(e);for(;r;)await r.delete(),r=await r.continue();await n.objectStore(p).delete(e),await n.done}async clearAll(){const t=(await this.#e).transaction([f,p],"readwrite");await t.objectStore(f).clear(),await t.objectStore(p).clear(),await t.done}async sizeReport(){const t=(await this.#e).transaction(p,"readonly"),a=await t.objectStore(p).getAll(),r=a.reduce((c,o)=>(c[o.contentId]=o.size,c),{}),i=a.reduce((c,o)=>c+o.size,0);return await t.done,{global:i,contents:r}}#o(e){return new TextEncoder().encode(JSON.stringify(e)).byteLength}async#a(e,t,n){const a=e.objectStore(p),r=await a.get(t)??{contentId:t,size:0,updatedAt:Date.now()};r.size=Math.max(0,r.size+n),r.updatedAt=Date.now(),r.size===0?await a.delete(t):await a.put(r)}async#r(e,t){const n=e.objectStore(p),a=await n.get(t);a&&(a.updatedAt=Date.now(),await n.put(a))}async#c(){const e=await this.sizeReport();if(e.global<=this.#n&&this.#i(e.contents))return;const n=(await this.#e).transaction([f,p],"readwrite"),a=n.objectStore(f),i=(await a.getAll()).sort((u,m)=>u.lastAccessed-m.lastAccessed);let c=e.global;const o={...e.contents};for(const u of i){if(c<=this.#n&&Object.values(o).every(m=>m<=this.#t))break;await a.delete(u.cacheKey),c-=u.size,o[u.contentId]=Math.max(0,(o[u.contentId]??0)-u.size),o[u.contentId]===0&&delete o[u.contentId]}const l=n.objectStore(p);for(const[u,m]of Object.entries(o))m===0?await l.delete(u):await l.put({contentId:u,size:m,updatedAt:Date.now()});await n.done}#i(e){return Object.values(e).every(t=>t<=this.#t)}}const Ae=typeof indexedDB>"u"?re():V,C=new Me({},Ae);class Ce{#e="info";#t=new Set;setLevel(e){this.#e=e}addListener(e){this.#t.add(e)}removeListener(e){this.#t.delete(e)}debug(e,t){this.#n("debug",e,t)}info(e,t){this.#n("info",e,t)}warn(e,t){this.#n("warn",e,t)}error(e,t){this.#n("error",e,t)}#n(e,t,n){if(this.#s(e)){const a=`[${new Date().toISOString()}][${e.toUpperCase()}]`;console[e==="debug"?"info":e](`${a} ${t}`,n??"")}this.#t.forEach(a=>a({level:e,message:t,data:n}))}#s(e){const t={debug:10,info:20,warn:30,error:40};return t[e]>=t[this.#e]}}const h=new Ce,Te=8e3,ve=2,xe=2e3;class Le{#e;#t;#n=!1;#s={level:"ok"};configure({endpoint:e,apiKey:t}){this.#e=e,this.#t=t,this.#n=!!(e&&t),this.#s=this.#n?{level:"ok"}:{level:"degraded",detail:"LLM 未配置，使用占位响应"}}async complete(e){if(!this.#n||!this.#e||!this.#t)return h.warn("[llm-client] LLM not configured; returning stub response."),this.#s={level:"degraded",detail:"LLM 未配置"},this.#a(e,"missing_config");const t=(e.maxRetries??ve)+1,n=e.timeoutMs??Te;let a;for(let i=0;i<t;i+=1)try{const c=new AbortController;e.signal&&e.signal.addEventListener("abort",()=>c.abort(e.signal?.reason));const o=setTimeout(()=>{c.abort("timeout")},n);let l;try{l=await fetch(this.#e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.#t}`},body:JSON.stringify({model:"gpt-4o-mini",messages:e.messages,max_tokens:e.maxTokens??80,temperature:e.temperature??.8,top_p:e.topP??.9}),signal:c.signal})}finally{clearTimeout(o)}if(!l.ok){const S=await l.text();throw new Error(`LLM request failed: ${l.status} ${S}`)}const d=((await l.json())?.choices?.[0]?.message?.content??"").trim();if(!d)throw new Error("LLM returned empty response");const b=l.headers.get("x-ratelimit-remaining");return b&&h.debug("[llm-client] Quota remaining",{remaining:b,limit:l.headers.get("x-ratelimit-limit"),reset:l.headers.get("x-ratelimit-reset")}),this.#s={level:"ok"},{personaId:e.personaId,text:d,usingFallback:!1}}catch(c){a=c;const o=i+1,l=c instanceof Error?c.message:String(c);if(h.warn(`[llm-client] Attempt ${o} failed`,l),i<t-1){const u=xe*2**i;await this.#o(u);continue}}const r=a instanceof Error?a.message:String(a??"unknown");return this.#s={level:"degraded",detail:r},h.error("[llm-client] All attempts failed, falling back to stub",r),this.#a(e,"request_failed")}getLastStatus(){return this.#s}#o(e){return new Promise(t=>{setTimeout(t,e)})}#a(e,t){const a=e.messages.filter(o=>o.role==="user").map(o=>o.content).join(" ").replace(/\s+/g," ").trim(),r=a.length>80?`${a.slice(0,77)}...`:a,i=["wild ride, huh?","this crew keeps me on my toes.","did not see that coming."],c=i[Math.floor(Math.random()*i.length)]??"";return{personaId:e.personaId,text:r?`${r} (${c})`:`(${e.personaId}) sharing the moment.`,usingFallback:!0,fallbackReason:t}}}const N=new Le,_=[{id:"alex",name:"Alex — Casual Movie Buff",cadenceSeconds:15,maxWords:30,systemPrompt:"You are Alex, a relaxed movie buff with a friendly tone who spots fun pop-culture references and keeps reactions positive and colloquial.",styleGuidelines:['Reference moments in the show conversationally (e.g., "Can you believe ...?")',"Avoid spoilers for future scenes","Keep language PG-13 and breezy","Use contractions and casual slang only when it fits; aim for under 18 words","If nothing fresh pops up, reply with [skip] instead of forcing a take"],fewShotExamples:[{user:`Context: [00:10] Character 1: "We need a miracle."
Context: [00:12] Character 2 sighs heavily.
Instruction: React as Alex.`,assistant:"Okay this feels like the part where the underdog montage kicks in."},{user:`Context: [12:41] Character whispers, "Did you see that?"
Instruction: React as Alex.`,assistant:"Pretty sure that was the most dramatic hallway turn since season one."}],temperature:.8,topP:.9,disallowedPhrases:["As an AI","In conclusion","I am just a persona"]},{id:"jordan",name:"Jordan — Analytical Critic",cadenceSeconds:18,maxWords:40,systemPrompt:"You are Jordan, an analytical critic who comments on plot structure and character motivations with articulate, concise language.",styleGuidelines:["Tie reactions to storytelling craft or character arcs","Use precise vocabulary but remain conversational","Avoid lecturing; keep it to one or two sentences","Prefer sharp, concise insights (<20 words) with natural phrasing","If no meaningful critique comes to mind, respond with [skip]"],fewShotExamples:[{user:`Context: [24:03] Character A: "Trust me, this will work."
Context: [24:05] Character B hesitates.
Instruction: React as Jordan.`,assistant:"Classic act-two gamble—if it fails, that hesitation will haunt them."},{user:`Context: [36:11] Montage of flashbacks reveals motive.
Instruction: React as Jordan.`,assistant:"Ah, folding the flashback here retrofits the motive but trims the suspense a bit thin."}],temperature:.7,topP:.85,disallowedPhrases:["As an AI","In conclusion","From an analytical standpoint"]},{id:"sam",name:"Sam — Emotional Empath",cadenceSeconds:20,maxWords:35,systemPrompt:"You are Sam, emotionally attuned to characters. React with empathy, noticing feelings and vibes while staying uplifting.",styleGuidelines:["Highlight emotional beats and character feelings","Encourage empathy, avoid negativity","No therapy advice—keep it light and supportive","Use warm, everyday language with gentle slang; keep it under 18 words","When emotions feel flat to you, respond with [skip] and stay silent"],fewShotExamples:[{user:`Context: [08:52] Character wipes away a tear after a small victory.
Instruction: React as Sam.`,assistant:"My heart—seeing them let that tiny grin through is everything."},{user:`Context: [31:19] Two friends exchange a worried look during chaos.
Instruction: React as Sam.`,assistant:"They are both silently promising to hold it together—so quietly brave."}],temperature:.85,topP:.92,disallowedPhrases:["As an AI","Stay positive","Cheer up"]},{id:"casey",name:"Casey — Sarcastic Wit",cadenceSeconds:15,maxWords:28,systemPrompt:"You are Casey, a witty observer with playful sarcasm. Deliver clever quips while keeping it kind-hearted and PG-13.",styleGuidelines:["Lean on irony and playful exaggeration","Never be cruel; keep jokes friendly","Stay snappy—one punchy sentence max","Drop witty slang or hyperbole only when it lands; stay under 16 words","If the moment is dull, go with [skip] rather than a forced quip"],fewShotExamples:[{user:`Context: [15:44] Character dramatically slams a door.
Instruction: React as Casey.`,assistant:"Door 1, patience 0—someone just rage-quit the hallway."},{user:`Context: [42:07] Villain reveals plan with an evil chuckle.
Instruction: React as Casey.`,assistant:"Love that he rehearsed this speech in the mirror and still thought “mwahaha” was subtle."}],temperature:.9,topP:.95,disallowedPhrases:["As an AI","Haha","LOL"]}],De=new Set(["the","and","you","for","but","that","with","this","have","what","your","from","they","there","will","were","just","about","like","into","when","them","then","than","over"]);function Pe(s){const e=s.match(/^([A-Z][A-Z\s]{1,20}):/);return e?e[1].split(" ").map(t=>t.trim()).filter(Boolean):[]}function Re(s){const e=s.replace(/[^a-zA-Z\s]/g," ").toLowerCase().split(/\s+/).filter(n=>n.length>3&&!De.has(n)),t=new Map;return e.forEach(n=>{t.set(n,(t.get(n)??0)+1)}),Array.from(t.entries()).sort((n,a)=>a[1]-n[1]).slice(0,5).map(([n])=>n)}function _e(s){const e=s.toLowerCase();return/[!?]{2,}/.test(s)||/shut up|run|now!/i.test(s)?"tense":/(haha|lol|funny|joke|laugh)/i.test(e)?"humorous":/(love|kiss|sweet|adorable)/i.test(e)?"romantic":/(sorry|cry|sad|tears|hurt)/i.test(e)?"sad":/(what|why|how|huh)/i.test(e)||/\?/.test(s)?"confused":"calm"}function Be(s){const e=Math.min(s.length/80,1),t=Math.min((s.match(/!/g)?.length??0)/3,1),n=Math.min((s.match(/\?/g)?.length??0)/3,1),a=e*.3+t*.4+n*.3;return a>.65?"high":a>.35?"medium":"low"}function Ne(s,e){const t=s.trim();return!(!t||/^(hmm+|uh+|mm+)$/.test(t.toLowerCase())||t.length<8&&e==="low")}function Oe(s){if(s.length===0)return{summary:"",keywords:[],speakers:[],tone:"calm",energy:"low",hasQuestion:!1,hasExclamation:!1,shouldRespond:!1};const e=s.map(c=>c.text).join(" "),t=Array.from(new Set(s.flatMap(c=>Pe(c.text)).filter(c=>c.length>1))),n=Re(e),a=_e(e),r=Be(e);return{summary:e.length>160?`${e.slice(0,157)}...`:e,keywords:n,speakers:t,tone:a,energy:r,hasQuestion:/\?/.test(e),hasExclamation:/!/.test(e),shouldRespond:Ne(e,r)}}const je={low:25e3,medium:15e3,high:8e3},te=3,ne=5,Ue=8e3,ze=3;class $e{#e=new Map;#t=[];#n=null;#s=new Map;#o=[];#a=[];#r=new Map;#c=new Map;#i=new Map;#l={state:"paused",positionMs:0,contentId:null,updatedAt:0};#h=null;constructor(){_.forEach(e=>{this.#e.set(e.id,{lastEmittedAt:0}),this.#s.set(e.id,[]),this.#r.set(e.id,!1),this.#i.set(e.id,{topics:[],lastText:null,lastAt:0})})}updatePlaybackStatus(e){const t=this.#h;this.#l=e,e.contentId&&e.contentId!==this.#n&&(this.#n=e.contentId,this.#t=[],this.#d({resetCadence:!0})),e.state!=="playing"&&this.#r.forEach((n,a)=>{this.#r.set(a,!1)}),typeof t=="number"&&e.positionMs<t-500&&(this.#t=[],this.#d({resetCadence:!0})),e.state==="seeking"&&this.#d({resetCadence:!0}),this.#h=e.positionMs}async processCueBatch(e,t){if(!t.globalEnabled)return h.debug("[orchestrator] Global toggle disabled; ignoring cues."),{comments:[],metrics:this.#u()};const n=e[e.length-1];if(!n)return{comments:[],metrics:this.#u()};if(this.#l.state!=="playing"&&this.#l.updatedAt!==0)return h.debug("[orchestrator] Playback inactive; skipping generation.",{state:this.#l.state}),{comments:[],metrics:this.#u()};this.#b(e);const a=Oe(this.#t),r=this.#m();if(!a.shouldRespond)return r.skippedByHeuristics+=1,this.#f([],r,t);const i=this.#S(n.startTime),c=i.total,o=i.perPersona,l=new Map,u=[];let m=0;for(const d of _){if(!t.personaEnabled[d.id])continue;if(c+m>=ze)break;const b=(o.get(d.id)??0)+(l.get(d.id)??0);if(b>=1){r.skippedByHeuristics+=1;continue}if(this.#r.get(d.id)){r.skippedByLock+=1,h.debug("[orchestrator] Persona locked, skipping",{persona:d.id});continue}if(this.#w(d,n,t,a)){r.skippedByHeuristics+=1,h.debug("[orchestrator] Cue skipped by heuristics",{persona:d.id,cueId:n.cueId});continue}const S=Date.now(),v=this.#e.get(d.id),j=d.cadenceSeconds*1e3,U=je[t.density],I=Math.max(j,U);if(v&&S-v.lastEmittedAt<I){r.skippedByThrottle+=1,h.debug("[orchestrator] Persona throttled",{persona:d.id});continue}const g=`${n.cueId}::${d.id}`,M=await C.get(g);if(M){h.debug("[orchestrator] Cache hit",{cacheKey:g});const y={...M,id:g,createdAt:Date.now(),renderAt:n.startTime+500};this.#y(y,n.cueId,a.keywords),u.push(y),l.set(d.id,b+1),m+=1;const A=Date.now()-S;r.cacheHits+=1,r.generatedCount+=1,r.generationLatencyMsTotal+=A;continue}this.#r.set(d.id,!0);try{const y=this.#E({persona:d,preferences:t,scene:a}),A=Date.now(),x=await N.complete({personaId:d.id,messages:y,maxTokens:Math.max(64,d.maxWords*2),temperature:d.temperature,topP:d.topP}),oe=Date.now()-A;r.llmCalls+=1,r.llmLatencyMsTotal+=oe;const L=this.#M(x.text,d);if(!L){r.sanitizedDrops+=1,h.warn("[orchestrator] Sanitized response empty, skipping",{persona:d.id});continue}if(this.#A(d.id,L)){r.duplicatesFiltered+=1,h.debug("[orchestrator] Skipping duplicate output",{persona:d.id,cleaned:L});continue}const ie=Date.now(),z={id:g,personaId:d.id,text:L,createdAt:ie,renderAt:n.startTime+500,durationMs:6e3};await C.set({...z,cacheKey:g,contentId:n.contentId,personaId:d.id,cueId:n.cueId,promptHash:this.#I(JSON.stringify(y))}),x.usingFallback&&(r.fallbackResponses+=1),this.#y(z,n.cueId,a.keywords),u.push(z),l.set(d.id,b+1),m+=1;const ce=Date.now()-S;r.cacheMisses+=1,r.generatedCount+=1,r.generationLatencyMsTotal+=ce}finally{this.#r.set(d.id,!1)}}return this.#f(u,r,t)}#d({resetCadence:e=!1}={}){this.#s.forEach((t,n)=>{this.#s.set(n,[])}),this.#i.forEach((t,n)=>{this.#i.set(n,{topics:[],lastText:null,lastAt:0})}),this.#r.forEach((t,n)=>{this.#r.set(n,!1)}),this.#c.clear(),this.#o=[],this.#a=[],e&&this.#e.forEach((t,n)=>{this.#e.set(n,{...t,lastEmittedAt:0})})}#m(){return{cacheHits:0,cacheMisses:0,llmCalls:0,llmLatencyMsTotal:0,generationLatencyMsTotal:0,generatedCount:0,skippedByThrottle:0,skippedByHeuristics:0,skippedByLock:0,duplicatesFiltered:0,sanitizedDrops:0,fallbackResponses:0}}#p(e){return{timestamp:Date.now(),cacheHits:e.cacheHits,cacheMisses:e.cacheMisses,llmCalls:e.llmCalls,averageLLMLatencyMs:e.llmCalls>0?e.llmLatencyMsTotal/e.llmCalls:0,averageGenerationLatencyMs:e.generatedCount>0?e.generationLatencyMsTotal/e.generatedCount:0,skippedByThrottle:e.skippedByThrottle,skippedByHeuristics:e.skippedByHeuristics,skippedByLock:e.skippedByLock,duplicatesFiltered:e.duplicatesFiltered,sanitizedDrops:e.sanitizedDrops,fallbackResponses:e.fallbackResponses,cacheSizeGlobalBytes:0,cacheSizeActiveBytes:0,activeContentId:this.#n,windowCommentTotal:this.#a.length}}#u(){return this.#p(this.#m())}async#f(e,t,n){const a=this.#p(t);if(n.developerMode){try{const r=await C.sizeReport();a.cacheSizeGlobalBytes=r.global,a.cacheSizeActiveBytes=this.#n?r.contents[this.#n]??0:0}catch(r){h.warn("[orchestrator] Failed to gather cache metrics",r)}h.debug("[orchestrator] Metrics snapshot",a)}return{comments:e,metrics:a}}#w(e,t,n,a){const r=t.text.trim();if(!r||!/[a-zA-Z]/.test(r)||this.#c.get(e.id)===t.cueId&&this.#l.state==="playing")return!0;const c=a.energy;if(n.density==="low"){if(!(/[!?]/.test(r)||r.length>=18||a.hasQuestion)||c==="low")return!0}else if(n.density==="medium"&&c==="low"&&r.length<10&&!/[!?]/.test(r))return!0;const o=this.#i.get(e.id);return!!(o&&Date.now()-o.lastAt<5e3&&a.keywords.filter(u=>o.topics.includes(u)).length>=Math.min(2,a.keywords.length))}#b(e){const t=e[e.length-1];if(t){this.#n!==t.contentId&&(this.#n=t.contentId,this.#t=[],this.#d({resetCadence:!0}));for(const n of e)this.#t.some(a=>a.cueId===n.cueId)||this.#t.push(n);this.#t.length>te&&(this.#t=this.#t.slice(this.#t.length-te))}}#g(e){this.#a=this.#a.filter(t=>e-t.timestamp<=Ue)}#S(e){this.#g(e);const t=new Map;for(const n of this.#a)t.set(n.personaId,(t.get(n.personaId)??0)+1);return{total:this.#a.length,perPersona:t}}#y(e,t,n){this.#a.push({timestamp:e.renderAt,personaId:e.personaId}),this.#g(e.renderAt),this.#C(e.personaId,e.text,n),this.#c.set(e.personaId,t),this.#k(e.personaId)}#E({persona:e,preferences:t,scene:n}){const a=this.#t.map(g=>{const M=g.startTime>1e3?g.startTime:g.startTime*1e3,y=Math.max(0,Math.floor(M/1e3)),A=String(Math.floor(y/60)).padStart(2,"0"),x=String(y%60).padStart(2,"0");return`[${A}:${x}] ${g.text}`}).join(`
`),r=e.styleGuidelines.map((g,M)=>`${M+1}. ${g}`).join(`
`),i=`Comment only if you have a fresh take; avoid repetition. Current density preference: ${t.density}.`,c=this.#i.get(e.id),o=c?.lastText?`Previously you reacted with "${c.lastText}" about ${Math.max(1,Math.round((Date.now()-c.lastAt)/1e3))} seconds ago. Refer back only if it deepens your point.`:"You have not reacted recently in this scene.",l=c?.topics?.length?`Topics you touched recently: ${c.topics.join(", ")}.`:"",u=`Scene tone: ${n.tone}. Energy: ${n.energy}.`,m=n.speakers.length?`Speakers in focus: ${n.speakers.join(", ")}.`:"Speaker unknown—react as an engaged viewer.",d=n.keywords.length?`Notable keywords: ${n.keywords.join(", ")}.`:"",S=[e.systemPrompt,`Keep it under ${e.maxWords} words.`,"Speak like a human watcher, not a narrator. Use everyday spoken English with natural contractions and occasional slang only when it fits.","Avoid quoting the subtitles verbatim; focus on your reaction or insight.",i,u,m,d,e.disallowedPhrases.length>0?`Never use these phrases: ${e.disallowedPhrases.join(", ")}.`:null,"If you truly have nothing new or meaningful to add, respond with [skip]."].filter(Boolean).join(" "),v=n.summary||a,j=[o,l].filter(Boolean).join(`
`),U=[`Scene summary: ${v}`,`Subtitle window:
${a}`,`Guidelines:
${r}`,j,"Instruction: Respond in one short spoken-style sentence. Keep it natural, as if chatting with friends."].filter(Boolean).join(`
`),I=[{role:"system",content:S}];return e.fewShotExamples.forEach(g=>{I.push({role:"user",content:g.user}),I.push({role:"assistant",content:g.assistant})}),I.push({role:"user",content:U}),I}#k(e){const t=this.#e.get(e)??{lastEmittedAt:0};t.lastEmittedAt=Date.now(),this.#e.set(e,t)}getActiveContentId(){return this.#n}resetAfterRegeneration(){this.#t=[],this.#d({resetCadence:!0})}#I(e){let t=0;for(let n=0;n<e.length;n+=1)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(36)}#M(e,t){if(!e)return"";let n=e.trim();if(/^\[skip\]$/i.test(n))return"";const a=n.length;n=n.replace(/^"+|"+$/g,""),n=n.replace(/^[\[\(].*?[\]\)]\s*/g,""),n=n.replace(/\s+/g," ").trim();for(const r of t.disallowedPhrases){const i=new RegExp(r,"i");i.test(n)&&(n=n.replace(i,"").trim())}return n.length===0?"":(a!==n.length&&h.debug("[orchestrator] Sanitized LLM response",{persona:t.id,originalLength:a,sanitizedLength:n.length}),n)}#A(e,t){const n=t.toLowerCase();return this.#o.includes(n)?!0:(this.#s.get(e)??[]).includes(n)}#C(e,t,n){const a=t.toLowerCase(),r=this.#s.get(e)??[];for(r.push(a);r.length>ne;)r.shift();for(this.#s.set(e,r),this.#o.push(a);this.#o.length>ne*_.length;)this.#o.shift();const c=[...(this.#i.get(e)??{topics:[]}).topics,...n].filter(Boolean).map(l=>l.toLowerCase()),o=Array.from(new Set(c)).slice(-5);this.#i.set(e,{topics:o,lastText:t,lastAt:Date.now()})}}const D=new $e,Fe={alex:!0,jordan:!0,sam:!0,casey:!0},Y={globalEnabled:!0,density:"medium",personaEnabled:{...Fe},developerMode:!1,lastUpdated:Date.now()},P="netflix-ai-danmaku::preferences";class We{#e=null;#t=new Set;async get(){if(this.#e)return this.#e;const e=await chrome.storage.local.get(P);return e?.[P]?(this.#e=e[P],this.#e):(this.#e=Y,await this.set(Y),this.#e)}async set(e){this.#e={...e,lastUpdated:Date.now()},await chrome.storage.local.set({[P]:this.#e}),this.#n()}async update(e){const t=await this.get(),n={...t,...e,personaEnabled:{...t.personaEnabled,...e.personaEnabled},lastUpdated:Date.now()};await this.set(n)}subscribe(e){return this.#t.add(e),()=>this.#t.delete(e)}#n(){this.#e&&this.#t.forEach(e=>e(this.#e))}}const O=new We;chrome.runtime.onInstalled.addListener(()=>{h.info("Netflix AI Danmaku extension installed.")});let k=null;const T=new Map;async function R(){return k||(k=await O.get()),k}O.subscribe(s=>{k=s,h.setLevel(s.developerMode?"debug":"info")});chrome.runtime.onMessage.addListener((s,e,t)=>((async()=>{switch(s.type){case"PING":{t({type:"PONG",timestamp:Date.now()});return}case"REQUEST_PREFERENCES":{const n=await R();t({type:"PREFERENCES_RESPONSE",preferences:n});return}case"UPDATE_PREFERENCES":{const n=await R(),a={...n,...s.preferences,personaEnabled:{...n.personaEnabled,...s.preferences.personaEnabled},lastUpdated:Date.now()};await O.set(a),await chrome.runtime.sendMessage({type:"PREFERENCES_RESPONSE",preferences:a}),t({type:"PREFERENCES_RESPONSE",preferences:a});return}case"CUES_BATCH":{if(!e.tab?.id){h.warn("[background] Received cues without tab context.");return}const n=await R(),{comments:a,metrics:r}=await D.processCueBatch(s.cues,n);a.length>0&&await chrome.tabs.sendMessage(e.tab.id,{type:"COMMENTS_BATCH",comments:a}),n.developerMode&&await chrome.tabs.sendMessage(e.tab.id,{type:"METRICS_UPDATE",metrics:r}),e.tab?.id!==void 0&&await Ke(e.tab.id,r),t({type:"RENDER_STATUS",status:"idle"});return}case"PLAYBACK_STATUS_UPDATE":{D.updatePlaybackStatus(s.status),s.status.state==="seeking"&&s.status.contentId&&Number.isFinite(s.status.positionMs)&&s.status.positionMs>=0&&await C.purgeFuture(s.status.contentId,s.status.positionMs),t({type:"RENDER_STATUS",status:"idle"});return}case"REQUEST_LLM_STATUS":{const n=e.tab?.id,r=(n!==void 0?T.get(n):null)??N.getLastStatus();n!==void 0&&T.set(n,r),t({type:"LLM_STATUS_UPDATE",status:r});return}case"REGENERATE_FROM_TIMESTAMP":{if(!(await R()).globalEnabled){t({type:"RENDER_STATUS",status:"idle"});return}k?.lastUpdated;let a=D.getActiveContentId();!a&&e.tab?.id!==void 0&&(a=await Ge(e.tab.id)),a&&Number.isFinite(s.timestamp)&&s.timestamp>=0&&(await C.purgeFuture(a,s.timestamp),D.resetAfterRegeneration()),t({type:"RENDER_STATUS",status:"idle"});return}default:h.warn("[background] Unknown message type",s)}})().catch(n=>{h.error("[background] Message handler error",n),t({type:"RENDER_STATUS",status:"error",detail:String(n)})}),!0));chrome.alarms.create("keepalive",{periodInMinutes:4});chrome.alarms.onAlarm.addListener(s=>{s.name==="keepalive"&&chrome.runtime.getPlatformInfo(()=>{h.debug("[background] keepalive ping")})});chrome.tabs.onRemoved.addListener(s=>{T.delete(s)});async function Ge(s){try{const e=await chrome.tabs.sendMessage(s,{type:"REQUEST_ACTIVE_CONTENT_ID"});if(e&&e.type==="ACTIVE_CONTENT_ID_RESPONSE")return e.contentId}catch(e){h.warn("[background] Failed to obtain active content id",e)}return null}async function Ke(s,e){const t=N.getLastStatus(),n={level:t.level,detail:t.detail};if(n.level!=="error"&&e.fallbackResponses>0){const r=`使用占位响应 ${e.fallbackResponses} 条`;n.level="degraded",n.detail=n.detail?`${n.detail}; ${r}`:r}const a=T.get(s);if(!(a&&a.level===n.level&&a.detail===n.detail)){T.set(s,n);try{await chrome.tabs.sendMessage(s,{type:"LLM_STATUS_UPDATE",status:n})}catch(r){h.debug("[background] Failed to broadcast LLM status",r)}}}const He="https://api.laozhang.ai/v1/chat/completions",Ve="sk-D4qOhVgUNgCXDNdzC91cB185097d40749684F182B494914b";N.configure({endpoint:He,apiKey:Ve});chrome.runtime.onConnect.addListener(s=>{s.name==="persona-stream"&&s.postMessage({personas:_})});(async()=>(k=await O.get()??Y,h.setLevel(k.developerMode?"debug":"info")))();
