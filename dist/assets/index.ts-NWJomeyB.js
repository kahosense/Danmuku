import{s as m}from"./messages-BoMeRyd0.js";const O=200,H=5e3;function B(){return window.netflix?.appContext?.state?.playerApp?.getAPI().videoPlayer}async function G(){const t=Date.now();return new Promise(e=>{const n=()=>{const o=B(),a=o?.getAllPlayerSessionIds()[0];if(o&&a){const s=o.getVideoPlayerBySessionId(a);if(s){e(s);return}}if(Date.now()-t>=H){e(null);return}window.setTimeout(n,O)};n()})}const q=400,W=3,S='.player-timedtext, [data-uia="player-timedtext"]';function j(){const t={player:null,teardownFns:[],batch:[],batchTimer:null,lastDomCueSignature:null};function e(s,i){!s.text.trim()||s.text.trim().length<W||(t.batch.push(s),t.batchTimer===null&&(t.batchTimer=window.setTimeout(()=>{const r=[...t.batch];t.batch=[],t.batchTimer=null,r.length>0&&i(r)},q)))}function n(s){const i=r=>{if(!(r.text?.trim()??""))return;const l=A(t.player),d=_(r,l,"netflix-api");e(d,s)};!t.player||typeof t.player.on!="function"||(t.player.on("timedTextCueEntered",i),t.teardownFns.push(()=>{try{t.player?.off?.("timedTextCueEntered",i)}catch(r){console.warn("[content] Failed to detach Netflix cue handler",r)}}))}function o(s){let i=null;const r=new MutationObserver(()=>{const d=document.querySelector(S);!d||d===i||(i=d,c.disconnect(),c.observe(d,{childList:!0,subtree:!0}))}),c=new MutationObserver(()=>{const d=i??document.querySelector(S);if(!d)return;const h=X(d);if(!h)return;const f=`${h}::${Math.floor(Date.now()/1e3)}`;if(t.lastDomCueSignature===f)return;t.lastDomCueSignature=f;const g=t.player?.getCurrentTime?.()??performance.now(),u={text:h,startTime:g,endTime:g+3e3},p=_(u,A(t.player),"dom-fallback");e(p,s)});r.observe(document.body,{childList:!0,subtree:!0});const l=document.querySelector(S);l&&(i=l,c.observe(l,{childList:!0,subtree:!0})),t.teardownFns.push(()=>{r.disconnect(),c.disconnect(),i=null})}async function a(s){return t.player=await G(),t.player?(console.info("[content] Netflix video player attached."),n(s)):console.warn("[content] Netflix video player not detected within timeout. Falling back to DOM observer."),o(s),()=>{t.batchTimer!==null&&(window.clearTimeout(t.batchTimer),t.batchTimer=null),t.teardownFns.forEach(i=>{try{i()}catch(r){console.warn("[content] Error during subtitle observer teardown",r)}}),t.teardownFns=[],t.player=null,t.lastDomCueSignature=null}}return{start:a}}function _(t,e,n){const o=Math.max(0,t.startTime??0),a=t.endTime??o,s=Math.max(0,a-o),i=t.id||`${Math.round(o)}-${Math.round(a)}-${V(t.text)}`;return{contentId:e,text:t.text.trim(),startTime:o,endTime:a,duration:s,cueId:`${e}-${i}`,source:n}}function V(t){let e=0;for(let n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e).toString(36)}function A(t){const e=t?.getVideoData?.(),n=e?.movieId??e?.title??"unknown";return String(n)}function X(t){return Array.from(t.querySelectorAll("span")).map(n=>n.textContent?.trim()??"").filter(Boolean).join(" ").trim()}const Y=":host{position:absolute;inset:0;pointer-events:none;z-index:2147483647;font-family:Inter,Helvetica Neue,Arial,sans-serif}.danmaku-container{position:absolute;inset:8% 2% auto;height:35%;display:flex;flex-direction:column;justify-content:space-between;gap:8px}.danmaku-lane{position:relative;flex:1;overflow:hidden}.danmaku-comment{position:absolute;top:0;white-space:nowrap;padding:4px 12px;border-radius:999px;background:#1e293bbf;color:#f8fafc;font-size:15px;letter-spacing:.01em;transform:translate(100%);will-change:transform;transition:opacity .3s ease;opacity:.95}.danmaku-comment.persona-alex{background:#3b82f6cc}.danmaku-comment.persona-jordan{background:#22c55ecc}.danmaku-comment.persona-sam{background:#ec4899cc}.danmaku-comment.persona-casey{background:#f59e0bd9}@media (prefers-reduced-motion: reduce){.danmaku-comment{transition:transform .3s ease}}",Q=4,K=6e3,P=32,J=350,C=60,Z=3,ee=350,te=190,ne=150,oe=115,ae=90,se=200;class ie{constructor(e){this.host=e,this.#t=e.attachShadow({mode:"open"});const n=document.createElement("style");n.textContent=Y,this.#t.appendChild(n);const o=document.createElement("div");o.className="danmaku-container",this.#t.appendChild(o);for(let a=0;a<Q;a+=1){const s=document.createElement("div");s.className="danmaku-lane",o.appendChild(s),this.#e.push({element:s,busyUntil:0})}}#t;#e=[];#n=!0;#s=new Set;#a=0;#i=0;setEnabled(e){this.#n=e,e||this.clear()}clear(){this.#e.forEach(e=>{e.element.innerHTML="",e.busyUntil=0}),this.#s.clear()}renderBatch(e){if(this.#n){this.#a=0,this.#i=0;for(const n of e){if(this.#s.has(n.id))continue;const o=this.#l(n);this.#a+=o.length,o.length>1&&(this.#i+=o.length-1),o.forEach((a,s)=>{if(this.#s.has(a.id))return;this.#s.add(a.id);const i=s*ee;i>0?window.setTimeout(()=>{this.#n&&this.#o(a)},i):this.#o(a)})}this.#d()}}#o(e){const n=this.#r();if(n.waitMs>0){window.setTimeout(()=>{this.#n&&this.#o(e)},n.waitMs);return}const o=n.lane,a=document.createElement("div");a.className=`danmaku-comment persona-${e.personaId}`,a.textContent=e.text,a.dataset.commentId=e.id,o.element.appendChild(a),requestAnimationFrame(()=>{const s=o.element.clientWidth||window.innerWidth,i=a.clientWidth,r=s+i+P,c=this.#c(r,e.text.length,e.durationMs),l=[{transform:`translateX(${s}px)`},{transform:`translateX(-${i+P}px)`}],d=a.animate(l,{duration:c,easing:"linear"}),h=Date.now()+c;o.busyUntil=h+J;const f=o.busyUntil;d.finished.catch(()=>{}).finally(()=>{a.remove(),o.busyUntil===f&&(o.busyUntil=Date.now()),this.#s.delete(e.id)})})}#r(){const e=Date.now();let n=this.#e[0],o=Math.max(0,n.busyUntil-e);for(const a of this.#e){const s=Math.max(0,a.busyUntil-e);if(s===0){n=a,o=0;break}s<o&&(n=a,o=s)}return{lane:n,waitMs:o}}#c(e,n,o){let a=te;n>70?a=oe:n>45&&(a=ne),a=Math.max(ae,a);const s=e/a*1e3;return Math.max(s+se,o,K)}#l(e){if(e.text.length<=C)return[e];const n=[],o=e.text.split(new RegExp("(?<=[.!?])\\s+")).map(s=>s.trim()).filter(Boolean);for(const s of o){if(s.length<=C){n.push(s);continue}const i=s.split(/\s+/);let r=[];for(const c of i)[...r,c].join(" ").length>C?(n.push(r.join(" ")),r=[c]):r.push(c);r.length&&n.push(r.join(" "))}const a=n.slice(0,Z);return a.length===0?[e]:a.map((s,i)=>({...e,id:`${e.id}::${i}`,text:s.trim()}))}#d(){requestAnimationFrame(()=>{const e=this.#e.filter(n=>n.busyUntil>Date.now()).length;document.dispatchEvent(new CustomEvent("danmaku-metrics",{detail:{activeLanes:e,segmentsGenerated:this.#a,truncated:this.#i}}))})}}let x=null;function re(){if(x)return x;let t=document.getElementById("danmaku-overlay-host");return t||(t=document.createElement("div"),t.id="danmaku-overlay-host",t.style.position="absolute",t.style.inset="0",t.style.pointerEvents="none",(document.querySelector(".watch-video--player-container")??document.querySelector(".watch-video--player-view")??document.body).appendChild(t)),x=new ie(t),x}const ce=".danmaku-control-panel{position:absolute;top:10%;right:2%;width:220px;padding:12px;border-radius:12px;background:#0f172aeb;color:#f1f5f9;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;font-size:14px;pointer-events:auto;z-index:2147483647;box-shadow:0 12px 24px #0f172a59}.danmaku-control-panel.panel-collapsed .panel-body{display:none}.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:600}.panel-collapse{appearance:none;border:none;background:transparent;color:#94a3b8;font-size:16px;cursor:pointer}.panel-body{display:flex;flex-direction:column;gap:10px}.panel-row{display:flex;justify-content:space-between;align-items:center}.switch-row input[type=checkbox]{width:36px;height:18px}.panel-row select{background:#1e293bf2;color:#f8fafc;border:1px solid rgba(148,163,184,.3);border-radius:6px;padding:4px}.persona-group{flex-direction:column;gap:6px;align-items:flex-start}.persona-toggle{display:flex;justify-content:space-between;width:100%;gap:8px}.panel-button{appearance:none;border:none;border-radius:8px;padding:8px 12px;background:#2563eb;color:#f8fafc;cursor:pointer;font-weight:500}.panel-button:hover{background:#1d4ed8}.panel-status{font-size:12px;color:#cbd5f5;min-height:16px}.panel-disabled{opacity:.6}.panel-status-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#cbd5f5;margin-top:6px}.panel-status-badge{padding:2px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;background:#3b82f626;color:#bfdbfe}.panel-status-badge.status-ok{background:#22c55e33;color:#4ade80}.panel-status-badge.status-degraded{background:#eab30833;color:#facc15}.panel-status-badge.status-error{background:#ef444433;color:#f87171}.danmaku-dev-hud{position:fixed;bottom:24px;right:24px;background:#0f172ae6;color:#f8fafc;padding:12px;border-radius:10px;font-size:12px;line-height:1.4;pointer-events:none;z-index:2147483647}",le=200,de=5e3;let w=null,D=null,I=0,U=0;function ue(t){return new Promise(e=>{window.setTimeout(e,t)})}async function he(){for(let e=0;e<25;e+=1){const n=document.querySelector("video");if(n)return n;await ue(le)}return document.querySelector("video")}function pe(t,e){const n=t?.getCurrentTime?.();return typeof n=="number"&&Number.isFinite(n)?Math.max(0,Math.round(n*1e3)):e?Math.max(0,Math.round(e.currentTime*1e3)):0}function b(t,e,n,{force:o}={force:!1}){const a=pe(e,n),s=A(e),i={state:t,positionMs:a,contentId:s,updatedAt:Date.now()};!o&&D===t&&Math.abs(a-I)<750||(D=t,I=a,U=a,m({type:"PLAYBACK_STATUS_UPDATE",status:i}).catch(r=>{console.warn("[content] Failed to send playback status",r)}))}function T(t,e){M(),w=window.setInterval(()=>{b("playing",t,e,{force:!0})},de)}function M(){w!==null&&(window.clearInterval(w),w=null)}async function me(){try{const[t,e]=await Promise.all([G(),he()]);if(!e){console.warn("[content] No video element found for playback observer.");return}const n=e.paused?"paused":"playing";b(n,t,e,{force:!0}),n==="playing"&&T(t,e),e.addEventListener("playing",()=>{b("playing",t,e,{force:!0}),T(t,e)}),e.addEventListener("pause",()=>{b("paused",t,e,{force:!0}),M()}),e.addEventListener("seeking",()=>{b("seeking",t,e,{force:!0}),M()}),e.addEventListener("seeked",()=>{const o=e.paused?"paused":"playing";b(o,t,e,{force:!0}),o==="playing"&&T(t,e)}),window.addEventListener("beforeunload",()=>{M()})}catch(t){console.error("[content] Failed to initialize playback observer",t)}}function fe(){const t=document.querySelector("video");return t?Math.max(0,Math.round(t.currentTime*1e3)):U}class be{#t;#e;#n;#s=new Map;#a;#i;#o;#r=!1;constructor({getPreferences:e}){this.#t=document.createElement("div"),this.#t.className="danmaku-control-panel";const n=document.createElement("style");n.textContent=ce,this.#t.appendChild(n);const o=document.createElement("div");o.className="panel-header";const a=document.createElement("span");a.textContent="AI Danmaku",o.appendChild(a);const s=document.createElement("button");s.type="button",s.className="panel-collapse",s.textContent="≡",s.addEventListener("click",()=>this.#c()),o.appendChild(s),this.#t.appendChild(o);const i=document.createElement("div");i.className="panel-body",this.#t.appendChild(i);const r=document.createElement("label");r.className="panel-row switch-row",r.textContent="启用弹幕",this.#e=document.createElement("input"),this.#e.type="checkbox",this.#e.addEventListener("change",()=>{m({type:"UPDATE_PREFERENCES",preferences:{globalEnabled:this.#e.checked}})}),r.appendChild(this.#e),i.appendChild(r);const c=document.createElement("label");c.className="panel-row",c.textContent="弹幕密度",this.#n=document.createElement("select"),["low","medium","high"].forEach(u=>{const p=document.createElement("option");p.value=u,p.textContent=u==="low"?"低":u==="medium"?"中":"高",this.#n.appendChild(p)}),this.#n.addEventListener("change",()=>{m({type:"UPDATE_PREFERENCES",preferences:{density:this.#n.value}})}),c.appendChild(this.#n),i.appendChild(c);const l=document.createElement("div");l.className="panel-row persona-group",l.innerHTML="<strong>虚拟观众</strong>",i.appendChild(l),[{id:"alex",label:"Alex"},{id:"jordan",label:"Jordan"},{id:"sam",label:"Sam"},{id:"casey",label:"Casey"}].forEach(u=>{const p=document.createElement("label");p.className="persona-toggle",p.textContent=u.label;const v=document.createElement("input");v.type="checkbox",v.addEventListener("change",()=>{m({type:"UPDATE_PREFERENCES",preferences:{personaEnabled:{[u.id]:v.checked}}})}),p.appendChild(v),l.appendChild(p),this.#s.set(u.id,v)}),this.#a=document.createElement("button"),this.#a.type="button",this.#a.className="panel-button",this.#a.textContent="重新生成",this.#a.addEventListener("click",()=>{const u=fe();m({type:"REGENERATE_FROM_TIMESTAMP",timestamp:u}),this.setStatus("重新生成请求已发送"),window.setTimeout(()=>this.setStatus(""),2e3)}),i.appendChild(this.#a),this.#i=document.createElement("span"),this.#i.className="panel-status",i.appendChild(this.#i);const h=document.createElement("div");h.className="panel-status-row";const f=document.createElement("span");f.textContent="LLM 状态",h.appendChild(f),this.#o=document.createElement("span"),this.#o.className="panel-status-badge status-ok",this.#o.textContent="正常",h.appendChild(this.#o),i.appendChild(h),document.body.appendChild(this.#t);const g=e();g&&this.update(g)}update(e){this.#e.checked=e.globalEnabled,this.#n.value=e.density;for(const[n,o]of this.#s.entries())o.checked=!!e.personaEnabled[n];this.#t.classList.toggle("panel-disabled",!e.globalEnabled)}setStatus(e){this.#i.textContent=e}setLLMStatus(e){const n={ok:"正常",degraded:"降级",error:"错误"},o=e.level;this.#o.textContent=n[o]??o,this.#o.className=`panel-status-badge status-${o}`,this.#o.title=e.detail??""}#c(){this.#r=!this.#r,this.#t.classList.toggle("panel-collapsed",this.#r)}}let k=null;function ye(t){return k||(k=new be(t)),k}class ge{#t;#e={cues:0,comments:0,cacheHitRate:0,avgLLMLatencyMs:0,avgGenerationLatencyMs:0,cacheSizeActiveMb:0,cacheSizeGlobalMb:0,fallbackResponses:0,windowCommentTotal:0,activeLanes:0,segmentsGenerated:0,truncatedComments:0,avgCommentLength:0};constructor(){this.#t=document.createElement("div"),this.#t.className="danmaku-dev-hud",this.#t.innerHTML=this.#n(),document.body.appendChild(this.#t)}update(e){e.cues!==void 0&&(this.#e.cues+=e.cues),e.comments!==void 0&&(this.#e.comments+=e.comments),e.cacheHitRate!==void 0&&(this.#e.cacheHitRate=e.cacheHitRate),e.avgLLMLatencyMs!==void 0&&(this.#e.avgLLMLatencyMs=e.avgLLMLatencyMs),e.avgGenerationLatencyMs!==void 0&&(this.#e.avgGenerationLatencyMs=e.avgGenerationLatencyMs),e.cacheSizeActiveMb!==void 0&&(this.#e.cacheSizeActiveMb=e.cacheSizeActiveMb),e.cacheSizeGlobalMb!==void 0&&(this.#e.cacheSizeGlobalMb=e.cacheSizeGlobalMb),e.fallbackResponses!==void 0&&(this.#e.fallbackResponses=e.fallbackResponses),e.windowCommentTotal!==void 0&&(this.#e.windowCommentTotal=e.windowCommentTotal),e.activeLanes!==void 0&&(this.#e.activeLanes=e.activeLanes),e.segmentsGenerated!==void 0&&(this.#e.segmentsGenerated=e.segmentsGenerated),e.truncatedComments!==void 0&&(this.#e.truncatedComments=e.truncatedComments),e.avgCommentLength!==void 0&&(this.#e.avgCommentLength=e.avgCommentLength),this.#t.innerHTML=this.#n()}destroy(){this.#t.remove()}#n(){const e=(this.#e.cacheHitRate*100).toFixed(1),n=this.#e.avgLLMLatencyMs.toFixed(0),o=this.#e.avgGenerationLatencyMs.toFixed(0),a=this.#e.cacheSizeActiveMb.toFixed(2),s=this.#e.cacheSizeGlobalMb.toFixed(2),i=this.#e.avgCommentLength.toFixed(1);return`
      <div><strong>Dev HUD</strong></div>
      <div>字幕批次: ${this.#e.cues}</div>
      <div>弹幕输出: ${this.#e.comments}</div>
      <div>缓存命中率: ${e}%</div>
      <div>LLM延迟: ${n}ms</div>
      <div>生成耗时: ${o}ms</div>
      <div>缓存占用: ${a} / ${s} MB</div>
      <div>Fallback: ${this.#e.fallbackResponses}</div>
      <div>窗口总弹幕: ${this.#e.windowCommentTotal}</div>
      <div>活跃车道: ${this.#e.activeLanes}</div>
      <div>分段数: ${this.#e.segmentsGenerated} 截断: ${this.#e.truncatedComments}</div>
      <div>平均长度: ${i}</div>
    `}}let y=null;function ve(t){t&&!y&&(y=new ge),!t&&y&&(y.destroy(),y=null)}function L(t){y?.update(t)}const F="danmaku-extension-marker";let N=null,E=null;const z=re(),R=ye({getPreferences:()=>E});function Ee(){if(document.getElementById(F))return!1;const t=document.createElement("div");return t.id=F,t.style.display="none",document.documentElement.appendChild(t),!0}function $(t){E=t,z.setEnabled(t.globalEnabled),R.update(t),ve(t.developerMode)}async function xe(t){if(t.length===0)return;N=t[t.length-1]?.contentId??N,L({cues:t.length});const e=await m({type:"CUES_BATCH",cues:t});e?.type==="RENDER_STATUS"&&e.status==="error"&&console.error("[content] Render status error",e.detail)}function we(){if(!Ee()){console.info("[content] Netflix AI Danmaku already initialized; skipping re-attach.");return}console.info("[content] Netflix AI Danmaku content script booting."),m({type:"PING"}),m({type:"REQUEST_PREFERENCES"}).then(n=>{n?.type==="PREFERENCES_RESPONSE"&&$(n.preferences)}),m({type:"REQUEST_LLM_STATUS"}).then(n=>{n?.type==="LLM_STATUS_UPDATE"&&R.setLLMStatus(n.status)}),j().start(n=>{xe(n).catch(o=>{console.error("[content] Failed to send cue batch",o)})}).then(n=>{window.addEventListener("beforeunload",n,{once:!0})}).catch(n=>{console.error("[content] Failed to start subtitle observer",n)}),me().catch(n=>{console.error("[content] Failed to start playback observer",n)})}chrome.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="COMMENTS_BATCH"){z.renderBatch(t.comments);const o=t.comments.reduce((s,i)=>s+i.text.length,0),a=t.comments.length>0?o/t.comments.length:0;L({comments:t.comments.length,avgCommentLength:a});return}if(t.type==="PREFERENCES_RESPONSE"){$(t.preferences);return}if(t.type==="METRICS_UPDATE"){const o=t.metrics.cacheHits+t.metrics.cacheMisses,a=o>0?t.metrics.cacheHits/o:0;L({cacheHitRate:a,avgLLMLatencyMs:t.metrics.averageLLMLatencyMs,avgGenerationLatencyMs:t.metrics.averageGenerationLatencyMs,cacheSizeActiveMb:t.metrics.cacheSizeActiveBytes/(1024*1024),cacheSizeGlobalMb:t.metrics.cacheSizeGlobalBytes/(1024*1024),fallbackResponses:t.metrics.fallbackResponses,windowCommentTotal:t.metrics.windowCommentTotal??0}),E?.developerMode&&(console.debug("[content] Metrics update",t.metrics),t.metrics.fallbackResponses>0&&console.warn("[content] LLM fallback responses",t.metrics.fallbackResponses));return}if(t.type==="LLM_STATUS_UPDATE"){R.setLLMStatus(t.status),E?.developerMode&&console.debug("[content] LLM status update",t.status);return}if(t.type==="REQUEST_ACTIVE_CONTENT_ID")return n({type:"ACTIVE_CONTENT_ID_RESPONSE",contentId:N}),!0});document.addEventListener("danmaku-metrics",t=>{if(!E?.developerMode)return;const e=t.detail;e&&L({activeLanes:e.activeLanes,segmentsGenerated:e.segmentsGenerated,truncatedComments:e.truncated})});we();
