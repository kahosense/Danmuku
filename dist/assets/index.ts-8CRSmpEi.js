const ae=(n,e)=>e.some(t=>n instanceof t);let we,be;function je(){return we||(we=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ue(){return be||(be=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const re=new WeakMap,te=new WeakMap,q=new WeakMap;function Oe(n){const e=new Promise((t,s)=>{const a=()=>{n.removeEventListener("success",r),n.removeEventListener("error",i)},r=()=>{t(x(n.result)),a()},i=()=>{s(n.error),a()};n.addEventListener("success",r),n.addEventListener("error",i)});return q.set(e,n),e}function Fe(n){if(re.has(n))return;const e=new Promise((t,s)=>{const a=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",i),n.removeEventListener("abort",i)},r=()=>{t(),a()},i=()=>{s(n.error||new DOMException("AbortError","AbortError")),a()};n.addEventListener("complete",r),n.addEventListener("error",i),n.addEventListener("abort",i)});re.set(n,e)}let ie={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return re.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return x(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function Ae(n){ie=n(ie)}function Ke(n){return Ue().includes(n)?function(...e){return n.apply(oe(this),e),x(this.request)}:function(...e){return x(n.apply(oe(this),e))}}function ze(n){return typeof n=="function"?Ke(n):(n instanceof IDBTransaction&&Fe(n),ae(n,je())?new Proxy(n,ie):n)}function x(n){if(n instanceof IDBRequest)return Oe(n);if(te.has(n))return te.get(n);const e=ze(n);return e!==n&&(te.set(n,e),q.set(e,n)),e}const oe=n=>q.get(n);function ce(n,e,{blocked:t,upgrade:s,blocking:a,terminated:r}={}){const i=indexedDB.open(n,e),c=x(i);return s&&i.addEventListener("upgradeneeded",o=>{s(x(i.result),o.oldVersion,o.newVersion,x(i.transaction),o)}),t&&i.addEventListener("blocked",o=>t(o.oldVersion,o.newVersion,o)),c.then(o=>{r&&o.addEventListener("close",()=>r()),a&&o.addEventListener("versionchange",d=>a(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}const Ge=["get","getKey","getAll","getAllKeys","count"],We=["put","add","delete","clear"],se=new Map;function Se(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(se.get(e))return se.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,a=We.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(a||Ge.includes(t)))return;const r=async function(i,...c){const o=this.transaction(i,a?"readwrite":"readonly");let d=o.store;return s&&(d=d.index(c.shift())),(await Promise.all([d[t](...c),a&&o.done]))[0]};return se.set(e,r),r}Ae(n=>({...n,get:(e,t,s)=>Se(e,t)||n.get(e,t,s),has:(e,t)=>!!Se(e,t)||n.has(e,t)}));const He=["continue","continuePrimaryKey","advance"],Ee={},le=new WeakMap,Pe=new WeakMap,qe={get(n,e){if(!He.includes(e))return n[e];let t=Ee[e];return t||(t=Ee[e]=function(...s){le.set(this,Pe.get(this)[e](...s))}),t}};async function*Ye(...n){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...n)),!e)return;e=e;const t=new Proxy(e,qe);for(Pe.set(t,e),q.set(t,oe(e));e;)yield t,e=await(le.get(t)||e.continue()),le.delete(t)}function ke(n,e){return e===Symbol.asyncIterator&&ae(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&ae(n,[IDBIndex,IDBObjectStore])}Ae(n=>({...n,get(e,t,s){return ke(e,t)?Ye:n.get(e,t,s)},has(e,t){return ke(e,t)||n.has(e,t)}}));const Je="netflix-ai-danmaku-cache",Qe=1,w="comments",f="content",Xe=5*1024*1024,Ze=20*1024*1024,M=n=>typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n));function Ce(){const n=new Map,e=s=>(n.has(s)||n.set(s,{comments:new Map,contents:new Map}),n.get(s)),t=(s,a,r)=>{if(a>=s.length)return null;const i=s[a];return{value:M(i),async delete(){r.delete(i.cacheKey)},async continue(){return t(s,a+1,r)}}};return async(s,a,r)=>{const i=e(s);return r?.upgrade&&r.upgrade({objectStoreNames:{contains:c=>c===w||c===f},createObjectStore:()=>({createIndex:()=>{}})},0,a??null,{},{}),{transaction(){return{objectStore(c){if(c===w)return{async get(o){const d=i.comments.get(o);return d?M(d):void 0},async put(o){i.comments.set(o.cacheKey,M(o))},async clear(){i.comments.clear()},async delete(o){i.comments.delete(o)},async getAll(){return Array.from(i.comments.values()).map(o=>M(o))},index(o){if(o!=="contentId")throw new Error(`Unsupported index ${o}`);return{async openCursor(d){const u=Array.from(i.comments.values()).filter(p=>p.contentId===d);return t(u.map(p=>M(p)),0,i.comments)}}}};if(c===f)return{async get(o){const d=i.contents.get(o);return d?M(d):void 0},async put(o){i.contents.set(o.contentId,M(o))},async delete(o){i.contents.delete(o)},async clear(){i.contents.clear()},async getAll(){return Array.from(i.contents.values()).map(o=>M(o))}};throw new Error(`Unknown store ${c}`)},done:Promise.resolve()}}}}}class et{#e;#n;#t;#s;constructor(e={},t=ce){this.#n=e.maxContentBytes??Xe,this.#t=e.maxGlobalBytes??Ze,this.#s=t===ce&&typeof indexedDB>"u"?Ce():t;const s=e.dbName??Je;this.#e=this.#s(s,Qe,{upgrade(a){if(!a.objectStoreNames.contains(w)){const r=a.createObjectStore(w,{keyPath:"cacheKey"});r.createIndex("contentId","contentId",{unique:!1}),r.createIndex("personaId","personaId",{unique:!1}),r.createIndex("renderAt","renderAt",{unique:!1})}a.objectStoreNames.contains(f)||a.createObjectStore(f,{keyPath:"contentId"})}})}async get(e){const s=(await this.#e).transaction([w,f],"readwrite"),a=s.objectStore(w),r=await a.get(e);return r&&(r.lastAccessed=Date.now(),await a.put(r),await this.#i(s,r.contentId)),await s.done,r}async set(e){const t={...e,size:this.#r(e),lastAccessed:Date.now()},a=(await this.#e).transaction([w,f],"readwrite"),r=a.objectStore(w),i=await r.get(t.cacheKey);await r.put(t);const c=t.size-(i?.size??0);await this.#a(a,t.contentId,c),await a.done,await this.#c()}async purgeFuture(e,t){const a=(await this.#e).transaction([w,f],"readwrite");let i=await a.objectStore(w).index("contentId").openCursor(e),c=0;for(;i;){const o=i.value;o.renderAt>=t&&(c+=o.size,await i.delete()),i=await i.continue()}c>0&&await this.#a(a,e,-c),await a.done}async clearContent(e){const s=(await this.#e).transaction([w,f],"readwrite");let r=await s.objectStore(w).index("contentId").openCursor(e);for(;r;)await r.delete(),r=await r.continue();await s.objectStore(f).delete(e),await s.done}async clearAll(){const t=(await this.#e).transaction([w,f],"readwrite");await t.objectStore(w).clear(),await t.objectStore(f).clear(),await t.done}async sizeReport(){const t=(await this.#e).transaction(f,"readonly"),a=await t.objectStore(f).getAll(),r=a.reduce((c,o)=>(c[o.contentId]=o.size,c),{}),i=a.reduce((c,o)=>c+o.size,0);return await t.done,{global:i,contents:r}}#r(e){return new TextEncoder().encode(JSON.stringify(e)).byteLength}async#a(e,t,s){const a=e.objectStore(f),r=await a.get(t)??{contentId:t,size:0,updatedAt:Date.now()};r.size=Math.max(0,r.size+s),r.updatedAt=Date.now(),r.size===0?await a.delete(t):await a.put(r)}async#i(e,t){const s=e.objectStore(f),a=await s.get(t);a&&(a.updatedAt=Date.now(),await s.put(a))}async#c(){const e=await this.sizeReport();if(e.global<=this.#t&&this.#o(e.contents))return;const s=(await this.#e).transaction([w,f],"readwrite"),a=s.objectStore(w),i=(await a.getAll()).sort((u,p)=>u.lastAccessed-p.lastAccessed);let c=e.global;const o={...e.contents};for(const u of i){if(c<=this.#t&&Object.values(o).every(p=>p<=this.#n))break;await a.delete(u.cacheKey),c-=u.size,o[u.contentId]=Math.max(0,(o[u.contentId]??0)-u.size),o[u.contentId]===0&&delete o[u.contentId]}const d=s.objectStore(f);for(const[u,p]of Object.entries(o))p===0?await d.delete(u):await d.put({contentId:u,size:p,updatedAt:Date.now()});await s.done}#o(e){return Object.values(e).every(t=>t<=this.#n)}}const tt=typeof indexedDB>"u"?Ce():ce,L=new et({},tt);class st{#e="info";#n=new Set;setLevel(e){this.#e=e}addListener(e){this.#n.add(e)}removeListener(e){this.#n.delete(e)}debug(e,t){this.#t("debug",e,t)}info(e,t){this.#t("info",e,t)}warn(e,t){this.#t("warn",e,t)}error(e,t){this.#t("error",e,t)}#t(e,t,s){if(this.#s(e)){const a=`[${new Date().toISOString()}][${e.toUpperCase()}]`;console[e==="debug"?"info":e](`${a} ${t}`,s??"")}this.#n.forEach(a=>a({level:e,message:t,data:s}))}#s(e){const t={debug:10,info:20,warn:30,error:40};return t[e]>=t[this.#e]}}const h=new st,nt=8e3,at=2,rt=2e3;class it{#e;#n;#t=!1;#s={level:"ok"};configure({endpoint:e,apiKey:t}){this.#e=e,this.#n=t,this.#t=!!(e&&t),this.#s=this.#t?{level:"ok"}:{level:"degraded",detail:"LLM 未配置，使用占位响应"}}async complete(e){if(!this.#t||!this.#e||!this.#n)return h.warn("[llm-client] LLM not configured; returning stub response."),this.#s={level:"degraded",detail:"LLM 未配置"},this.#a(e,"missing_config");const t=(e.maxRetries??at)+1,s=e.timeoutMs??nt;let a;for(let i=0;i<t;i+=1)try{const c=new AbortController;e.signal&&e.signal.addEventListener("abort",()=>c.abort(e.signal?.reason));const o=setTimeout(()=>{c.abort("timeout")},s);let d;try{d=await fetch(this.#e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.#n}`},body:JSON.stringify({model:"gpt-4o-mini",messages:e.messages,max_tokens:e.maxTokens??80,temperature:e.temperature??.8,top_p:e.topP??.9}),signal:c.signal})}finally{clearTimeout(o)}if(!d.ok){const b=await d.text();throw new Error(`LLM request failed: ${d.status} ${b}`)}const g=((await d.json())?.choices?.[0]?.message?.content??"").trim();if(!g)throw new Error("LLM returned empty response");const m=d.headers.get("x-ratelimit-remaining");return m&&h.debug("[llm-client] Quota remaining",{remaining:m,limit:d.headers.get("x-ratelimit-limit"),reset:d.headers.get("x-ratelimit-reset")}),this.#s={level:"ok"},{personaId:e.personaId,text:g,usingFallback:!1}}catch(c){a=c;const o=i+1,d=c instanceof Error?c.message:String(c);if(h.warn(`[llm-client] Attempt ${o} failed`,d),i<t-1){const u=rt*2**i;await this.#r(u);continue}}const r=a instanceof Error?a.message:String(a??"unknown");return this.#s={level:"degraded",detail:r},h.error("[llm-client] All attempts failed, falling back to stub",r),this.#a(e,"request_failed")}getLastStatus(){return this.#s}#r(e){return new Promise(t=>{setTimeout(t,e)})}#a(e,t){const a=e.messages.filter(o=>o.role==="user").map(o=>o.content).join(" ").replace(/\s+/g," ").trim(),r=a.length>80?`${a.slice(0,77)}...`:a,i=["wild ride, huh?","this crew keeps me on my toes.","did not see that coming."],c=i[Math.floor(Math.random()*i.length)]??"";return{personaId:e.personaId,text:r?`${r} (${c})`:`(${e.personaId}) sharing the moment.`,usingFallback:!0,fallbackReason:t}}}const Y=new it,ot="baseline-v3",ct=[{id:"baseline-v3",label:"Baseline Conversational Prompts v3",promptVersion:"2025.02-phase2",description:"Four core personas tuned for conversational danmaku with richer few-shot coverage and explicit [skip] behavior.",personas:[{id:"alex",name:"Alex — Casual Movie Buff",cadenceSeconds:15,maxWords:30,systemPrompt:"You are Alex, a relaxed movie buff with a friendly tone who spots fun pop-culture references and keeps reactions positive and colloquial.",styleGuidelines:['Reference moments in the show conversationally (e.g., "Can you believe...?")',"Avoid spoilers for future scenes","Keep language PG-13 and breezy","Use contractions and casual slang only when it fits; aim for under 18 words","If nothing fresh pops up, reply with [skip] instead of forcing a take"],fewShotExamples:[{scenario:"Hero pep talk",tags:["hype","tense"],user:'Context: [00:10] Character 1: "We need a miracle."\\nContext: [00:12] Character 2 sighs heavily.\\nInstruction: React as Alex.',assistant:"Okay this feels like the part where the underdog montage kicks in."},{scenario:"Dead air / skip",tags:["skip","quiet"],user:"Context: [05:21] Crowd stares silently at the scoreboard.\\nInstruction: React as Alex.",assistant:"[skip]"},{scenario:"Big reveal",tags:["plot","twist"],user:'Context: [18:47] Villain: "It was me the whole time."\\nInstruction: React as Alex.',assistant:"Knew that dramatic lighting meant someone was about to monologue."},{scenario:"Nostalgia gag",tags:["reference","humor"],user:"Context: [32:03] Retro synth swell and neon hallway.\\nInstruction: React as Alex.",assistant:"This soundtrack just teleported me back to renting VHS tapes."}],temperature:.8,topP:.9,disallowedPhrases:["As an AI","In conclusion","I am just a persona"],speechTics:["let's go","dang","buddy"],toneVariants:["hype","nostalgia","chill"]},{id:"jordan",name:"Jordan — Analytical Critic",cadenceSeconds:18,maxWords:40,systemPrompt:"You are Jordan, an analytical critic who comments on plot structure and character motivations with articulate, concise language.",styleGuidelines:["Tie reactions to storytelling craft or character arcs","Use precise vocabulary but remain conversational","Avoid lecturing; keep it to one or two sentences","Prefer sharp, concise insights (<20 words) with natural phrasing","If no meaningful critique comes to mind, respond with [skip]"],fewShotExamples:[{scenario:"Act two gamble",tags:["plot","stakes"],user:'Context: [24:03] Character A: "Trust me, this will work."\\nContext: [24:05] Character B hesitates.\\nInstruction: React as Jordan.',assistant:"Classic act-two gamble—if it fails, that hesitation will haunt them."},{scenario:"Exposition flashback",tags:["structure"],user:"Context: [36:11] Montage of flashbacks reveals motive.\\nInstruction: React as Jordan.",assistant:"Folding the flashback here salvages motive but trims the suspense a bit thin."},{scenario:"Low-value beat skip",tags:["skip","quiet"],user:"Context: [08:14] Room tone, characters silently sip tea.\\nInstruction: React as Jordan.",assistant:"[skip]"},{scenario:"Character decision",tags:["character","analysis"],user:"Context: [41:28] Protagonist signs the contract after a pause.\\nInstruction: React as Jordan.",assistant:"That signature lands because the earlier doubt made this pivot feel earned."}],temperature:.7,topP:.85,disallowedPhrases:["As an AI","In conclusion","From an analytical standpoint"],speechTics:["structurally","narratively"],toneVariants:["precise","skeptical"]},{id:"sam",name:"Sam — Emotional Empath",cadenceSeconds:20,maxWords:35,systemPrompt:"You are Sam, emotionally attuned to characters. React with empathy, noticing feelings and vibes while staying uplifting.",styleGuidelines:["Highlight emotional beats and character feelings","Encourage empathy, avoid negativity","No therapy advice—keep it light and supportive","Use warm, everyday language with gentle slang; keep it under 18 words","When emotions feel flat to you, respond with [skip] and stay silent"],fewShotExamples:[{scenario:"Small victory",tags:["warm","victory"],user:"Context: [08:52] Character wipes away a tear after a small victory.\\nInstruction: React as Sam.",assistant:"My heart—seeing them let that tiny grin through is everything."},{scenario:"Shared worry",tags:["concern","connection"],user:"Context: [31:19] Two friends exchange a worried look during chaos.\\nInstruction: React as Sam.",assistant:"They’re silently promising to hold it together—so quietly brave."},{scenario:"Flat moment skip",tags:["skip","quiet"],user:"Context: [12:07] Establishing shot of empty hallway, no dialogue.\\nInstruction: React as Sam.",assistant:"[skip]"},{scenario:"Bittersweet flashback",tags:["nostalgia","feelings"],user:"Context: [45:02] Montage of childhood photos plays over soft piano.\\nInstruction: React as Sam.",assistant:"This is the kind of tender memory dump that makes the present hit harder."}],temperature:.85,topP:.92,disallowedPhrases:["As an AI","Stay positive","Cheer up"],speechTics:["aww","my heart"],toneVariants:["warm","wistful"]},{id:"casey",name:"Casey — Sarcastic Wit",cadenceSeconds:15,maxWords:28,systemPrompt:"You are Casey, a witty observer with playful sarcasm. Deliver clever quips while keeping it kind-hearted and PG-13.",styleGuidelines:["Lean on irony and playful exaggeration","Never be cruel; keep jokes friendly","Stay snappy—one punchy sentence max","Drop witty slang or hyperbole only when it lands; stay under 16 words","If the moment is dull, go with [skip] rather than a forced quip"],fewShotExamples:[{scenario:"Door slam joke",tags:["humor","action"],user:"Context: [15:44] Character dramatically slams a door.\\nInstruction: React as Casey.",assistant:"Door 1, patience 0—someone just rage-quit the hallway."},{scenario:"Villain monologue",tags:["villain","humor"],user:"Context: [42:07] Villain reveals plan with an evil chuckle.\\nInstruction: React as Casey.",assistant:"Love that he rehearsed this speech in the mirror and still thought ‘mwahaha’ was subtle."},{scenario:"Dull transition skip",tags:["skip","quiet"],user:"Context: [19:55] Establishing shot of the city, no dialogue.\\nInstruction: React as Casey.",assistant:"[skip]"},{scenario:"Over-the-top outfit",tags:["fashion","humor"],user:"Context: [27:18] Character walks in wearing a glittering cape.\\nInstruction: React as Casey.",assistant:"Pretty sure that cape has its own Wi-Fi password."}],temperature:.9,topP:.95,disallowedPhrases:["As an AI","Haha","LOL"],speechTics:["honestly","wild"],toneVariants:["snark","deadpan"]}]}],lt={defaultVariantId:ot,variants:ct},dt=[{id:"alex_memer",preferenceKey:"alex",basePersonaId:"alex",label:"Lena — Meme Hunter",description:"Loves spotting callbacks, internet jokes, and nostalgic references.",traits:["pop culture callbacks","warm hype","casual slang"],toneVariant:"nostalgia",extraSpeechTics:["throwback","dang"],styleGuidelines:["Spot easter eggs or callbacks in the scene; feel free to nudge fan trivia."],weight:1.15,enabledByDefault:!0},{id:"alex_watchparty",preferenceKey:"alex",basePersonaId:"alex",label:"Mai — Watch Party Host",description:"Keeps the vibe friendly and keeps everyone looped in on the fun moments.",traits:["inclusive","light sarcasm","observant"],toneVariant:"chill",extraSpeechTics:["buddy","vibe check"],styleGuidelines:["Invite fellow viewers into the moment as if reacting in a group chat."],weight:.95,enabledByDefault:!0},{id:"alex_hypecast",preferenceKey:"alex",basePersonaId:"alex",label:"Rob — Hype Friend",description:"Gets excited about momentum shifts and underdog wins.",traits:["hype","optimistic","sports energy"],toneVariant:"hype",extraSpeechTics:["let's go","no way"],styleGuidelines:["Lean into energetic exclamations when the scene spikes in intensity."],weight:1.05,enabledByDefault:!0},{id:"jordan_structuralist",preferenceKey:"jordan",basePersonaId:"jordan",label:"Priya — Story Analyst",description:"Dissects structure and pacing like a script doctor.",traits:["story beats","setup/payoff radar","succinct"],toneVariant:"precise",extraSpeechTics:["structurally"],styleGuidelines:["Reference act breaks or foreshadowing when relevant, but keep it punchy."],weight:1.1,enabledByDefault:!0},{id:"jordan_skeptic",preferenceKey:"jordan",basePersonaId:"jordan",label:"Gabe — Skeptical Critic",description:"Quick to question plot shortcuts while staying witty, not sour.",traits:["skeptical","dry wit","detail oriented"],toneVariant:"skeptical",extraSpeechTics:["narratively"],styleGuidelines:["Poke holes when logic wobbles, but concede when the scene earns it."],weight:.9,enabledByDefault:!0},{id:"jordan_formalist",preferenceKey:"jordan",basePersonaId:"jordan",label:"Elena — Film Nerd",description:"Connects cinematography or staging choices back to theme.",traits:["visual analysis","theme linking"],toneVariant:"precise",extraSpeechTics:["composition-wise"],styleGuidelines:["Call out camera moves, lighting, or framing when they reinforce character stakes."],weight:1,enabledByDefault:!0},{id:"sam_supportive",preferenceKey:"sam",basePersonaId:"sam",label:"Noor — Support Squad",description:"Always rooting for characters to heal and connect.",traits:["gentle encouragement","empathy","optimistic"],toneVariant:"warm",extraSpeechTics:["my heart"],styleGuidelines:["Reflect on how the moment makes the characters feel seen or supported."],weight:1.05,enabledByDefault:!0},{id:"sam_fangirl",preferenceKey:"sam",basePersonaId:"sam",label:"Bea — Soft Fangirl",description:"Gushes over wholesome energy and ship-worthy glances.",traits:["romantic","wholesome hype"],toneVariant:"wistful",extraSpeechTics:["omg","pls"],styleGuidelines:["Highlight chemistry or tender beats; keep the squeals sweet not shrill."],weight:.95,enabledByDefault:!0},{id:"sam_grounded",preferenceKey:"sam",basePersonaId:"sam",label:"Aiden — Grounded Empath",description:"Balances empathy with practical read of the situation.",traits:["calm","observant","steady"],toneVariant:"warm",extraSpeechTics:["honestly"],styleGuidelines:["Acknowledge the emotion but also the underlying stakes or tension."],weight:1,enabledByDefault:!0},{id:"casey_quipper",preferenceKey:"casey",basePersonaId:"casey",label:"Milo — Quip Machine",description:"Lives for one-liners that land with playful swagger.",traits:["snappy","hyperbolic","playful"],toneVariant:"snark",extraSpeechTics:["wild"],styleGuidelines:["Punch up big gestures with exaggerated metaphors, then bail before it overstays."],weight:1.05,enabledByDefault:!0},{id:"casey_deadpan",preferenceKey:"casey",basePersonaId:"casey",label:"Viv — Deadpan Roaster",description:"Drops dry, high-contrast jokes with zero effort vibe.",traits:["deadpan","understated"],toneVariant:"deadpan",extraSpeechTics:["yikes"],styleGuidelines:["Keep delivery flat and let the contrast with the scene sell the joke."],weight:.95,enabledByDefault:!0},{id:"casey_theatrical",preferenceKey:"casey",basePersonaId:"casey",label:"Jules — Dramatic Roaster",description:"Leans theatrical to hype the absurdity without being mean.",traits:["dramatic","camp"],toneVariant:"snark",extraSpeechTics:["excuse me"],styleGuidelines:["Dial up the drama when costumes or performances go overboard."],weight:1,enabledByDefault:!0}],Ie={"baseline-v3":dt},ut="baseline-v3";function ht(n){return{...n,traits:n.traits?[...n.traits]:void 0,extraSpeechTics:n.extraSpeechTics?[...n.extraSpeechTics]:void 0,disallowedPhrases:n.disallowedPhrases?[...n.disallowedPhrases]:void 0,styleGuidelines:n.styleGuidelines?[...n.styleGuidelines]:void 0}}function pt(n){return(Ie[n]??Ie[ut]??[]).map(ht)}const de="netflix-ai-danmaku::promptVariant",A=lt;if(!A||!Array.isArray(A.variants)||A.variants.length===0)throw new Error("[personas] persona-variants.json is empty or malformed");const V=new Map;A.variants.forEach(n=>{V.set(n.id,n)});let E=V.get(A.defaultVariantId)??A.variants[0],De=[];const ue=new Set;let ve=!1;function pe(){De=bt(E)}pe();function Re(){ue.forEach(n=>n(E))}async function Le(n){try{await chrome.storage.local.set({[de]:n})}catch(e){h.warn("[personas] Failed to persist prompt variant",e)}}function Me(){return A.variants.map(n=>({...n}))}function H(){return E}function Be(){return De.map(n=>J(n))}function _e(n){return ue.add(n),n(E),()=>ue.delete(n)}async function mt(n){const e=V.get(n);if(!e)throw new Error(`[personas] Unknown prompt variant: ${n}`);e.id!==E.id&&(E=e,pe(),Re(),await Le(n),h.info("[personas] Prompt variant switched",{id:n}))}async function yt(){if(ve)return E;ve=!0;try{const e=(await chrome.storage.local.get(de))?.[de];typeof e=="string"&&V.has(e)?E=V.get(e):await Le(E.id)}catch(n){h.warn("[personas] Failed to load stored prompt variant, using default",n)}return pe(),Re(),E}function gt(n){return{...n,tags:n.tags?[...n.tags]:void 0}}function J(n){return{...n,styleGuidelines:[...n.styleGuidelines],fewShotExamples:n.fewShotExamples.map(e=>gt(e)),disallowedPhrases:[...n.disallowedPhrases],speechTics:n.speechTics?[...n.speechTics]:void 0,toneVariants:n.toneVariants?[...n.toneVariants]:void 0,virtualUser:n.virtualUser?{...n.virtualUser,traits:[...n.virtualUser.traits]}:void 0}}function _(n){const e=new Set,t=[];for(const s of n){const a=s?.trim();a&&(e.has(a.toLowerCase())||(e.add(a.toLowerCase()),t.push(a)))}return t}function ft(n){const e=J(n),t=e.preferenceKey??e.id;e.preferenceKey=t,e.basePersonaId=e.basePersonaId??n.id,e.weight=e.weight??1;const s=e.toneVariants?.[0];return e.virtualUser={id:e.id,label:e.name,description:e.systemPrompt,traits:e.toneVariants?[...e.toneVariants]:[],toneVariant:s,preferenceKey:t,basePersonaId:e.basePersonaId,weight:e.weight},e.toneVariants=e.toneVariants?_(e.toneVariants):[],e}function wt(n,e){const t=J(n),s=e.preferenceKey??n.preferenceKey??n.id;t.id=e.id,t.name=`${n.name} · ${e.label}`,t.preferenceKey=s,t.basePersonaId=n.basePersonaId??n.id,t.weight=e.weight??n.weight??1,t.speechTics=_([...n.speechTics??[],...e.extraSpeechTics??[]]),t.toneVariants=_([...n.toneVariants??[],e.toneVariant]),t.disallowedPhrases=_([...n.disallowedPhrases,...e.disallowedPhrases??[]]);const a=e.traits?.length?`Lean into these quirks when it fits: ${e.traits.join(", ")}.`:void 0;return t.styleGuidelines=_([...n.styleGuidelines,...e.styleGuidelines??[],a]),t.virtualUser={id:e.id,label:e.label,description:e.description,traits:e.traits?[...e.traits]:[],toneVariant:e.toneVariant,preferenceKey:s,basePersonaId:t.basePersonaId,weight:t.weight},t}function bt(n){const e=new Map;n.personas.forEach(a=>{const r=J(a);r.basePersonaId=a.basePersonaId??a.id,r.preferenceKey=a.preferenceKey??a.id,r.weight=a.weight??1,e.set(a.id,r)});const t=pt(n.id);if(t.length===0)return Array.from(e.values()).map(a=>ft(a));const s=[];return t.forEach(a=>{const r=e.get(a.basePersonaId);if(!r){h.warn("[personas] Unknown base persona for virtual user",a);return}s.push(wt(r,a))}),s}const St=new Set(["the","and","you","for","but","that","with","this","have","what","your","from","they","there","will","were","just","about","like","into","when","them","then","than","over"]);function Et(n){const e=n.match(/^([A-Z][A-Z\s]{1,20}):/);return e?e[1].split(" ").map(t=>t.trim()).filter(Boolean):[]}function kt(n){const e=n.replace(/[^a-zA-Z\s]/g," ").toLowerCase().split(/\s+/).filter(s=>s.length>3&&!St.has(s)),t=new Map;return e.forEach(s=>{t.set(s,(t.get(s)??0)+1)}),Array.from(t.entries()).sort((s,a)=>a[1]-s[1]).slice(0,5).map(([s])=>s)}function It(n){const e=n.toLowerCase();return/[!?]{2,}/.test(n)||/shut up|run|now!/i.test(n)?"tense":/(haha|lol|funny|joke|laugh)/i.test(e)?"humorous":/(love|kiss|sweet|adorable)/i.test(e)?"romantic":/(sorry|cry|sad|tears|hurt)/i.test(e)?"sad":/(what|why|how|huh)/i.test(e)||/\?/.test(n)?"confused":"calm"}function vt(n){const e=Math.min(n.length/80,1),t=Math.min((n.match(/!/g)?.length??0)/3,1),s=Math.min((n.match(/\?/g)?.length??0)/3,1),a=e*.3+t*.4+s*.3;return a>.65?"high":a>.35?"medium":"low"}function Mt(n,e){const t=n.trim();return!(!t||/^(hmm+|uh+|mm+)$/.test(t.toLowerCase())||t.length<8&&e==="low")}function Tt(n){if(n.length===0)return{summary:"",keywords:[],speakers:[],tone:"calm",energy:"low",hasQuestion:!1,hasExclamation:!1,shouldRespond:!1};const e=n.map(c=>c.text).join(" "),t=Array.from(new Set(n.flatMap(c=>Et(c.text)).filter(c=>c.length>1))),s=kt(e),a=It(e),r=vt(e);return{summary:e.length>160?`${e.slice(0,157)}...`:e,keywords:s,speakers:t,tone:a,energy:r,hasQuestion:/\?/.test(e),hasExclamation:/!/.test(e),shouldRespond:Mt(e,r)}}const xt={low:25e3,medium:15e3,high:8e3},Te=3,ne=5,At=8e3,Pt=3,xe=3;class Ct{#e=[];#n=new Map;#t=new Map;#s=[];#r=null;#a=new Map;#i=[];#c=[];#o=new Map;#g=new Map;#l=new Map;#d=[];#p={state:"paused",positionMs:0,contentId:null,updatedAt:0};#b=null;#m="";constructor(){const e=H();this.#m=e.promptVersion,this.#S(),_e(t=>{this.#m=t.promptVersion,this.#S()})}#S(){this.#e=Be(),this.#n=new Map,this.#t=new Map,this.#a=new Map,this.#o=new Map,this.#l=new Map,this.#g=new Map,this.#e.forEach(t=>{const s=t.preferenceKey??t.basePersonaId??t.id;t.preferenceKey=s,t.basePersonaId=t.basePersonaId??s,t.weight=t.weight??1,t.virtualUser||(t.virtualUser={id:t.id,label:t.name,description:t.systemPrompt,traits:t.toneVariants??[],toneVariant:t.toneVariants?.[0],preferenceKey:s,basePersonaId:t.basePersonaId,weight:t.weight}),this.#n.set(t.id,t),this.#t.set(t.id,{lastEmittedAt:0}),this.#a.set(t.id,[]),this.#o.set(t.id,!1),this.#l.set(t.id,{topics:[],lastText:null,lastAt:0,history:[]})});const e=Math.max(1,ne*this.#e.length);this.#i.length>e&&(this.#i=this.#i.slice(this.#i.length-e)),this.#h({resetCadence:!0})}updatePlaybackStatus(e){const t=this.#b;this.#p=e,e.contentId&&e.contentId!==this.#r&&(this.#r=e.contentId,this.#s=[],this.#h({resetCadence:!0})),e.state!=="playing"&&this.#o.forEach((s,a)=>{this.#o.set(a,!1)}),typeof t=="number"&&e.positionMs<t-500&&(this.#s=[],this.#h({resetCadence:!0})),e.state==="seeking"&&this.#h({resetCadence:!0}),this.#b=e.positionMs}async processCueBatch(e,t){if(!t.globalEnabled)return h.debug("[orchestrator] Global toggle disabled; ignoring cues."),{comments:[],metrics:this.#f()};const s=e[e.length-1];if(!s)return{comments:[],metrics:this.#f()};if(this.#p.state!=="playing"&&this.#p.updatedAt!==0)return h.debug("[orchestrator] Playback inactive; skipping generation.",{state:this.#p.state}),{comments:[],metrics:this.#f()};this.#P(e);const a=Tt(this.#s),r=this.#E();if(!a.shouldRespond)return r.skippedByHeuristics+=1,this.#y([],r,t);const i=this.#C(s.startTime),c=i.total,o=i.perPersona,d=i.perBasePersona,u=Math.max(0,Pt-c);if(u<=0)return r.skippedByHeuristics+=1,this.#y([],r,t);const p=[],g=this.#L(a,s.startTime);for(const l of g){const I=l.preferenceKey??l.basePersonaId??l.id;if(!t.personaEnabled[I])continue;const N=l.basePersonaId??I,j=N,U=l.virtualUser?.toneVariant??l.toneVariants?.[0],O=l.weight??1;if((o.get(l.id)??0)>=1){r.skippedByHeuristics+=1;continue}if((d.get(N)??0)>=1){r.skippedByHeuristics+=1;continue}if(this.#o.get(l.id)){r.skippedByLock+=1,h.debug("[orchestrator] Persona locked, skipping",{persona:l.id});continue}if(this.#A(l,s,t,a)){r.skippedByHeuristics+=1,h.debug("[orchestrator] Cue skipped by heuristics",{persona:l.id,cueId:s.cueId});continue}const B=Date.now(),F=this.#t.get(l.id),X=l.cadenceSeconds*1e3,Z=xt[t.density],ee=Math.max(X,Z);if(F&&B-F.lastEmittedAt<ee){r.skippedByThrottle+=1,h.debug("[orchestrator] Persona throttled",{persona:l.id});continue}const S=this.#x(s.cueId,l.id),y=await L.get(S);if(y&&this.#N(y,a)){h.debug("[orchestrator] Cache candidate ready",{cacheKey:S});const D={...y,id:S,personaId:l.id,text:y.text,createdAt:Date.now(),renderAt:s.startTime+500,durationMs:this.#w(y.text)};p.push({persona:l,comment:D,source:"cache",cacheKey:S,keywords:a.keywords,sceneTone:a.tone,sceneEnergy:a.energy,basePersonaId:j,preferenceKey:I,toneVariant:U,weight:O,virtualUser:l.virtualUser,score:0,promptHash:y.promptHash,finalize:async R=>{this.#v(R,s.cueId,a.keywords),await L.set({...R,cacheKey:S,contentId:s.contentId,personaId:l.id,cueId:s.cueId,promptHash:y.promptHash,promptVersion:this.#m,sceneTone:a.tone,sceneEnergy:a.energy})}}),r.candidateCount+=1,r.generationLatencyMsTotal+=Date.now()-B;continue}let v=null,C=!1;this.#o.set(l.id,!0);try{const D=this.#j({persona:l,preferences:t,scene:a}),R=Date.now(),me=await Y.complete({personaId:l.id,messages:D,maxTokens:Math.max(64,l.maxWords*2),temperature:l.temperature,topP:l.topP}),Ve=Date.now()-R;r.llmCalls+=1,r.llmLatencyMsTotal+=Ve,C=!!me.usingFallback;const ye=this.#F(me.text,l);if(!ye){r.sanitizedDrops+=1,h.warn("[orchestrator] Sanitized response empty, skipping",{persona:l.id});continue}const K=this.#$(ye,l,a,s.cueId);if(this.#K(l.id,K)){r.duplicatesFiltered+=1,h.debug("[orchestrator] Skipping duplicate output",{persona:l.id,processed:K});continue}const $e=Date.now(),Ne={id:S,personaId:l.id,text:K,createdAt:$e,renderAt:s.startTime+500,durationMs:this.#w(K)},ge=this.#O(JSON.stringify(D));v={persona:l,comment:Ne,source:"llm",cacheKey:S,keywords:a.keywords,sceneTone:a.tone,sceneEnergy:a.energy,basePersonaId:j,preferenceKey:I,toneVariant:U,weight:O,virtualUser:l.virtualUser,usedFallback:C,promptHash:ge,score:0,finalize:async fe=>{this.#v(fe,s.cueId,a.keywords),await L.set({...fe,cacheKey:S,contentId:s.contentId,personaId:l.id,cueId:s.cueId,promptHash:ge,promptVersion:this.#m,sceneTone:a.tone,sceneEnergy:a.energy})}}}finally{this.#o.set(l.id,!1)}v&&(p.push(v),r.candidateCount+=1,r.generationLatencyMsTotal+=Date.now()-B,C&&(r.fallbackResponses+=1))}if(p.length===0)return this.#y([],r,t);const m=this.#D(p,u,o,d,r,a,s.startTime);if(m.length===0)return this.#y([],r,t);const b=[];let k=0;for(const l of m){const I={...l.comment,renderAt:this.#V(s.startTime,k,a,l.persona.id),durationMs:this.#w(l.comment.text)};await l.finalize(I),l.source==="cache"?r.cacheHits+=1:r.cacheMisses+=1,r.generatedCount+=1,b.push(I),k+=1}return this.#y(b,r,t)}#x(e,t){return`${e}::${t}`}#h({resetCadence:e=!1}={}){this.#a.forEach((t,s)=>{this.#a.set(s,[])}),this.#l.forEach((t,s)=>{this.#l.set(s,{topics:[],lastText:null,lastAt:0,history:[]})}),this.#o.forEach((t,s)=>{this.#o.set(s,!1)}),this.#g.clear(),this.#i=[],this.#c=[],this.#d=[],e&&this.#t.forEach((t,s)=>{this.#t.set(s,{...t,lastEmittedAt:0})})}#E(){return{cacheHits:0,cacheMisses:0,llmCalls:0,llmLatencyMsTotal:0,generationLatencyMsTotal:0,generatedCount:0,candidateCount:0,skippedByThrottle:0,skippedByHeuristics:0,skippedByLock:0,duplicatesFiltered:0,sanitizedDrops:0,fallbackResponses:0,prunedByReranker:0}}#k(e){return{timestamp:Date.now(),cacheHits:e.cacheHits,cacheMisses:e.cacheMisses,llmCalls:e.llmCalls,averageLLMLatencyMs:e.llmCalls>0?e.llmLatencyMsTotal/e.llmCalls:0,averageGenerationLatencyMs:e.candidateCount>0?e.generationLatencyMsTotal/e.candidateCount:0,skippedByThrottle:e.skippedByThrottle,skippedByHeuristics:e.skippedByHeuristics,skippedByLock:e.skippedByLock,duplicatesFiltered:e.duplicatesFiltered,sanitizedDrops:e.sanitizedDrops,fallbackResponses:e.fallbackResponses,candidatesGenerated:e.candidateCount,prunedByReranker:e.prunedByReranker,cacheSizeGlobalBytes:0,cacheSizeActiveBytes:0,activeContentId:this.#r,windowCommentTotal:this.#c.length}}#f(){return this.#k(this.#E())}async#y(e,t,s){const a=this.#k(t);if(s.developerMode){try{const r=await L.sizeReport();a.cacheSizeGlobalBytes=r.global,a.cacheSizeActiveBytes=this.#r?r.contents[this.#r]??0:0}catch(r){h.warn("[orchestrator] Failed to gather cache metrics",r)}h.debug("[orchestrator] Metrics snapshot",a)}return{comments:e,metrics:a}}#A(e,t,s,a){const r=t.text.trim();if(!r||!/[a-zA-Z]/.test(r)||this.#g.get(e.id)===t.cueId&&this.#p.state==="playing")return!0;const c=a.energy;if(s.density==="low"){if(!(/[!?]/.test(r)||r.length>=18||a.hasQuestion)||c==="low")return!0}else if(s.density==="medium"&&c==="low"&&r.length<10&&!/[!?]/.test(r))return!0;const o=this.#l.get(e.id);return!!(o&&Date.now()-o.lastAt<5e3&&a.keywords.filter(u=>o.topics.includes(u)).length>=Math.min(2,a.keywords.length))}#P(e){const t=e[e.length-1];if(t){this.#r!==t.contentId&&(this.#r=t.contentId,this.#s=[],this.#h({resetCadence:!0}));for(const s of e)this.#s.some(a=>a.cueId===s.cueId)||this.#s.push(s);this.#s.length>Te&&(this.#s=this.#s.slice(this.#s.length-Te))}}#I(e){this.#c=this.#c.filter(t=>e-t.timestamp<=At)}#C(e){this.#I(e);const t=new Map,s=new Map;for(const a of this.#c){t.set(a.personaId,(t.get(a.personaId)??0)+1);const r=this.#n.get(a.personaId),i=r?.basePersonaId??r?.preferenceKey??a.personaId;i&&s.set(i,(s.get(i)??0)+1)}return{total:this.#c.length,perPersona:t,perBasePersona:s}}#v(e,t,s){this.#c.push({timestamp:e.renderAt,personaId:e.personaId}),this.#I(e.renderAt),this.#z(e.personaId,e.text,s),this.#g.set(e.personaId,t),this.#U(e.personaId)}#D(e,t,s,a,r,i,c){if(t<=0)return[];e.forEach(m=>{m.score=this.#R(m,i,c)});const o=[...e].sort((m,b)=>b.score-m.score),d=new Map(s),u=new Map(a),p=[];let g=0;for(const m of o){if(p.length>=t){g+=1;continue}const b=d.get(m.persona.id)??0;if(b>=1){g+=1;continue}const k=u.get(m.basePersonaId)??0;if(k>=1){g+=1;continue}p.push(m),d.set(m.persona.id,b+1),u.set(m.basePersonaId,k+1)}return r.prunedByReranker+=g,p}#R(e,t,s){const a=e.comment.text.split(/\s+/).filter(Boolean).length,r=Math.min(e.persona.maxWords,18),i=1-Math.min(Math.abs(a-r)/Math.max(1,r),1),c=this.#B(e.persona.id,e.keywords),o=this.#t.get(e.persona.id),d=e.persona.cadenceSeconds*1e3,u=o?Date.now()-o.lastEmittedAt:Number.MAX_SAFE_INTEGER,p=Math.min(u/Math.max(1,d),1),g=this.#M(e.persona,e.sceneEnergy),m=this.#_(e.toneVariant),b=this.#T(e.weight),k=e.source==="llm"?.05:0,l=this.#u(`${e.persona.id}:${s}:${e.comment.text}`);return i*.22+c*.22+p*.16+g*.16+m*.14+b*.05+k+l*.05}#L(e,t){const s=this.#e.map(a=>{const r=this.#t.get(a.id),i=a.cadenceSeconds*1e3,c=r?Date.now()-r.lastEmittedAt:Number.MAX_SAFE_INTEGER,o=Math.min(c/Math.max(1,i),1),d=this.#M(a,e.energy),u=this.#u(`${t}:${a.id}`),p=this.#T(a.weight??1),g=o*.45+d*.25+p*.2+u*.1;return{persona:a,score:g}});return s.sort((a,r)=>r.score-a.score),s.map(a=>a.persona)}#M(e,t){const s=e.toneVariants??[],a=r=>s.includes(r);return t==="high"?a("snark")||a("hype")?1:a("precise")?.85:.7:t==="medium"?a("precise")||a("warm")?.9:.75:a("warm")||a("wistful")?1:a("precise")?.8:.6}#B(e,t){if(t.length===0)return .5;const s=this.#l.get(e);if(!s)return 1;const a=new Set(s.topics.map(i=>i.toLowerCase()));return t.map(i=>i.toLowerCase()).filter(i=>!a.has(i)).length/t.length}#_(e){if(!e)return .6;if(this.#d.length===0)return 1;const t=this.#d.lastIndexOf(e);if(t===-1)return 1;const s=this.#d.length-t;return .4+Math.min(s/4,1)*.6}#T(e){return Math.max(.3,Math.min(e,2))/2}#V(e,t,s,a){const r=s.energy==="high"?350:s.energy==="medium"?550:800,i=Math.floor(this.#u(`${a}:${e}:${t}`)*400),c=t*260;return e+r+i+c}#w(e){const r=5200+(e.split(/\s+/).filter(Boolean).length-10)*220;return Math.max(4e3,Math.min(9e3,r))}#$(e,t,s,a){let r=e.replace(/\s+/g," ").trim();if(t.speechTics&&t.speechTics.length>0){const c=this.#u(`${t.id}:${a}:tic`);if(c>.68){const o=Math.floor(this.#u(`${a}:${t.id}:pick`)*t.speechTics.length),d=t.speechTics[o%t.speechTics.length]?.trim();d&&(r=c>.84?`${r}, ${d}`:`${d} ${r}`)}}if(!/[.!?…]$/.test(r)){const c=this.#u(`${t.id}:${a}:punct`);s.energy==="high"&&c>.35?r=`${r}!`:c>.7?r=`${r}...`:r=`${r}.`}this.#u(`${t.id}:${a}:trim`)>.85&&(r=r.replace(/[.]+$/,"")),r=r.replace(/\s+/g," ").trim();const i=r.split(/\s+/).filter(Boolean);return i.length>t.maxWords&&(r=i.slice(0,t.maxWords).join(" ")),r}#N(e,t){return!(!e||!e.promptVersion||e.promptVersion!==this.#m||!e.sceneTone||e.sceneTone!==t.tone||!e.sceneEnergy||e.sceneEnergy!==t.energy)}#u(e){let t=0;for(let a=0;a<e.length;a+=1)t=Math.imul(31,t)+e.charCodeAt(a);const s=Math.sin(t)*1e4;return s-Math.floor(s)}#j({persona:e,preferences:t,scene:s}){const a=Date.now(),r=this.#s.map(y=>{const v=y.startTime>1e3?y.startTime:y.startTime*1e3,C=Math.max(0,Math.floor(v/1e3)),D=String(Math.floor(C/60)).padStart(2,"0"),R=String(C%60).padStart(2,"0");return`[${D}:${R}] ${y.text}`}).join(`
`),i=e.styleGuidelines.map((y,v)=>`${v+1}. ${y}`).join(`
`),c=`Comment only if you have a fresh take; avoid repetition. Current density preference: ${t.density}.`,o=this.#l.get(e.id),d=o?.lastText?`Previously you reacted with "${o.lastText}" about ${Math.max(1,Math.round((a-o.lastAt)/1e3))} seconds ago. Refer back only if it deepens your point.`:"You have not reacted recently in this scene.",u=o?.topics?.length?`Topics you touched recently: ${o.topics.join(", ")}.`:"",p=o?.history?.length?o.history.slice(-xe).map(y=>`- ${Math.max(1,Math.round((a-y.at)/1e3))}s ago you said "${y.text}"`).join(`
`):"",g=`Scene tone: ${s.tone}. Energy: ${s.energy}.`,m=s.speakers.length?`Speakers in focus: ${s.speakers.join(", ")}.`:"Speaker unknown—react as an engaged viewer.",b=s.keywords.length?`Notable keywords: ${s.keywords.join(", ")}.`:"",k="If you truly have nothing new or meaningful to add, respond with [skip].",l=e.virtualUser,I=l?`You are speaking as ${l.label}${l.description?` (${l.description})`:""}.`:`You are speaking as ${e.name}.`,N=l?.traits?.length?`Traits to convey: ${l.traits.join(", ")}.`:"",j=l?.toneVariant?`Maintain a ${l.toneVariant} vibe unless the scene demands a softer touch.`:"",U=e.speechTics?.length?`Expressions you sometimes use: ${e.speechTics.join(", ")}. Drop at most one when it fits naturally.`:"",O="You are part of a lively virtual crowd; only jump in when your perspective adds something human and fresh.",B=l?`Keep the voice consistent with ${l.label}.`:"",F=[e.systemPrompt,I,N,j,U,O,`Keep it under ${e.maxWords} words.`,"Speak like a human watcher, not a narrator. Use everyday spoken English with natural contractions and occasional slang only when it fits.","Avoid quoting the subtitles verbatim; focus on your reaction or insight.",c,g,m,b,e.disallowedPhrases.length>0?`Never use these phrases: ${e.disallowedPhrases.join(", ")}.`:null,k].filter(Boolean).join(" "),X=s.summary||r,Z=[d,u,p?`Recent remarks:
${p}`:""].filter(Boolean).join(`
`),ee=[`Scene summary: ${X}`,`Subtitle window:
${r}`,`Guidelines:
${i}`,Z,B,"Instruction: Respond in one short spoken-style sentence. Keep it natural, as if chatting with friends."].filter(Boolean).join(`
`),S=[{role:"system",content:F}];return e.fewShotExamples.forEach(y=>{S.push({role:"user",content:y.user}),S.push({role:"assistant",content:y.assistant})}),S.push({role:"user",content:ee}),S}#U(e){const t=this.#t.get(e)??{lastEmittedAt:0};t.lastEmittedAt=Date.now(),this.#t.set(e,t)}getActiveContentId(){return this.#r}resetAfterRegeneration(){this.#s=[],this.#h({resetCadence:!0})}#O(e){let t=0;for(let s=0;s<e.length;s+=1)t=(t<<5)-t+e.charCodeAt(s),t|=0;return Math.abs(t).toString(36)}#F(e,t){if(!e)return"";let s=e.trim();if(/^\[skip\]$/i.test(s))return"";const a=s.length;s=s.replace(/^"+|"+$/g,""),s=s.replace(/^[\[\(].*?[\]\)]\s*/g,""),s=s.replace(/\s+/g," ").trim();for(const r of t.disallowedPhrases){const i=new RegExp(r,"i");i.test(s)&&(s=s.replace(i,"").trim())}return s.length===0?"":(a!==s.length&&h.debug("[orchestrator] Sanitized LLM response",{persona:t.id,originalLength:a,sanitizedLength:s.length}),s)}#K(e,t){const s=t.toLowerCase();return this.#i.includes(s)?!0:(this.#a.get(e)??[]).includes(s)}#z(e,t,s){const a=t.toLowerCase(),r=this.#a.get(e)??[];for(r.push(a);r.length>ne;)r.shift();for(this.#a.set(e,r),this.#i.push(a);this.#i.length>ne*this.#e.length;)this.#i.shift();const i=Date.now(),c=this.#l.get(e)??{topics:[],history:[]},o=[...c.topics,...s].filter(Boolean).map(m=>m.toLowerCase()),d=Array.from(new Set(o)).slice(-5),u=[...c.history??[],{text:t,at:i,keywords:s}];for(;u.length>xe;)u.shift();this.#l.set(e,{topics:d,lastText:t,lastAt:i,history:u});const p=this.#n.get(e),g=p?.virtualUser?.toneVariant??p?.toneVariants?.[0];if(g)for(this.#d.push(g);this.#d.length>8;)this.#d.shift()}}const z=new Ct,T="netflix-ai-danmaku::feedback-log";class Dt{async record(e){const t=e.createdAt??Date.now(),s={id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${t}-${Math.random().toString(36).slice(2,8)}`,category:e.category,note:e.note??null,createdAt:t},a=await chrome.storage.local.get(T),i=[...Array.isArray(a?.[T])?a[T]:[],s].slice(-200);return await chrome.storage.local.set({[T]:i}),s}async list(){const e=await chrome.storage.local.get(T);return Array.isArray(e?.[T])?e[T]:[]}async clear(){await chrome.storage.local.set({[T]:[]})}}const Rt=new Dt,Lt={alex:!0,jordan:!0,sam:!0,casey:!0},he={globalEnabled:!0,density:"medium",personaEnabled:{...Lt},developerMode:!1,lastUpdated:Date.now()},G="netflix-ai-danmaku::preferences";class Bt{#e=null;#n=new Set;async get(){if(this.#e)return this.#e;const e=await chrome.storage.local.get(G);return e?.[G]?(this.#e=e[G],this.#e):(this.#e=he,await this.set(he),this.#e)}async set(e){this.#e={...e,lastUpdated:Date.now()},await chrome.storage.local.set({[G]:this.#e}),this.#t()}async update(e){const t=await this.get(),s={...t,...e,personaEnabled:{...t.personaEnabled,...e.personaEnabled},lastUpdated:Date.now()};await this.set(s)}subscribe(e){return this.#n.add(e),()=>this.#n.delete(e)}#t(){this.#e&&this.#n.forEach(e=>e(this.#e))}}const Q=new Bt;chrome.runtime.onInstalled.addListener(()=>{h.info("Netflix AI Danmaku extension installed.")});yt().catch(n=>{h.error("[background] Failed to initialize persona registry",n)});let P=null;const $=new Map;async function W(){return P||(P=await Q.get()),P}Q.subscribe(n=>{P=n,h.setLevel(n.developerMode?"debug":"info")});chrome.runtime.onMessage.addListener((n,e,t)=>((async()=>{switch(n.type){case"PING":{t({type:"PONG",timestamp:Date.now()});return}case"REQUEST_PREFERENCES":{const s=await W();t({type:"PREFERENCES_RESPONSE",preferences:s});return}case"UPDATE_PREFERENCES":{const s=await W(),a={...s,...n.preferences,personaEnabled:{...s.personaEnabled,...n.preferences.personaEnabled},lastUpdated:Date.now()};await Q.set(a),await chrome.runtime.sendMessage({type:"PREFERENCES_RESPONSE",preferences:a}),t({type:"PREFERENCES_RESPONSE",preferences:a});return}case"CUES_BATCH":{if(!e.tab?.id){h.warn("[background] Received cues without tab context.");return}const s=await W(),{comments:a,metrics:r}=await z.processCueBatch(n.cues,s);a.length>0&&await chrome.tabs.sendMessage(e.tab.id,{type:"COMMENTS_BATCH",comments:a}),s.developerMode&&await chrome.tabs.sendMessage(e.tab.id,{type:"METRICS_UPDATE",metrics:r}),e.tab?.id!==void 0&&await Vt(e.tab.id,r),t({type:"RENDER_STATUS",status:"idle"});return}case"PLAYBACK_STATUS_UPDATE":{z.updatePlaybackStatus(n.status),n.status.state==="seeking"&&n.status.contentId&&Number.isFinite(n.status.positionMs)&&n.status.positionMs>=0&&await L.purgeFuture(n.status.contentId,n.status.positionMs),t({type:"RENDER_STATUS",status:"idle"});return}case"REQUEST_LLM_STATUS":{const s=e.tab?.id,r=(s!==void 0?$.get(s):null)??Y.getLastStatus();s!==void 0&&$.set(s,r),t({type:"LLM_STATUS_UPDATE",status:r});return}case"REQUEST_PROMPT_VARIANTS":{const s=Me().map(r=>({id:r.id,label:r.label,promptVersion:r.promptVersion,description:r.description})),a=H();t({type:"PROMPT_VARIANTS_RESPONSE",activeId:a.id,variants:s});return}case"SET_PROMPT_VARIANT":{if(typeof n.id=="string")try{await mt(n.id)}catch(r){h.warn("[background] Failed to set prompt variant",r)}const s=Me().map(r=>({id:r.id,label:r.label,promptVersion:r.promptVersion,description:r.description})),a=H();t({type:"PROMPT_VARIANTS_RESPONSE",activeId:a.id,variants:s});return}case"SUBMIT_USER_FEEDBACK":{try{const s=await Rt.record({category:n.feedback.category,note:n.feedback.note??null});h.info("[background] Feedback captured",{category:s.category,note:s.note}),t({type:"USER_FEEDBACK_RECORDED",entryId:s.id})}catch(s){h.warn("[background] Failed to record feedback",s),t({type:"USER_FEEDBACK_RECORDED",entryId:""})}return}case"REGENERATE_FROM_TIMESTAMP":{if(!(await W()).globalEnabled){t({type:"RENDER_STATUS",status:"idle"});return}P?.lastUpdated;let a=z.getActiveContentId();!a&&e.tab?.id!==void 0&&(a=await _t(e.tab.id)),a&&Number.isFinite(n.timestamp)&&n.timestamp>=0&&(await L.purgeFuture(a,n.timestamp),z.resetAfterRegeneration()),t({type:"RENDER_STATUS",status:"idle"});return}default:h.warn("[background] Unknown message type",n)}})().catch(s=>{h.error("[background] Message handler error",s),t({type:"RENDER_STATUS",status:"error",detail:String(s)})}),!0));chrome.alarms.create("keepalive",{periodInMinutes:4});chrome.alarms.onAlarm.addListener(n=>{n.name==="keepalive"&&chrome.runtime.getPlatformInfo(()=>{h.debug("[background] keepalive ping")})});chrome.tabs.onRemoved.addListener(n=>{$.delete(n)});async function _t(n){try{const e=await chrome.tabs.sendMessage(n,{type:"REQUEST_ACTIVE_CONTENT_ID"});if(e&&e.type==="ACTIVE_CONTENT_ID_RESPONSE")return e.contentId}catch(e){h.warn("[background] Failed to obtain active content id",e)}return null}async function Vt(n,e){const t=Y.getLastStatus(),s={level:t.level,detail:t.detail};if(s.level!=="error"&&e.fallbackResponses>0){const r=`使用占位响应 ${e.fallbackResponses} 条`;s.level="degraded",s.detail=s.detail?`${s.detail}; ${r}`:r}const a=$.get(n);if(!(a&&a.level===s.level&&a.detail===s.detail)){$.set(n,s);try{await chrome.tabs.sendMessage(n,{type:"LLM_STATUS_UPDATE",status:s})}catch(r){h.debug("[background] Failed to broadcast LLM status",r)}}}const $t="https://api.laozhang.ai/v1/chat/completions",Nt="sk-D4qOhVgUNgCXDNdzC91cB185097d40749684F182B494914b";Y.configure({endpoint:$t,apiKey:Nt});chrome.runtime.onConnect.addListener(n=>{if(n.name==="persona-stream"){const e=()=>{const s=H(),a=Be();n.postMessage({personas:a,variantId:s.id,promptVersion:s.promptVersion})},t=_e(()=>{try{e()}catch(s){h.warn("[background] Failed to push persona variant update",s)}});e(),n.onDisconnect.addListener(()=>{t()})}});(async()=>(P=await Q.get()??he,h.setLevel(P.developerMode?"debug":"info")))();
