import{f as nt,a as st}from"./messages-BONoywxy.js";const be=(a,e)=>e.some(t=>a instanceof t);let Re,Le;function it(){return Re||(Re=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function at(){return Le||(Le=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Se=new WeakMap,ge=new WeakMap,le=new WeakMap;function ot(a){const e=new Promise((t,n)=>{const s=()=>{a.removeEventListener("success",i),a.removeEventListener("error",o)},i=()=>{t(_(a.result)),s()},o=()=>{n(a.error),s()};a.addEventListener("success",i),a.addEventListener("error",o)});return le.set(e,a),e}function rt(a){if(Se.has(a))return;const e=new Promise((t,n)=>{const s=()=>{a.removeEventListener("complete",i),a.removeEventListener("error",o),a.removeEventListener("abort",o)},i=()=>{t(),s()},o=()=>{n(a.error||new DOMException("AbortError","AbortError")),s()};a.addEventListener("complete",i),a.addEventListener("error",o),a.addEventListener("abort",o)});Se.set(a,e)}let ke={get(a,e,t){if(a instanceof IDBTransaction){if(e==="done")return Se.get(a);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return _(a[e])},set(a,e,t){return a[e]=t,!0},has(a,e){return a instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in a}};function Ge(a){ke=a(ke)}function ct(a){return at().includes(a)?function(...e){return a.apply(ve(this),e),_(this.request)}:function(...e){return _(a.apply(ve(this),e))}}function lt(a){return typeof a=="function"?ct(a):(a instanceof IDBTransaction&&rt(a),be(a,it())?new Proxy(a,ke):a)}function _(a){if(a instanceof IDBRequest)return ot(a);if(ge.has(a))return ge.get(a);const e=lt(a);return e!==a&&(ge.set(a,e),le.set(e,a)),e}const ve=a=>le.get(a);function Ee(a,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){const o=indexedDB.open(a,e),c=_(o);return n&&o.addEventListener("upgradeneeded",r=>{n(_(o.result),r.oldVersion,r.newVersion,_(o.transaction),r)}),t&&o.addEventListener("blocked",r=>t(r.oldVersion,r.newVersion,r)),c.then(r=>{i&&r.addEventListener("close",()=>i()),s&&r.addEventListener("versionchange",l=>s(l.oldVersion,l.newVersion,l))}).catch(()=>{}),c}const ht=["get","getKey","getAll","getAllKeys","count"],dt=["put","add","delete","clear"],ye=new Map;function De(a,e){if(!(a instanceof IDBDatabase&&!(e in a)&&typeof e=="string"))return;if(ye.get(e))return ye.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,s=dt.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||ht.includes(t)))return;const i=async function(o,...c){const r=this.transaction(o,s?"readwrite":"readonly");let l=r.store;return n&&(l=l.index(c.shift())),(await Promise.all([l[t](...c),s&&r.done]))[0]};return ye.set(e,i),i}Ge(a=>({...a,get:(e,t,n)=>De(e,t)||a.get(e,t,n),has:(e,t)=>!!De(e,t)||a.has(e,t)}));const ut=["continue","continuePrimaryKey","advance"],Pe={},Te=new WeakMap,qe=new WeakMap,mt={get(a,e){if(!ut.includes(e))return a[e];let t=Pe[e];return t||(t=Pe[e]=function(...n){Te.set(this,qe.get(this)[e](...n))}),t}};async function*pt(...a){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...a)),!e)return;e=e;const t=new Proxy(e,mt);for(qe.set(t,e),le.set(t,ve(e));e;)yield t,e=await(Te.get(t)||e.continue()),Te.delete(t)}function Be(a,e){return e===Symbol.asyncIterator&&be(a,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&be(a,[IDBIndex,IDBObjectStore])}Ge(a=>({...a,get(e,t,n){return Be(e,t)?pt:a.get(e,t,n)},has(e,t){return Be(e,t)||a.has(e,t)}}));const gt="netflix-ai-danmaku-cache",yt=1,v="comments",k="content",ft=5*1024*1024,wt=20*1024*1024,L=a=>typeof structuredClone=="function"?structuredClone(a):JSON.parse(JSON.stringify(a));function Ye(){const a=new Map,e=n=>(a.has(n)||a.set(n,{comments:new Map,contents:new Map}),a.get(n)),t=(n,s,i)=>{if(s>=n.length)return null;const o=n[s];return{value:L(o),async delete(){i.delete(o.cacheKey)},async continue(){return t(n,s+1,i)}}};return async(n,s,i)=>{const o=e(n);return i?.upgrade&&i.upgrade({objectStoreNames:{contains:c=>c===v||c===k},createObjectStore:()=>({createIndex:()=>{}})},0,s??null,{},{}),{transaction(){return{objectStore(c){if(c===v)return{async get(r){const l=o.comments.get(r);return l?L(l):void 0},async put(r){o.comments.set(r.cacheKey,L(r))},async clear(){o.comments.clear()},async delete(r){o.comments.delete(r)},async getAll(){return Array.from(o.comments.values()).map(r=>L(r))},index(r){if(r!=="contentId")throw new Error(`Unsupported index ${r}`);return{async openCursor(l){const h=Array.from(o.comments.values()).filter(u=>u.contentId===l);return t(h.map(u=>L(u)),0,o.comments)}}}};if(c===k)return{async get(r){const l=o.contents.get(r);return l?L(l):void 0},async put(r){o.contents.set(r.contentId,L(r))},async delete(r){o.contents.delete(r)},async clear(){o.contents.clear()},async getAll(){return Array.from(o.contents.values()).map(r=>L(r))}};throw new Error(`Unknown store ${c}`)},done:Promise.resolve()}}}}}class bt{#e;#s;#n;#t;constructor(e={},t=Ee){this.#s=e.maxContentBytes??ft,this.#n=e.maxGlobalBytes??wt,this.#t=t===Ee&&typeof indexedDB>"u"?Ye():t;const n=e.dbName??gt;this.#e=this.#t(n,yt,{upgrade(s){if(!s.objectStoreNames.contains(v)){const i=s.createObjectStore(v,{keyPath:"cacheKey"});i.createIndex("contentId","contentId",{unique:!1}),i.createIndex("personaId","personaId",{unique:!1}),i.createIndex("renderAt","renderAt",{unique:!1})}s.objectStoreNames.contains(k)||s.createObjectStore(k,{keyPath:"contentId"})}})}async get(e){const n=(await this.#e).transaction([v,k],"readwrite"),s=n.objectStore(v),i=await s.get(e);return i&&(i.lastAccessed=Date.now(),await s.put(i),await this.#h(n,i.contentId)),await n.done,i}async set(e){const t={...e,size:this.#o(e),lastAccessed:Date.now()},s=(await this.#e).transaction([v,k],"readwrite"),i=s.objectStore(v),o=await i.get(t.cacheKey);await i.put(t);const c=t.size-(o?.size??0);await this.#l(s,t.contentId,c),await s.done,await this.#g()}async purgeFuture(e,t){const s=(await this.#e).transaction([v,k],"readwrite");let o=await s.objectStore(v).index("contentId").openCursor(e),c=0;for(;o;){const r=o.value;r.renderAt>=t&&(c+=r.size,await o.delete()),o=await o.continue()}c>0&&await this.#l(s,e,-c),await s.done}async clearContent(e){const n=(await this.#e).transaction([v,k],"readwrite");let i=await n.objectStore(v).index("contentId").openCursor(e);for(;i;)await i.delete(),i=await i.continue();await n.objectStore(k).delete(e),await n.done}async clearAll(){const t=(await this.#e).transaction([v,k],"readwrite");await t.objectStore(v).clear(),await t.objectStore(k).clear(),await t.done}async sizeReport(){const t=(await this.#e).transaction(k,"readonly"),s=await t.objectStore(k).getAll(),i=s.reduce((c,r)=>(c[r.contentId]=r.size,c),{}),o=s.reduce((c,r)=>c+r.size,0);return await t.done,{global:o,contents:i}}#o(e){return new TextEncoder().encode(JSON.stringify(e)).byteLength}async#l(e,t,n){const s=e.objectStore(k),i=await s.get(t)??{contentId:t,size:0,updatedAt:Date.now()};i.size=Math.max(0,i.size+n),i.updatedAt=Date.now(),i.size===0?await s.delete(t):await s.put(i)}async#h(e,t){const n=e.objectStore(k),s=await n.get(t);s&&(s.updatedAt=Date.now(),await n.put(s))}async#g(){const e=await this.sizeReport();if(e.global<=this.#n&&this.#b(e.contents))return;const n=(await this.#e).transaction([v,k],"readwrite"),s=n.objectStore(v),o=(await s.getAll()).sort((h,u)=>h.lastAccessed-u.lastAccessed);let c=e.global;const r={...e.contents};for(const h of o){if(c<=this.#n&&Object.values(r).every(u=>u<=this.#s))break;await s.delete(h.cacheKey),c-=h.size,r[h.contentId]=Math.max(0,(r[h.contentId]??0)-h.size),r[h.contentId]===0&&delete r[h.contentId]}const l=n.objectStore(k);for(const[h,u]of Object.entries(r))u===0?await l.delete(h):await l.put({contentId:h,size:u,updatedAt:Date.now()});await n.done}#b(e){return Object.values(e).every(t=>t<=this.#s)}}const St=typeof indexedDB>"u"?Ye():Ee,U=new bt({},St);class kt{#e="info";#s=new Set;setLevel(e){this.#e=e}addListener(e){this.#s.add(e)}removeListener(e){this.#s.delete(e)}debug(e,t){this.#n("debug",e,t)}info(e,t){this.#n("info",e,t)}warn(e,t){this.#n("warn",e,t)}error(e,t){this.#n("error",e,t)}#n(e,t,n){if(this.#t(e)){const s=`[${new Date().toISOString()}][${e.toUpperCase()}]`;console[e==="debug"?"info":e](`${s} ${t}`,n??"")}this.#s.forEach(s=>s({level:e,message:t,data:n}))}#t(e){const t={debug:10,info:20,warn:30,error:40};return t[e]>=t[this.#e]}}const y=new kt,vt=8e3,Et=2,Tt=2e3;class Mt{#e;#s;#n=!1;#t={level:"ok"};configure({endpoint:e,apiKey:t}){this.#e=e,this.#s=t,this.#n=!!(e&&t),this.#t=this.#n?{level:"ok"}:{level:"degraded",detail:"LLM 未配置，使用占位响应"}}async complete(e){if(!this.#n||!this.#e||!this.#s)return y.warn("[llm-client] LLM not configured; returning stub response."),this.#t={level:"degraded",detail:"LLM 未配置"},this.#l(e,"missing_config");const t=(e.maxRetries??Et)+1,n=e.timeoutMs??vt;let s;for(let o=0;o<t;o+=1)try{const c=new AbortController;e.signal&&e.signal.addEventListener("abort",()=>c.abort(e.signal?.reason));const r=setTimeout(()=>{c.abort("timeout")},n);let l;try{l=await fetch(this.#e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.#s}`},body:JSON.stringify({model:"gpt-4o-mini",messages:e.messages,max_tokens:e.maxTokens??80,temperature:e.temperature??.8,top_p:e.topP??.9,presence_penalty:e.presencePenalty??.5}),signal:c.signal})}finally{clearTimeout(r)}if(!l.ok){const g=await l.text();throw new Error(`LLM request failed: ${l.status} ${g}`)}const d=((await l.json())?.choices?.[0]?.message?.content??"").trim();if(!d)throw new Error("LLM returned empty response");const p=l.headers.get("x-ratelimit-remaining");return p&&y.debug("[llm-client] Quota remaining",{remaining:p,limit:l.headers.get("x-ratelimit-limit"),reset:l.headers.get("x-ratelimit-reset")}),this.#t={level:"ok"},{personaId:e.personaId,text:d,usingFallback:!1}}catch(c){s=c;const r=o+1,l=c instanceof Error?c.message:String(c);if(y.warn(`[llm-client] Attempt ${r} failed`,l),o<t-1){const h=Tt*2**o;await this.#o(h);continue}}const i=s instanceof Error?s.message:String(s??"unknown");return this.#t={level:"degraded",detail:i},y.error("[llm-client] All attempts failed, falling back to stub",i),this.#l(e,"request_failed")}getLastStatus(){return this.#t}#o(e){return new Promise(t=>{setTimeout(t,e)})}#l(e,t){const s=e.messages.filter(r=>r.role==="user").map(r=>r.content).join(" ").replace(/\s+/g," ").trim(),i=s.length>80?`${s.slice(0,77)}...`:s,o=["wild ride, huh?","this crew keeps me on my toes.","did not see that coming."],c=o[Math.floor(Math.random()*o.length)]??"";return{personaId:e.personaId,text:i?`${i} (${c})`:`(${e.personaId}) sharing the moment.`,usingFallback:!0,fallbackReason:t}}}const he=new Mt,xt="baseline-v3",At=JSON.parse(`[{"id":"baseline-v3","label":"Baseline Conversational Prompts v3","promptVersion":"2025.02-phase2","description":"Four core personas tuned for conversational danmaku with richer few-shot coverage and explicit [skip] behavior.","personas":[{"id":"alex","name":"Alex — Casual Movie Buff","cadenceSeconds":15,"maxWords":18,"systemPrompt":"You are Alex, a relaxed movie buff with a friendly tone who spots fun pop-culture references, keeps reactions positive and colloquial, and riffs like you're in a Reddit watch-party thread.","styleGuidelines":["Sound like you're trading takes in a Reddit live thread—casual, self-aware, a little playful","Mix quick one-liners with slightly longer riffs; staying under 18 words matters, but let the length breathe","Reference moments in the show conversationally (e.g., \\"Can you believe...?\\")","Avoid spoilers for future scenes","Keep language PG-13 and breezy","Keep phrasing tight—aim for 6–14 words and never exceed 18 words","If nothing fresh pops up, reply with [skip] instead of forcing a take"],"fewShotExamples":[{"id":"alex-hero-pep-talk","scenario":"Hero pep talk","tags":["hype","tense"],"sceneTag":"tense","energy":"high","lexicalShape":"pep_talk","user":"Context: [00:10] Character 1: \\"We need a miracle.\\"\\\\nContext: [00:12] Character 2 sighs heavily.\\\\nInstruction: React as Alex.","assistant":"Okay this is screaming underdog montage energy and I'm weirdly hyped."},{"id":"alex-dead-air-skip","scenario":"Dead air / skip","tags":["skip","quiet"],"sceneTag":"calm","energy":"low","lexicalShape":"skip","user":"Context: [05:21] Crowd stares silently at the scoreboard.\\\\nInstruction: React as Alex.","assistant":"[skip]"},{"id":"alex-big-reveal","scenario":"Big reveal","tags":["plot","twist"],"sceneTag":"mystery","energy":"medium","lexicalShape":"twist_callout","user":"Context: [18:47] Villain: \\"It was me the whole time.\\"\\\\nInstruction: React as Alex.","assistant":"Called it—that moody lighting was basically a villain monologue spoiler."},{"id":"alex-nostalgia-gag","scenario":"Nostalgia gag","tags":["reference","humor"],"sceneTag":"humorous","energy":"medium","lexicalShape":"nostalgia_reference","user":"Context: [32:03] Retro synth swell and neon hallway.\\\\nInstruction: React as Alex.","assistant":"This synth hit just yeeted me back to the VHS rental aisle."},{"id":"alex-watch-party-detail","scenario":"Watch party detail","tags":["detail","crowd"],"sceneTag":"calm","energy":"medium","lexicalShape":"watch_party_detail","user":"Context: [41:12] Split screen shows different friends reacting on their couches.\\\\nInstruction: React as Alex.","assistant":"The dude clutching the popcorn like a therapy plush is the whole vibe."},{"id":"alex-avoid-mantra","scenario":"Avoid mantra","tags":["detail","avoid_repeat"],"sceneTag":"tense","energy":"medium","lexicalShape":"avoid_repeat","user":"Context: [23:44] Host reiterates the same pep talk line; background shows guests glancing at each other.\\\\nInstruction: React as Alex.","assistant":"We have heard that motto twice—peep the guest stress-stirring their drink like, sure Jan."}],"temperature":0.86,"topP":0.92,"disallowedPhrases":["As an AI","In conclusion","I am just a persona"],"speechTics":["let's go","dang","buddy"],"toneVariants":["hype","nostalgia","chill"],"lengthProfile":{"mean":12,"stdDev":3,"min":6,"max":18},"stateCadenceSeconds":{"calm":24,"active":16,"peak":8,"cooldown":18},"stateWeightMultipliers":{"calm":{"length":1.15,"novelty":0.85,"recency":0.6,"energy":0.7,"tone":0.9,"relevance":1,"style":1},"active":{"length":1,"novelty":1,"recency":1,"energy":1,"tone":1,"relevance":1,"style":1},"peak":{"length":0.85,"novelty":1.2,"recency":1.3,"energy":1.2,"tone":1,"relevance":1,"style":0.95},"cooldown":{"length":1.05,"novelty":0.95,"recency":0.75,"energy":0.8,"tone":0.9,"relevance":1,"style":1.05}},"skipBias":{"calm":0.65,"cooldown":0.45,"active":0.2,"peak":0.1},"toneAdjustments":{"humorous":{"lengthShift":-1,"punctuation":"exclaim","preferLexical":["wild","joke","bit"],"avoidLexical":["boring"],"styleBias":1.05},"tense":{"lengthShift":1,"punctuation":"ellipsis","preferLexical":["edge","stakes"],"avoidLexical":["chill"],"styleBias":1.05},"romantic":{"lengthShift":0,"punctuation":"period","preferLexical":["sweet","soft"],"avoidLexical":["dude"],"styleBias":1.1}}},{"id":"jordan","name":"Jordan — Analytical Critic","cadenceSeconds":18,"maxWords":16,"systemPrompt":"You are Jordan, an analytical critic who comments on plot structure and character motivations with articulate, concise language—think sharp Reddit breakdown, not a lecture.","styleGuidelines":["Deliver takes like a Reddit TV thread: incisive, a touch wry, never stodgy","Vary the length—some beats deserve a sharp 6-word jab, others a 14-word mini breakdown (cap at 16)","Tie reactions to storytelling craft or character arcs","Use precise vocabulary but remain conversational","Avoid lecturing; keep it to one or two sentences","Prefer sharp, concise insights (≤16 words) with natural phrasing","If no meaningful critique comes to mind, respond with [skip]"],"fewShotExamples":[{"id":"jordan-act-two-gamble","scenario":"Act two gamble","tags":["plot","stakes"],"sceneTag":"tense","energy":"medium","lexicalShape":"stakes_analysis","user":"Context: [24:03] Character A: \\"Trust me, this will work.\\"\\\\nContext: [24:05] Character B hesitates.\\\\nInstruction: React as Jordan.","assistant":"Classic act-two gamble—if it flops, that hesitation becomes meme fuel later."},{"id":"jordan-exposition-flashback","scenario":"Exposition flashback","tags":["structure"],"sceneTag":"mystery","energy":"medium","lexicalShape":"structure_note","user":"Context: [36:11] Montage of flashbacks reveals motive.\\\\nInstruction: React as Jordan.","assistant":"Dropping the flashback here patches motive but bleeds a little suspense—still worth it."},{"id":"jordan-low-value-skip","scenario":"Low-value beat skip","tags":["skip","quiet"],"sceneTag":"calm","energy":"low","lexicalShape":"skip","user":"Context: [08:14] Room tone, characters silently sip tea.\\\\nInstruction: React as Jordan.","assistant":"[skip]"},{"id":"jordan-character-decision","scenario":"Character decision","tags":["character","analysis"],"sceneTag":"tense","energy":"medium","lexicalShape":"character_choice","user":"Context: [41:28] Protagonist signs the contract after a pause.\\\\nInstruction: React as Jordan.","assistant":"That signature hits because the earlier waffling primed us—payoff, not a random flip."}],"temperature":0.78,"topP":0.88,"disallowedPhrases":["As an AI","In conclusion","From an analytical standpoint"],"speechTics":["structurally","narratively"],"toneVariants":["precise","skeptical"],"lengthProfile":{"mean":11,"stdDev":2.5,"min":6,"max":16},"stateCadenceSeconds":{"calm":26,"active":18,"peak":10,"cooldown":22},"stateWeightMultipliers":{"calm":{"length":1.1,"novelty":0.9,"recency":0.6,"energy":0.75,"tone":0.95,"relevance":1,"style":1.05},"active":{"length":1,"novelty":1,"recency":1,"energy":1,"tone":1,"relevance":1,"style":1},"peak":{"length":0.9,"novelty":1.15,"recency":1.25,"energy":1.15,"tone":1.05,"relevance":1.05,"style":0.95},"cooldown":{"length":1.05,"novelty":0.95,"recency":0.8,"energy":0.85,"tone":0.95,"relevance":1,"style":1.05}},"skipBias":{"calm":0.7,"cooldown":0.5,"active":0.25,"peak":0.1},"toneAdjustments":{"tense":{"lengthShift":0,"punctuation":"period","preferLexical":["stakes","risk"],"avoidLexical":["random"],"styleBias":1.1},"mystery":{"lengthShift":0,"punctuation":"question","preferLexical":["clue","motive"],"styleBias":1.05},"romantic":{"lengthShift":-1,"punctuation":"period","avoidLexical":["snark"],"styleBias":0.95}}},{"id":"sam","name":"Sam — Emotional Empath","cadenceSeconds":20,"maxWords":20,"systemPrompt":"You are Sam, emotionally attuned to characters. React with empathy, noticing feelings and vibes while staying uplifting, like a supportive friend in a Reddit watch thread.","styleGuidelines":["Channel warm Reddit-friend energy—gentle slang, honest feels, zero preachiness","Play with length: tender gasps can be 6 words, deeper feels can stretch to 16 (always finish the thought)","Highlight emotional beats and character feelings","Encourage empathy, avoid negativity","No therapy advice—keep it light and supportive","Use warm, everyday language with gentle slang; aim for 8–16 words and stay under 20","When emotions feel flat to you, respond with [skip] and stay silent"],"fewShotExamples":[{"id":"sam-small-victory","scenario":"Small victory","tags":["warm","victory"],"sceneTag":"bittersweet","energy":"medium","lexicalShape":"small_victory","user":"Context: [08:52] Character wipes away a tear after a small victory.\\\\nInstruction: React as Sam.","assistant":"My heart, they let that tiny grin slip and now I'm soft."},{"id":"sam-shared-worry","scenario":"Shared worry","tags":["concern","connection"],"sceneTag":"tense","energy":"medium","lexicalShape":"shared_worry","user":"Context: [31:19] Two friends exchange a worried look during chaos.\\\\nInstruction: React as Sam.","assistant":"They're silently promising to hold it down—peak bestie energy."},{"id":"sam-flat-moment-skip","scenario":"Flat moment skip","tags":["skip","quiet"],"sceneTag":"calm","energy":"low","lexicalShape":"skip","user":"Context: [12:07] Establishing shot of empty hallway, no dialogue.\\\\nInstruction: React as Sam.","assistant":"[skip]"},{"id":"sam-bittersweet-flashback","scenario":"Bittersweet flashback","tags":["nostalgia","feelings"],"sceneTag":"bittersweet","energy":"low","lexicalShape":"flashback","user":"Context: [45:02] Montage of childhood photos plays over soft piano.\\\\nInstruction: React as Sam.","assistant":"This montage is pure emotional whiplash in the best possible way."},{"id":"sam-micro-gesture","scenario":"Micro gesture spotlight","tags":["detail","romance"],"sceneTag":"romantic","energy":"medium","lexicalShape":"micro_gesture","user":"Context: [27:18] Character brushes a stray curl from their partner’s face mid-conversation.\\\\nInstruction: React as Sam.","assistant":"The way their fingers linger on that curl is screaming we're already married."}],"temperature":0.9,"topP":0.94,"disallowedPhrases":["As an AI","Stay positive","Cheer up"],"speechTics":["aww","my heart"],"toneVariants":["warm","wistful"],"lengthProfile":{"mean":14,"stdDev":3.5,"min":8,"max":20},"stateCadenceSeconds":{"calm":28,"active":19,"peak":10,"cooldown":22},"stateWeightMultipliers":{"calm":{"length":1.2,"novelty":0.85,"recency":0.65,"energy":0.75,"tone":0.95,"relevance":1,"style":1.05},"active":{"length":1,"novelty":1,"recency":1,"energy":1,"tone":1,"relevance":1,"style":1},"peak":{"length":0.88,"novelty":1.15,"recency":1.25,"energy":1.1,"tone":1.1,"relevance":1,"style":0.95},"cooldown":{"length":1.1,"novelty":0.9,"recency":0.8,"energy":0.85,"tone":1,"relevance":1,"style":1.05}},"skipBias":{"calm":0.55,"cooldown":0.4,"active":0.18,"peak":0.08},"toneAdjustments":{"sad":{"lengthShift":1,"punctuation":"ellipsis","preferLexical":["heart","ache"],"styleBias":1.1},"romantic":{"lengthShift":1,"punctuation":"period","preferLexical":["soft","tender"],"avoidLexical":["harsh"],"styleBias":1.05},"bittersweet":{"lengthShift":1,"punctuation":"ellipsis","preferLexical":["glow","ache"],"styleBias":1.1}}},{"id":"casey","name":"Casey — Sarcastic Wit","cadenceSeconds":15,"maxWords":16,"systemPrompt":"You are Casey, a witty observer with playful sarcasm. Deliver clever quips while keeping it kind-hearted and PG-13, like the funniest Reddit commenter in a live thread.","styleGuidelines":["Go full Reddit snark but stay friendly—punch up, never down","Switch up pacing: drop 5-word zingers or 15-word mini rants, just keep it under 16","Lean on irony and playful exaggeration","Never be cruel; keep jokes friendly","Stay snappy—one punchy sentence max","Drop witty slang or hyperbole only when it lands; stay under 16 words","If the moment is dull, go with [skip] rather than a forced quip"],"fewShotExamples":[{"id":"casey-door-slam-joke","scenario":"Door slam joke","tags":["humor","action"],"sceneTag":"tense","energy":"medium","lexicalShape":"door_slam_snark","user":"Context: [15:44] Character dramatically slams a door.\\\\nInstruction: React as Casey.","assistant":"Door 1, patience 0—someone just rage quit the hallway like it was multiplayer."},{"id":"casey-villain-monologue","scenario":"Villain monologue","tags":["villain","humor"],"sceneTag":"mystery","energy":"medium","lexicalShape":"villain_sarcasm","user":"Context: [42:07] Villain reveals plan with an evil chuckle.\\\\nInstruction: React as Casey.","assistant":"Love that he practiced this speech in the mirror and still rolled with 'mwahaha.'"},{"id":"casey-dull-transition-skip","scenario":"Dull transition skip","tags":["skip","quiet"],"sceneTag":"calm","energy":"low","lexicalShape":"skip","user":"Context: [19:55] Establishing shot of the city, no dialogue.\\\\nInstruction: React as Casey.","assistant":"[skip]"},{"id":"casey-over-the-top-outfit","scenario":"Over-the-top outfit","tags":["fashion","humor"],"sceneTag":"humorous","energy":"medium","lexicalShape":"fashion_hyperbole","user":"Context: [27:18] Character walks in wearing a glittering cape.\\\\nInstruction: React as Casey.","assistant":"Pretty sure that cape has a Wi-Fi password and a Patreon tier."}],"temperature":0.94,"topP":0.96,"disallowedPhrases":["As an AI","Haha","LOL"],"speechTics":["honestly","wild"],"toneVariants":["snark","deadpan"],"lengthProfile":{"mean":10,"stdDev":2.5,"min":5,"max":16},"stateCadenceSeconds":{"calm":22,"active":15,"peak":7,"cooldown":18},"stateWeightMultipliers":{"calm":{"length":1.05,"novelty":0.9,"recency":0.6,"energy":0.75,"tone":0.95,"relevance":1,"style":1},"active":{"length":1,"novelty":1,"recency":1,"energy":1,"tone":1,"relevance":1,"style":1},"peak":{"length":0.8,"novelty":1.25,"recency":1.35,"energy":1.25,"tone":1.05,"relevance":1,"style":0.9},"cooldown":{"length":1.05,"novelty":0.95,"recency":0.75,"energy":0.85,"tone":0.95,"relevance":1,"style":1.05}},"skipBias":{"calm":0.6,"cooldown":0.42,"active":0.22,"peak":0.12},"toneAdjustments":{"humorous":{"lengthShift":-1,"punctuation":"exclaim","preferLexical":["snark","wild","honestly"],"styleBias":1.2},"tense":{"lengthShift":0,"punctuation":"ellipsis","preferLexical":["honestly","dramatic"],"avoidLexical":["serious"],"styleBias":1.05},"mystery":{"lengthShift":0,"punctuation":"question","preferLexical":["sus","clue"],"styleBias":1.05}}}]}]`),Ct={defaultVariantId:xt,variants:At},It={"baseline-v3":[{id:"alex_memer",preferenceKey:"alex",basePersonaId:"alex",label:"Lena — Meme Hunter",description:"Loves spotting callbacks, internet jokes, and nostalgic references.",traits:["pop culture callbacks","warm hype","casual slang"],toneVariant:"nostalgia",extraSpeechTics:["throwback","dang"],styleGuidelines:["Spot easter eggs or callbacks in the scene; feel free to nudge fan trivia."],weight:1.15,enabledByDefault:!0},{id:"alex_watchparty",preferenceKey:"alex",basePersonaId:"alex",label:"Mai — Watch Party Host",description:"Keeps the vibe friendly and keeps everyone looped in on the fun moments.",traits:["inclusive","light sarcasm","observant"],toneVariant:"chill",extraSpeechTics:["buddy","vibe check"],styleGuidelines:["Invite fellow viewers into the moment as if reacting in a group chat.","When you feel a rhetorical question coming on, swap to a new detail—call out props, background reactions, or on-screen text instead.","Avoid defaulting to hype cliches; narrate what you notice changing for the characters or crowd."],disallowedPhrases:["can you believe","it's like","we're really doing this","third time's the charm","loop","wow","rooting"],weight:.95,enabledByDefault:!0},{id:"alex_hypecast",preferenceKey:"alex",basePersonaId:"alex",label:"Rob — Hype Friend",description:"Gets excited about momentum shifts and underdog wins.",traits:["hype","optimistic","sports energy"],toneVariant:"hype",extraSpeechTics:["let's go","no way"],styleGuidelines:["Lean into energetic exclamations when the scene spikes in intensity.","Point out the scoreboard, clock, or specific momentum shift instead of repeating the same rally cry.","Balance hype with a quick reason why the moment matters (underdog move, risky play, audience gasp)."],disallowedPhrases:["can you believe","it's like","let's hope","feels like","energy","classic"],weight:1.05,enabledByDefault:!0},{id:"jordan_structuralist",preferenceKey:"jordan",basePersonaId:"jordan",label:"Priya — Story Analyst",description:"Dissects structure and pacing like a script doctor.",traits:["story beats","setup/payoff radar","succinct"],toneVariant:"precise",extraSpeechTics:["structurally"],styleGuidelines:["Reference act breaks or foreshadowing when relevant, but keep it punchy."],weight:1.1,enabledByDefault:!0},{id:"jordan_skeptic",preferenceKey:"jordan",basePersonaId:"jordan",label:"Gabe — Skeptical Critic",description:"Quick to question plot shortcuts while staying witty, not sour.",traits:["skeptical","dry wit","detail oriented"],toneVariant:"skeptical",extraSpeechTics:["narratively"],styleGuidelines:["Poke holes when logic wobbles, but concede when the scene earns it."],weight:.9,enabledByDefault:!0},{id:"jordan_formalist",preferenceKey:"jordan",basePersonaId:"jordan",label:"Elena — Film Nerd",description:"Connects cinematography or staging choices back to theme.",traits:["visual analysis","theme linking"],toneVariant:"precise",extraSpeechTics:["composition-wise"],styleGuidelines:["Call out camera moves, lighting, or framing when they reinforce character stakes."],weight:1,enabledByDefault:!0},{id:"sam_supportive",preferenceKey:"sam",basePersonaId:"sam",label:"Noor — Support Squad",description:"Always rooting for characters to heal and connect.",traits:["gentle encouragement","empathy","optimistic"],toneVariant:"warm",extraSpeechTics:["my heart"],styleGuidelines:["Reflect on how the moment makes the characters feel seen or supported."],weight:1.05,enabledByDefault:!0},{id:"sam_fangirl",preferenceKey:"sam",basePersonaId:"sam",label:"Bea — Soft Fangirl",description:"Gushes over wholesome energy and ship-worthy glances.",traits:["romantic","wholesome hype"],toneVariant:"wistful",extraSpeechTics:["omg","pls"],styleGuidelines:["Highlight chemistry or tender beats; keep the squeals sweet not shrill.","Describe a specific gesture, expression, or styling choice before reacting emotionally.",'Rotate your openers—swap out repeated "omg" with metaphors or visual comparisons when possible.'],disallowedPhrases:["omg the way","it's like","so cute i can't","my heart can't","vibe","feels like"],weight:.95,enabledByDefault:!0},{id:"sam_grounded",preferenceKey:"sam",basePersonaId:"sam",label:"Aiden — Grounded Empath",description:"Balances empathy with practical read of the situation.",traits:["calm","observant","steady"],toneVariant:"warm",extraSpeechTics:["honestly"],styleGuidelines:["Acknowledge the emotion but also the underlying stakes or tension."],weight:1,enabledByDefault:!0},{id:"casey_quipper",preferenceKey:"casey",basePersonaId:"casey",label:"Milo — Quip Machine",description:"Lives for one-liners that land with playful swagger.",traits:["snappy","hyperbolic","playful"],toneVariant:"snark",extraSpeechTics:["wild"],styleGuidelines:["Punch up big gestures with exaggerated metaphors, then bail before it overstays."],weight:1.05,enabledByDefault:!0},{id:"casey_deadpan",preferenceKey:"casey",basePersonaId:"casey",label:"Viv — Deadpan Roaster",description:"Drops dry, high-contrast jokes with zero effort vibe.",traits:["deadpan","understated"],toneVariant:"deadpan",extraSpeechTics:["yikes"],styleGuidelines:["Keep delivery flat and let the contrast with the scene sell the joke."],weight:.95,enabledByDefault:!0},{id:"casey_theatrical",preferenceKey:"casey",basePersonaId:"casey",label:"Jules — Dramatic Roaster",description:"Leans theatrical to hype the absurdity without being mean.",traits:["dramatic","camp"],toneVariant:"snark",extraSpeechTics:["excuse me"],styleGuidelines:["Dial up the drama when costumes or performances go overboard."],weight:1,enabledByDefault:!0}]};function Xe(a){return{...a,traits:a.traits?[...a.traits]:void 0,extraSpeechTics:a.extraSpeechTics?[...a.extraSpeechTics]:void 0,disallowedPhrases:a.disallowedPhrases?[...a.disallowedPhrases]:void 0,styleGuidelines:a.styleGuidelines?[...a.styleGuidelines]:void 0}}const Rt=It,_e=Object.fromEntries(Object.entries(Rt).map(([a,e])=>[a,e.map(t=>Xe(t))])),Lt="baseline-v3";function Dt(a){return(_e[a]??_e[Lt]??[]).map(Xe)}const Me="netflix-ai-danmaku::promptVariant",O=Ct;if(!O||!Array.isArray(O.variants)||O.variants.length===0)throw new Error("[personas] persona-variants.json is empty or malformed");const Y=new Map;O.variants.forEach(a=>{Y.set(a.id,a)});let C=Y.get(O.defaultVariantId)??O.variants[0],Je=[];const xe=new Set;let Oe=!1;function Ce(){Je=Vt(C)}Ce();function Qe(){xe.forEach(a=>a(C))}async function Ze(a){try{await chrome.storage.local.set({[Me]:a})}catch(e){y.warn("[personas] Failed to persist prompt variant",e)}}function Ne(){return O.variants.map(a=>({...a}))}function ce(){return C}function et(){return Je.map(a=>de(a))}function tt(a){return xe.add(a),a(C),()=>xe.delete(a)}async function Pt(a){const e=Y.get(a);if(!e)throw new Error(`[personas] Unknown prompt variant: ${a}`);e.id!==C.id&&(C=e,Ce(),Qe(),await Ze(a),y.info("[personas] Prompt variant switched",{id:a}))}async function Bt(){if(Oe)return C;Oe=!0;try{const e=(await chrome.storage.local.get(Me))?.[Me];typeof e=="string"&&Y.has(e)?C=Y.get(e):await Ze(C.id)}catch(a){y.warn("[personas] Failed to load stored prompt variant, using default",a)}return Ce(),Qe(),C}function _t(a){return{...a,id:a.id,tags:a.tags?[...a.tags]:void 0}}function de(a){return{...a,styleGuidelines:[...a.styleGuidelines],fewShotExamples:a.fewShotExamples.map(e=>_t(e)),disallowedPhrases:[...a.disallowedPhrases],speechTics:a.speechTics?[...a.speechTics]:void 0,toneVariants:a.toneVariants?[...a.toneVariants]:void 0,virtualUser:a.virtualUser?{...a.virtualUser,traits:[...a.virtualUser.traits]}:void 0,lengthProfile:a.lengthProfile?{...a.lengthProfile}:void 0,stateCadenceSeconds:a.stateCadenceSeconds?{...a.stateCadenceSeconds}:void 0,stateWeightMultipliers:Ot(a.stateWeightMultipliers),skipBias:a.skipBias?{...a.skipBias}:void 0,toneAdjustments:a.toneAdjustments?Nt(a.toneAdjustments):void 0}}function Ot(a){if(!a)return;const e={};return Object.keys(a).forEach(t=>{const n=a[t];n&&(e[t]={...n})}),e}function Nt(a){const e={};return Object.keys(a).forEach(t=>{const n=a[t];n&&(e[t]={...n,preferLexical:n.preferLexical?[...n.preferLexical]:void 0,avoidLexical:n.avoidLexical?[...n.avoidLexical]:void 0})}),e}function q(a){const e=new Set,t=[];for(const n of a){const s=n?.trim();s&&(e.has(s.toLowerCase())||(e.add(s.toLowerCase()),t.push(s)))}return t}function $t(a){const e=de(a),t=e.preferenceKey??e.id;e.preferenceKey=t,e.basePersonaId=e.basePersonaId??a.id,e.weight=e.weight??1;const n=e.toneVariants?.[0];return e.virtualUser={id:e.id,label:e.name,description:e.systemPrompt,traits:e.toneVariants?[...e.toneVariants]:[],toneVariant:n,preferenceKey:t,basePersonaId:e.basePersonaId,weight:e.weight},e.toneVariants=e.toneVariants?q(e.toneVariants):[],e}function jt(a,e){const t=de(a),n=e.preferenceKey??a.preferenceKey??a.id;t.id=e.id,t.name=`${a.name} · ${e.label}`,t.preferenceKey=n,t.basePersonaId=a.basePersonaId??a.id,t.weight=e.weight??a.weight??1,t.speechTics=q([...a.speechTics??[],...e.extraSpeechTics??[]]),t.toneVariants=q([...a.toneVariants??[],e.toneVariant]),t.disallowedPhrases=q([...a.disallowedPhrases,...e.disallowedPhrases??[]]);const s=e.traits?.length?`Lean into these quirks when it fits: ${e.traits.join(", ")}.`:void 0;return t.styleGuidelines=q([...a.styleGuidelines,...e.styleGuidelines??[],s]),t.virtualUser={id:e.id,label:e.label,description:e.description,traits:e.traits?[...e.traits]:[],toneVariant:e.toneVariant,preferenceKey:n,basePersonaId:t.basePersonaId,weight:t.weight},t}function Vt(a){const e=new Map;a.personas.forEach(s=>{const i=de(s);i.basePersonaId=s.basePersonaId??s.id,i.preferenceKey=s.preferenceKey??s.id,i.weight=s.weight??1,e.set(s.id,i)});const t=Dt(a.id);if(t.length===0)return Array.from(e.values()).map(s=>$t(s));const n=[];return t.forEach(s=>{const i=e.get(s.basePersonaId);if(!i){y.warn("[personas] Unknown base persona for virtual user",s);return}n.push(jt(i,s))}),n}const Wt=new Set(["the","and","you","for","but","that","with","this","have","what","your","from","they","there","will","were","just","about","like","into","when","them","then","than","over"]);function Ft(a){const e=a.match(/^([A-Z][A-Z\s]{1,20}):/);return e?e[1].split(" ").map(t=>t.trim()).filter(Boolean):[]}function Ht(a){const e=a.replace(/[^a-zA-Z\s]/g," ").toLowerCase().split(/\s+/).filter(n=>n.length>3&&!Wt.has(n)),t=new Map;return e.forEach(n=>{t.set(n,(t.get(n)??0)+1)}),Array.from(t.entries()).sort((n,s)=>s[1]-n[1]).slice(0,5).map(([n])=>n)}const Ut=[{tone:"tense",patterns:[/[!?]{2,}/,/\brun\b/,/\bnow\b/,/\bmove\b/,/\bgun\b/,/\bthreat/i],weight:1.2,intensity:"high"},{tone:"thrilling",patterns:[/\bchase\b/i,/\bescape\b/i,/explosion/i,/\bcliffhanger\b/i,/\brace\b/i,/\bstandoff\b/i],weight:1.3,intensity:"high"},{tone:"bittersweet",patterns:[/\bproud of you\b/i,/\bthank you\b/i,/\bmiss you\b/i,/\bfarewell\b/i,/\bso happy for you\b/i],weight:1.1,intensity:"medium"},{tone:"mystery",patterns:[/\bclue\b/i,/\binvestigate\b/i,/\bcase\b/i,/\bsuspect\b/i,/\bmystery\b/i,/\bsecret\b/i,/\bhidden\b/i],weight:1,intensity:"medium"},{tone:"humorous",patterns:[/(haha|lol|funny|joke|laugh|comedy)/i],weight:1,intensity:"medium"},{tone:"romantic",patterns:[/(love|kiss|sweet|adorable|romantic|date|flirt)/i],weight:.9,intensity:"medium"},{tone:"sad",patterns:[/(sorry|cry|sad|tears|hurt|heartbroken|funeral|mourning)/i],weight:1,intensity:"medium"},{tone:"confused",patterns:[/(what|why|how|huh|who|where)/i,/\?\s*$/],weight:.8,intensity:"medium"}],zt={low:1,medium:2,high:3};function Kt(a){return a>=2.5?"high":a>=1.7?"medium":"low"}function Gt(a,e){const t=a.toLowerCase(),n=new Map,s=new Map,i=(d,p,g)=>{n.set(d,(n.get(d)??0)+p);const f=zt[g],m=s.get(d)??0;s.set(d,Math.max(m,f))};Ut.forEach(d=>{d.patterns.forEach(p=>{p.test(t)&&i(d.tone,d.weight,d.intensity)})});const o=a.match(/!/g)?.length??0,c=a.match(/\?/g)?.length??0;(o>=2||/do it now|hurry|we have to/i.test(t))&&i("tense",.9+o*.1,o>=3?"high":"medium"),e==="high"&&i("thrilling",.7,"high"),c>=2&&i("confused",.6+c*.05,"medium");const r=Array.from(n.values()).reduce((d,p)=>d+p,0);let l="calm",h=e==="high"?"medium":"low",u=.4;if(r>0){const[d,p]=Array.from(n.entries()).reduce((f,m)=>m[1]>f[1]?m:f,["calm",0]);l=d;const g=s.get(d)??(e==="high"?2:1);h=Kt(g),u=Math.min(.95,Math.max(.35,p/(r||1)))}else(e==="medium"||e==="high")&&(l=e==="high"?"tense":"calm",h=e==="high"?"medium":"low",u=e==="high"?.55:.45);return l==="calm"&&e==="medium"&&c>0&&(l="confused",h="medium",u=Math.max(u,.5)),{tone:l,intensity:h,confidence:u}}function qt(a){const e=Math.min(a.length/80,1),t=Math.min((a.match(/!/g)?.length??0)/3,1),n=Math.min((a.match(/\?/g)?.length??0)/3,1),s=e*.3+t*.4+n*.3;return s>.65?"high":s>.35?"medium":"low"}function Yt(a,e){const t=a.trim();return!(!t||/^(hmm+|uh+|mm+)$/.test(t.toLowerCase())||t.length<8&&e==="low")}function Xt(a){if(a.length===0)return{summary:"",keywords:[],speakers:[],tone:"calm",toneIntensity:"low",toneConfidence:.4,energy:"low",hasQuestion:!1,hasExclamation:!1,shouldRespond:!1};const e=a.map(c=>c.text).join(" "),t=Array.from(new Set(a.flatMap(c=>Ft(c.text)).filter(c=>c.length>1))),n=Ht(e),s=qt(e),i=Gt(e,s);return{summary:e.length>160?`${e.slice(0,157)}...`:e,keywords:n,speakers:t,tone:i.tone,toneIntensity:i.intensity,toneConfidence:i.confidence,energy:s,hasQuestion:/\?/.test(e),hasExclamation:/!/.test(e),shouldRespond:Yt(e,s)}}const Jt={low:25e3,medium:15e3,high:8e3},$e=3,fe=5,je=8e3,Qt=3,Ve=5,Zt=12,en=40,tn=3,nn=3,sn=3,We=90,an=30,on=120,we=12e4,Fe=2e4,rn=1.5,te=6e5,cn=12,ln=18e4,hn=2,dn=4,He=18e4,un=6,Ue=["calm","active","peak","cooldown"],ze={calm:24,active:16,peak:8,cooldown:18},mn={calm:{length:1.1,novelty:.9,recency:.65,energy:.75,tone:.9,relevance:1,style:1},active:{length:1,novelty:1,recency:1,energy:1,tone:1,relevance:1,style:1},peak:{length:.85,novelty:1.2,recency:1.3,energy:1.2,tone:1.05,relevance:1,style:.95},cooldown:{length:1.05,novelty:.95,recency:.75,energy:.85,tone:.9,relevance:1,style:1.05}},pn={calm:.6,active:.2,peak:.1,cooldown:.45},ne=new Set(["the","and","you","for","but","that","with","this","have","what","your","from","they","there","will","were","just","about","like","into","when","them","then","than","over","really","gonna"]),gn=[a=>`Density is ${a}; only speak up when you can add a fresh beat.`,a=>`We're pacing for ${a} chatter—skip the obvious takes.`,a=>`Keep reactions lean; the crowd setting is ${a}, so only jump in with something new.`],yn=[a=>`Focus on these cues: ${a}.`,a=>`Anchor your take around ${a}; make the detail feel new.`,a=>`The scene is signaling ${a}—pick a facet we have not echoed.`],fn=["No standout cue? Grab a sensory detail—lighting, posture, props, or pacing.","If keywords blur, spotlight body language, sound design, or background business.","When cues repeat, switch to micro-observations: textures, timing, or reactions off-screen."],wn=["If nothing new comes to mind, answer with [skip].","No fresh angle? Respond with [skip] instead of forcing it.","Only speak when you have something distinct—otherwise reply with [skip]."],bn=[{pattern:/\bhowever\b/gi,replacement:"but"},{pattern:/\btherefore\b/gi,replacement:"so"},{pattern:/\bfurthermore\b/gi,replacement:"also"},{pattern:/\bmoreover\b/gi,replacement:"also"},{pattern:/\bthus\b/gi,replacement:"so"},{pattern:/\bindeed\b/gi,replacement:"honestly"},{pattern:/\bperhaps\b/gi,replacement:"maybe"},{pattern:/\breally\b/gi,replacement:"super"},{pattern:/\bvery\b/gi,replacement:"super"},{pattern:/\babsolutely\b/gi,replacement:"totally"}],Sn=new Set(["really","very","just","like","actually","literally","basically","definitely","totally","maybe","probably","honestly","seriously","kinda","sorta","pretty","quite"]),se=4,ie=9e4,Ke=3e5,kn=.9,vn=.2,En=.5,Tn={calm:["The moment feels steady and grounded—spot a detail that keeps it human.","Atmosphere is relaxed and breathable—find a small but telling observation."],tense:["The air is tight with tension—surface something sharper than last time.","Everything is on edge—dig into what raises the stakes right now.","Tension is coiled—focus on a fresh signal (voice, posture, stakes)."],humorous:["Comedy energy is bubbling—lean into wit without repeating the punch line.","The beat stays playful—angle for a different joke or comparison."],sad:["The mood sinks heavy—pull a new emotional thread instead of rehashing.","Emotion is raw—anchor your take in a fresh, specific detail."],romantic:["The moment is soft and intimate—highlight a new spark or gesture.","Romance glows here—choose a different image than your last reaction."],confused:["The vibe feels uncertain—frame a question or hypothesis we have not heard.","Curiosity clouds the scene—probe a fresh clue instead of repeating doubts."],thrilling:["Adrenaline is surging—describe a vivid beat that shows the momentum.","This feels like a chase—pick a sensory detail that keeps it exciting."],bittersweet:["The mood is bittersweet—balance the lift and ache with new wording.","Tender but aching—spot a nuance that keeps it from sounding recycled."],mystery:["The beat is draped in mystery—surface a clue or hunch we have not voiced.","Suspicion hangs here—point to a fresh lead or unanswered question."]},Mn={low:"Keep it nuanced; highlight a precise detail instead of the broad headline.",medium:"Find a new angle or implication so your take adds fresh value.",high:"Go vivid—use new imagery or stakes instead of repeating earlier adjectives."};class xn{#e=[];#s=new Map;#n=new Map;#t=[];#o=null;#l=new Map;#h=[];#g=new Map;#b=[];#S=[];#y=new Map;#R=new Map;#u=new Map;#k=[];#m=[];#p=[];#N=new Map;#f=[];#i="calm";#L=0;#r=[];#w=new Map;#a=new Map;#T=new Map;#M=new Map;#v=new Map;#c={speechTicBans:0,dynamicBanReleases:0};#x={state:"paused",positionMs:0,contentId:null,updatedAt:0};#F=null;#A="";#H=!1;constructor(){const e=ce();this.#A=e.promptVersion,this.#K(),tt(t=>{this.#A=t.promptVersion,this.#K()})}#oe(e,t,n,s){const i=this.#U(t),o=i.mean+(s?.lengthShift??0),c=Math.max(i.min,Math.min(i.max,o)),l=Math.abs(e-c)/Math.max(1,i.stdDev)*.35;let h=Math.max(0,1-l);if(e<i.min){const u=(i.min-e)/Math.max(1,i.min);h*=Math.max(.35,1-u*.6)}else if(e>i.max){const u=(e-i.max)/Math.max(1,i.max);h*=Math.max(.35,1-u*.7)}return h*=this.#re(n,e,i,s),Math.max(0,Math.min(1,h))}#re(e,t,n,s){const i=n.mean+(s?.lengthShift??0),o=Math.max(n.min,Math.min(n.max,i)),c=t>o,r=Math.abs(t-o)/Math.max(1,n.stdDev);let l=1;switch(e){case"calm":l=c?.85-Math.min(r*.1,.25):1.05+Math.min(r*.08,.2);break;case"active":l=1;break;case"peak":l=c?1.1+Math.min(r*.1,.25):.9-Math.min(r*.05,.2);break;case"cooldown":l=c?.9-Math.min(r*.05,.15):1.05+Math.min(r*.05,.15);break;default:l=1;break}return Math.max(.6,Math.min(1.3,l))}#U(e){if(e.lengthProfile)return e.lengthProfile;const t=e.maxWords,n=Math.min(t-2,Math.max(6,Math.round(t*.65))),s=Math.max(2,Math.round(t*.2)),i=Math.max(4,n-s);return{mean:n,stdDev:s,min:i,max:t}}#ce(e,t){const n=e.stateWeightMultipliers?.[t]??mn[t];return n?{...n}:{}}#le(e,t){const n=e.skipBias?.[t];return typeof n=="number"&&Number.isFinite(n)?Math.max(0,Math.min(1,n)):pn[t]??0}#he(e,t){const n=e.stateCadenceSeconds?.[t]??ze[t],s=Math.max(2,n??ze.active)*1e3;return Math.max(2e3,Math.round(s))}#de(e,t,n,s){const o=this.#n.get(e.id)?.lastEmittedAt??0,c=o===0?Number.MAX_SAFE_INTEGER:n-o,r=e.cadenceSeconds*1e3,l=this.#he(e,t),h=Jt[s.density],u=Math.max(r,l,h),d=c>=u*rn;return{allowEmission:o===0||c>=u||d,dueForEmission:d,minInterval:u,sinceLast:c}}#ue(e,t){const n=e.comment.text.split(/\s+/).filter(Boolean).length;t.lengthObservationCount+=1,t.totalWordCount+=n,t.totalWordCountSquared+=n*n;const s=this.#U(e.persona);t.targetWordCountSum+=s.mean}#me(e,t){const n=this.#S.length/Math.max(1,je/1e3),s=Math.min(n/.35,1),i=e.energy==="high"?1:e.energy==="medium"?.6:.25,o=Math.min(this.#ee(e.tone)/4,1),c=i*.55+s*.3+o*.15;let r;c>=.82?r="peak":c>=.58?r="active":r="calm",this.#i==="peak"&&r==="active"&&t-this.#L<=Fe&&(r="cooldown"),this.#i==="peak"&&r==="calm"&&(r="cooldown"),this.#i==="cooldown"&&(c>=.65?r="active":t-this.#L>Fe&&c<.5?r="calm":r="cooldown"),this.#i!==r?(this.#i=r,this.#L=t,this.#r.push({state:this.#i,timestamp:t})):this.#r.length===0&&this.#r.push({state:this.#i,timestamp:t}),this.#z(t)}#z(e){for(;this.#r.length>1&&e-this.#r[0].timestamp>we;)this.#r.shift();const t=this.#r[0];t&&e-t.timestamp>we&&(t.timestamp=e-we)}#pe(){const e=Date.now();this.#z(e);const t={calm:0,active:0,peak:0,cooldown:0};if(this.#r.length===0)return t;for(let i=0;i<this.#r.length;i+=1){const o=this.#r[i],c=i<this.#r.length-1?this.#r[i+1].timestamp:e,r=Math.max(1,c-o.timestamp);t[o.state]+=r}const n=Ue.reduce((i,o)=>i+t[o],0);if(n===0)return t;const s={calm:0,active:0,peak:0,cooldown:0};return Ue.forEach(i=>{s[i]=t[i]/n}),s}#ge(){if(this.#f.length===0)return{mean:0,stdDev:0};const t=this.#f.reduce((s,i)=>s+i,0)/this.#f.length,n=this.#f.reduce((s,i)=>{const o=i-t;return s+o*o},0)/this.#f.length;return{mean:t,stdDev:Math.sqrt(n)}}#K(){this.#e=et(),this.#s=new Map,this.#n=new Map,this.#l=new Map,this.#y=new Map,this.#u=new Map,this.#R=new Map,this.#k=[],this.#m=[],this.#p=[],this.#w=new Map,this.#a=new Map,this.#T=new Map,this.#M=new Map,this.#v=new Map,this.#e.forEach(t=>{const n=t.preferenceKey??t.basePersonaId??t.id;t.preferenceKey=n,t.basePersonaId=t.basePersonaId??n,t.weight=t.weight??1,t.virtualUser||(t.virtualUser={id:t.id,label:t.name,description:t.systemPrompt,traits:t.toneVariants??[],toneVariant:t.toneVariants?.[0],preferenceKey:n,basePersonaId:t.basePersonaId,weight:t.weight}),this.#s.set(t.id,t),this.#n.set(t.id,{lastEmittedAt:0}),this.#l.set(t.id,[]),this.#y.set(t.id,!1),this.#u.set(t.id,{topics:[],lastText:null,lastAt:0,history:[]}),this.#w.set(t.id,new Map),this.#T.set(t.id,[]),this.#M.set(t.id,new Map),this.#v.set(t.id,[])});const e=Math.max(1,fe*this.#e.length);this.#h.length>e&&(this.#h=this.#h.slice(this.#h.length-e)),this.#E({resetCadence:!0})}updatePlaybackStatus(e){const t=this.#F;this.#x=e,e.contentId&&e.contentId!==this.#o&&(this.#o=e.contentId,this.#t=[],this.#E({resetCadence:!0}),this.#m=[],this.#p=[]),e.state!=="playing"&&this.#y.forEach((n,s)=>{this.#y.set(s,!1)}),typeof t=="number"&&e.positionMs<t-500&&(this.#t=[],this.#E({resetCadence:!0}),this.#m=[],this.#p=[]),e.state==="seeking"&&(this.#E({resetCadence:!0}),this.#m=[],this.#p=[]),this.#F=e.positionMs}async processCueBatch(e,t){if(this.#H=!!t.developerMode,!t.globalEnabled)return y.debug("[orchestrator] Global toggle disabled; ignoring cues."),{comments:[],metrics:this.#j()};const n=e[e.length-1];if(!n)return{comments:[],metrics:this.#j()};if(this.#x.state!=="playing"&&this.#x.updatedAt!==0)return y.debug("[orchestrator] Playback inactive; skipping generation.",{state:this.#x.state}),{comments:[],metrics:this.#j()};this.#we(e);const s=Xt(this.#t);this.#Ie(s.keywords),this.#Re(s),this.#me(s,Date.now());const i=this.#G();if(i.currentEnergyState=this.#i,i.stateCounts[this.#i]+=1,!s.shouldRespond)return i.skippedByHeuristics+=1,this.#C([],i,t);const o=this.#be(n.startTime),c=o.total,r=o.perPersona,l=o.perBasePersona,h=Math.max(0,Qt-c);if(h<=0)return i.skippedByHeuristics+=1,this.#C([],i,t);const u=[],d=this.#ve(s,n.startTime);for(const m of d){const b=m.preferenceKey??m.basePersonaId??m.id;if(!t.personaEnabled[b])continue;i.stateCounts[this.#i]+=1;const I=m.basePersonaId??b,$=I,T=m.virtualUser?.toneVariant??m.toneVariants?.[0],j=m.weight??1;if((r.get(m.id)??0)>=1){i.skippedByHeuristics+=1;continue}if((l.get(I)??0)>=1){i.skippedByHeuristics+=1;continue}if(this.#y.get(m.id)){i.skippedByLock+=1,y.debug("[orchestrator] Persona locked, skipping",{persona:m.id});continue}if(this.#fe(m,n,t,s)){i.skippedByHeuristics+=1,y.debug("[orchestrator] Cue skipped by heuristics",{persona:m.id,cueId:n.cueId});continue}const P=Date.now(),V=this.#de(m,this.#i,P,t);if(!V.allowEmission){i.skippedByThrottle+=1,i.skippedByState+=1,y.debug("[orchestrator] Persona gated by state cadence",{persona:m.id,state:this.#i});continue}if(V.dueForEmission)i.stateForcedEmissions+=1;else{const w=this.#le(m,this.#i);if(w>0&&this.#d(`${m.id}:${n.cueId}:state-skip`)<w){i.skippedByState+=1,i.stateSoftSkips+=1,y.debug("[orchestrator] Persona skipped by state bias",{persona:m.id,state:this.#i,skipBias:w});continue}}const M=P,x=this.#ye(n.cueId,m.id),A=await U.get(x);if(A&&this.#Ce(A,s)){y.debug("[orchestrator] Cache candidate ready",{cacheKey:x});const w=Date.now(),S={...A,id:x,personaId:m.id,text:A.text,createdAt:w,renderAt:n.startTime+500,durationMs:this.#W(A.text)},B=this.#J({persona:m,text:S.text,scene:s,timestamp:w,metrics:i});if(!B.accepted)continue;u.push({persona:m,comment:S,source:"cache",cacheKey:x,keywords:s.keywords,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneEnergy:s.energy,basePersonaId:$,preferenceKey:b,toneVariant:T,weight:j,virtualUser:m.virtualUser,score:0,relevance:B.relevance,styleFit:B.styleFit,promptHash:A.promptHash,finalize:async F=>{this.#X(F,n.cueId,s.keywords),await U.set({...F,cacheKey:x,contentId:n.contentId,personaId:m.id,cueId:n.cueId,promptHash:A.promptHash,promptVersion:this.#A,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneToneConfidence:s.toneConfidence,sceneEnergy:s.energy})}}),i.candidateCount+=1,i.generationLatencyMsTotal+=Date.now()-M;continue}let W=null,z=!1;this.#y.set(m.id,!0);try{const{messages:w,telemetry:S}=this.#Ye({persona:m,preferences:t,scene:s});i.dynamicBanTermsApplied+=S.dynamicBanCount,i.dynamicBanReleases+=S.dynamicBanReleased,S.dynamicBanReleased>0&&(this.#c.dynamicBanReleases=Math.max(0,this.#c.dynamicBanReleases-S.dynamicBanReleased)),i.keywordEvaluations+=S.evaluatedKeywordCount,i.filteredKeywordDrops+=S.filteredKeywordCount,S.toneRepetitionWarning&&(i.toneRepetitionWarnings+=1),S.personaHotwordReminder&&(i.personaHotwordReminders+=1),S.fewShotSelected>0&&(i.fewShotSelections+=S.fewShotSelected),S.fewShotCooldownSkips>0&&(i.fewShotCooldownSkips+=S.fewShotCooldownSkips);const B=this.#ie(m.temperature,.12,.4,1.1,`${m.id}:${n.cueId}:temp`),F=this.#ie(m.topP,.08,.6,.99,`${m.id}:${n.cueId}:topP`),me=Date.now(),Q=await he.complete({personaId:m.id,messages:w,maxTokens:Math.max(64,m.maxWords*2),temperature:B,topP:F}),pe=Date.now()-me;i.llmCalls+=1,i.llmLatencyMsTotal+=pe,z=!!Q.usingFallback;const Z=this.#lt(Q.text,m);if(!Z){i.sanitizedDrops+=1,y.warn("[orchestrator] Sanitized response empty, skipping",{persona:m.id});continue}const K=this.#Ae(Z,m,s,n.cueId),ee=Date.now(),G=this.#J({persona:m,text:K,scene:s,timestamp:ee,metrics:i});if(!G.accepted)continue;const H=ee,E={id:x,personaId:m.id,text:K,createdAt:H,renderAt:n.startTime+500,durationMs:this.#W(K)},R=this.#ct(JSON.stringify(w));W={persona:m,comment:E,source:"llm",cacheKey:x,keywords:s.keywords,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneEnergy:s.energy,basePersonaId:$,preferenceKey:b,toneVariant:T,weight:j,virtualUser:m.virtualUser,usedFallback:z,promptHash:R,score:0,relevance:G.relevance,styleFit:G.styleFit,finalize:async Ie=>{this.#X(Ie,n.cueId,s.keywords),await U.set({...Ie,cacheKey:x,contentId:n.contentId,personaId:m.id,cueId:n.cueId,promptHash:R,promptVersion:this.#A,sceneTone:s.tone,sceneToneIntensity:s.toneIntensity,sceneToneConfidence:s.toneConfidence,sceneEnergy:s.energy})}}}finally{this.#y.set(m.id,!1)}W&&(u.push(W),i.candidateCount+=1,i.generationLatencyMsTotal+=Date.now()-M,z&&(i.fallbackResponses+=1))}if(u.length===0)return this.#C([],i,t);const p=this.#Se(u,h,r,l,i,s,n.startTime);if(p.length===0)return this.#C([],i,t);const g=[];let f=0;for(const m of p){const b={...m.comment,renderAt:this.#xe(n.startTime,f,s,m.persona.id),durationMs:this.#W(m.comment.text)};await m.finalize(b),m.source==="cache"?i.cacheHits+=1:i.cacheMisses+=1,i.generatedCount+=1,g.push(b),this.#ue(m,i),f+=1}return this.#C(g,i,t)}#ye(e,t){return`${e}::${t}`}#E({resetCadence:e=!1}={}){this.#l.forEach((t,n)=>{this.#l.set(n,[])}),this.#u.forEach((t,n)=>{this.#u.set(n,{topics:[],lastText:null,lastAt:0,history:[]})}),this.#y.forEach((t,n)=>{this.#y.set(n,!1)}),this.#R.clear(),this.#h=[],this.#S=[],this.#k=[],this.#g.clear(),this.#b=[],this.#N.clear(),this.#f=[],this.#r=[],this.#i="calm",this.#L=Date.now(),this.#w.forEach(t=>t.clear()),this.#a.clear(),this.#T.forEach(t=>t.splice(0,t.length)),this.#M.forEach(t=>t.clear()),this.#v.forEach(t=>t.splice(0,t.length)),this.#c.speechTicBans=0,this.#c.dynamicBanReleases=0,e&&this.#n.forEach((t,n)=>{this.#n.set(n,{...t,lastEmittedAt:0})}),this.#$("reset",{resetCadence:e,personaCount:this.#e.length,activeContentId:this.#o})}#$(e,t){this.#H&&y.debug("[orchestrator] memory:"+e,{...t,timestamp:Date.now()})}#G(){const e={cacheHits:0,cacheMisses:0,llmCalls:0,llmLatencyMsTotal:0,generationLatencyMsTotal:0,generatedCount:0,candidateCount:0,skippedByThrottle:0,skippedByHeuristics:0,skippedByLock:0,skippedByState:0,duplicatesFiltered:0,sanitizedDrops:0,fallbackResponses:0,prunedByReranker:0,dynamicBanTermsApplied:0,keywordEvaluations:0,filteredKeywordDrops:0,toneRepetitionWarnings:0,personaHotwordReminders:0,duplicateHardRejects:0,semanticRejects:0,lowRelevanceDrops:0,styleFitDrops:0,stateSoftSkips:0,stateForcedEmissions:0,stateCounts:{calm:0,active:0,peak:0,cooldown:0},currentEnergyState:this.#i,lengthObservationCount:0,totalWordCount:0,totalWordCountSquared:0,targetWordCountSum:0,speechTicBans:this.#c.speechTicBans,speechTicViolations:0,dynamicBanReleases:this.#c.dynamicBanReleases,toneAlignmentHits:0,toneAlignmentMisses:0,fewShotSelections:0,fewShotCooldownSkips:0};return this.#c.speechTicBans=0,this.#c.dynamicBanReleases=0,e}#q(e){e.currentEnergyState=this.#i;const t=e.lengthObservationCount,n=t>0?e.totalWordCount/t:0,s=t>0?Math.max(0,e.totalWordCountSquared/t-n*n):0,i=Math.sqrt(s),o=t>0?e.targetWordCountSum/t:0,c=n-o,r=this.#ge(),l=this.#pe();return{timestamp:Date.now(),cacheHits:e.cacheHits,cacheMisses:e.cacheMisses,llmCalls:e.llmCalls,averageLLMLatencyMs:e.llmCalls>0?e.llmLatencyMsTotal/e.llmCalls:0,averageGenerationLatencyMs:e.candidateCount>0?e.generationLatencyMsTotal/e.candidateCount:0,skippedByThrottle:e.skippedByThrottle,skippedByHeuristics:e.skippedByHeuristics,skippedByLock:e.skippedByLock,skippedByState:e.skippedByState,duplicatesFiltered:e.duplicatesFiltered,sanitizedDrops:e.sanitizedDrops,fallbackResponses:e.fallbackResponses,candidatesGenerated:e.candidateCount,prunedByReranker:e.prunedByReranker,cacheSizeGlobalBytes:0,cacheSizeActiveBytes:0,activeContentId:this.#o,windowCommentTotal:this.#S.length,dynamicBanTermsApplied:e.dynamicBanTermsApplied,keywordEvaluations:e.keywordEvaluations,filteredKeywordDrops:e.filteredKeywordDrops,toneRepetitionWarnings:e.toneRepetitionWarnings,personaHotwordReminders:e.personaHotwordReminders,duplicateHardRejects:e.duplicateHardRejects,semanticRejects:e.semanticRejects,lowRelevanceDrops:e.lowRelevanceDrops,styleFitDrops:e.styleFitDrops,stateSoftSkips:e.stateSoftSkips,stateForcedEmissions:e.stateForcedEmissions,energyState:e.currentEnergyState,stateOccupancy:l,lengthMean:n,lengthStdDev:i,lengthDeviation:c,lengthSampleSize:t,lengthRollingMean:r.mean,lengthRollingStdDev:r.stdDev,speechTicBans:e.speechTicBans,speechTicViolations:e.speechTicViolations,dynamicBanReleases:e.dynamicBanReleases,toneAlignmentHits:e.toneAlignmentHits,toneAlignmentMisses:e.toneAlignmentMisses,fewShotSelections:e.fewShotSelections,fewShotCooldownSkips:e.fewShotCooldownSkips}}#j(){return this.#q(this.#G())}async#C(e,t,n){const s=this.#q(t);if(n.developerMode){try{const i=await U.sizeReport();s.cacheSizeGlobalBytes=i.global,s.cacheSizeActiveBytes=this.#o?i.contents[this.#o]??0:0}catch(i){y.warn("[orchestrator] Failed to gather cache metrics",i)}y.debug("[orchestrator] Metrics snapshot",s)}return{comments:e,metrics:s}}#fe(e,t,n,s){const i=t.text.trim();if(!i||!/[a-zA-Z]/.test(i)||this.#R.get(e.id)===t.cueId&&this.#x.state==="playing")return!0;const c=s.energy;if(n.density==="low"){if(!(/[!?]/.test(i)||i.length>=18||s.hasQuestion)||c==="low")return!0}else if(n.density==="medium"&&c==="low"&&i.length<10&&!/[!?]/.test(i))return!0;const r=this.#u.get(e.id);return!!(r&&Date.now()-r.lastAt<5e3&&s.keywords.filter(h=>r.topics.includes(h)).length>=Math.min(2,s.keywords.length))}#we(e){const t=e[e.length-1];if(t){this.#o!==t.contentId&&(this.#o=t.contentId,this.#t=[],this.#E({resetCadence:!0}));for(const n of e)this.#t.some(s=>s.cueId===n.cueId)||this.#t.push(n);this.#t.length>$e&&(this.#t=this.#t.slice(this.#t.length-$e))}}#Y(e){this.#S=this.#S.filter(t=>e-t.timestamp<=je)}#be(e){this.#Y(e);const t=new Map,n=new Map;for(const s of this.#S){t.set(s.personaId,(t.get(s.personaId)??0)+1);const i=this.#s.get(s.personaId),o=i?.basePersonaId??i?.preferenceKey??s.personaId;o&&n.set(o,(n.get(o)??0)+1)}return{total:this.#S.length,perPersona:t,perBasePersona:n}}#X(e,t,n){this.#S.push({timestamp:e.renderAt,personaId:e.personaId}),this.#Y(e.renderAt),this.#ht(e.personaId,e.text,n),this.#R.set(e.personaId,t),this.#rt(e.personaId),this.#$("register",{personaId:e.personaId,cueId:t,text:e.text,keywords:n})}#Se(e,t,n,s,i,o,c){if(t<=0)return[];const r=this.#i;e.forEach(g=>{g.score=this.#ke(g,o,c,r)});const l=[...e].sort((g,f)=>f.score-g.score),h=new Map(n),u=new Map(s),d=[];let p=0;for(const g of l){if(d.length>=t){p+=1;continue}const f=h.get(g.persona.id)??0;if(f>=1){p+=1;continue}const m=u.get(g.basePersonaId)??0;if(m>=1){p+=1;continue}d.push(g),h.set(g.persona.id,f+1),u.set(g.basePersonaId,m+1)}return i.prunedByReranker+=p,d}#J({persona:e,text:t,scene:n,timestamp:s,metrics:i}){const o=this.#Qe(t,s);if(o.hardDuplicate)return i.duplicatesFiltered+=1,i.duplicateHardRejects+=1,{accepted:!1,relevance:0,styleFit:0};if(o.semanticDuplicate)return i.duplicatesFiltered+=1,i.semanticRejects+=1,{accepted:!1,relevance:0,styleFit:0};const c=this.#Ze(t,n);if(c<vn)return i.lowRelevanceDrops+=1,{accepted:!1,relevance:c,styleFit:0};let r=this.#et(t,e);const l=this.#He(e.id,t);l&&(l.source==="speech_tic"?(i.speechTicViolations+=1,r=Math.min(r,.2)):r=Math.min(r,.35));const h=this.#Me(t,e,n,i);return r*=h.multiplier,r=Math.max(0,Math.min(1,r)),r<En?(i.styleFitDrops+=1,{accepted:!1,relevance:c,styleFit:r}):{accepted:!0,relevance:c,styleFit:r}}#ke(e,t,n,s){const i=e.comment.text.split(/\s+/).filter(Boolean).length,o=this.#V(e.persona,e.sceneTone),c=this.#oe(i,e.persona,s,o),r=this.#Ee(e.persona.id,e.keywords),l=this.#n.get(e.persona.id),h=e.persona.cadenceSeconds*1e3,u=l?Date.now()-l.lastEmittedAt:Number.MAX_SAFE_INTEGER,d=Math.min(u/Math.max(1,h),1),p=this.#Q(e.persona,e.sceneEnergy),g=this.#Te(e.toneVariant),f=this.#Z(e.weight),m=e.source==="llm"?.05:0,b=this.#d(`${e.persona.id}:${n}:${e.comment.text}`),I=e.relevance,$=e.styleFit,T=this.#ce(e.persona,s),j=.18*(T.length??1),P=.18*(T.novelty??1),V=.14*(T.recency??1),J=.12*(T.energy??1),M=.12*(T.tone??1),x=.16*(T.relevance??1),A=.1*(T.style??1)*(o?.styleBias??1);return c*j+r*P+d*V+p*J+g*M+I*x+$*A+f*.04+m+b*.06}#ve(e,t){const n=this.#e.map(s=>{const i=this.#n.get(s.id),o=s.cadenceSeconds*1e3,c=i?Date.now()-i.lastEmittedAt:Number.MAX_SAFE_INTEGER,r=Math.min(c/Math.max(1,o),1),l=this.#Q(s,e.energy),h=this.#d(`${t}:${s.id}`),u=this.#Z(s.weight??1),d=r*.45+l*.25+u*.2+h*.1;return{persona:s,score:d}});return n.sort((s,i)=>i.score-s.score),n.map(s=>s.persona)}#Q(e,t){const n=e.toneVariants??[],s=i=>n.includes(i);return t==="high"?s("snark")||s("hype")?1:s("precise")?.85:.7:t==="medium"?s("precise")||s("warm")?.9:.75:s("warm")||s("wistful")?1:s("precise")?.8:.6}#Ee(e,t){if(t.length===0)return .5;const n=this.#u.get(e);if(!n)return 1;const s=new Set(n.topics.map(o=>o.toLowerCase()));return t.map(o=>o.toLowerCase()).filter(o=>!s.has(o)).length/t.length}#Te(e){if(!e)return .6;if(this.#k.length===0)return 1;const t=this.#k.lastIndexOf(e);if(t===-1)return 1;const n=this.#k.length-t;return .4+Math.min(n/4,1)*.6}#Z(e){return Math.max(.3,Math.min(e,2))/2}#V(e,t){return e.toneAdjustments?.[t]}#Me(e,t,n,s){const i=this.#V(t,n.tone);if(!i)return s.toneAlignmentHits+=1,{multiplier:1,alignment:1,styleBias:1};const o=e.toLowerCase();let c=1,r=1;if(i.preferLexical&&i.preferLexical.length>0&&(i.preferLexical.some(h=>o.includes(h.toLowerCase()))||(c-=.2,r*=.9)),i.avoidLexical&&i.avoidLexical.length>0&&i.avoidLexical.some(h=>o.includes(h.toLowerCase()))&&(c-=.4,r*=.6),i.punctuation&&i.punctuation!=="none"){const l=e.trim(),h=l.charAt(l.length-1);let u=!1;i.punctuation==="exclaim"?u=h==="!":i.punctuation==="question"?u=h==="?":i.punctuation==="ellipsis"?u=/\.\.\.$/.test(l):i.punctuation==="period"&&(u=h==="."),u||(c-=.2,r*=.9)}return c=Math.max(0,Math.min(1,c)),c>=.75?s.toneAlignmentHits+=1:s.toneAlignmentMisses+=1,{multiplier:r,alignment:c,styleBias:i.styleBias??1}}#xe(e,t,n,s){const i=n.energy==="high"?350:n.energy==="medium"?550:800,o=Math.floor(this.#d(`${s}:${e}:${t}`)*400),c=t*260;return e+i+o+c}#W(e){const i=5200+(e.split(/\s+/).filter(Boolean).length-10)*220;return Math.max(4e3,Math.min(9e3,i))}#Ae(e,t,n,s){let i=e.replace(/\s+/g," ").trim();if(t.speechTics&&t.speechTics.length>0){const c=this.#d(`${t.id}:${s}:tic`);if(c>.68){const r=Math.floor(this.#d(`${s}:${t.id}:pick`)*t.speechTics.length),l=t.speechTics[r%t.speechTics.length]?.trim();l&&(i=c>.84?`${i}, ${l}`:`${l} ${i}`)}}if(!/[.!?…]$/.test(i)){const c=this.#d(`${t.id}:${s}:punct`);n.energy==="high"&&c>.35?i=`${i}!`:c>.7?i=`${i}...`:i=`${i}.`}this.#d(`${t.id}:${s}:trim`)>.85&&(i=i.replace(/[.]+$/,"")),i=this.#Xe(i),i=i.replace(/\s+/g," ").trim();const o=i.split(/\s+/).filter(Boolean);if(o.length>t.maxWords){const c=this.#it(o,t.maxWords);if(!c)return"";i=c.trim()}if(i.length>We){const c=this.#at(i.split(/\s+/).filter(Boolean),We);if(!c)return"";i=c.trim()}return i}#Ce(e,t){return!(!e||!e.promptVersion||e.promptVersion!==this.#A||!e.sceneTone||e.sceneTone!==t.tone||e.sceneToneIntensity&&e.sceneToneIntensity!==t.toneIntensity||!e.sceneEnergy||e.sceneEnergy!==t.energy)}#d(e){let t=0;for(let s=0;s<e.length;s+=1)t=Math.imul(31,t)+e.charCodeAt(s);const n=Math.sin(t)*1e4;return n-Math.floor(n)}#Ie(e){if(!(!e||e.length===0)){for(e.forEach(t=>{const n=t.toLowerCase();!n||ne.has(n)||this.#p.push(n)});this.#p.length>en;)this.#p.shift();this.#$e(Date.now())}}#dt(){return this.#_()}#Re(e){for(this.#m.push(e.tone);this.#m.length>Zt;)this.#m.shift()}#ee(e){let t=0;for(let n=this.#m.length-1;n>=0&&this.#m[n]===e;n-=1)t+=1;return t}#Le(e){if(!e)return[];const t=e.toLowerCase().match(/[a-z0-9']+/g);return t?t.filter(n=>n.length>3&&!ne.has(n)):[]}#De(e,t,n){const s=Date.now();this.#Pe(e,t,s),this.#Be(e,s)}#Pe(e,t,n){const s=this.#s.get(e);if(!s||!s.speechTics||s.speechTics.length===0)return;const i=this.#T.get(e)??[],o=t.toLowerCase();s.speechTics.forEach(l=>{const h=l.toLowerCase().trim();if(!h)return;new RegExp(`\\b${this.#Ue(h)}\\b`,"i").test(o)&&i.push({token:h,timestamp:n})});const c=i.filter(l=>n-l.timestamp<=ln);this.#T.set(e,c);const r=new Map;c.forEach(l=>{r.set(l.token,(r.get(l.token)??0)+1)}),r.forEach((l,h)=>{l>hn&&this.#te(e,h,"speech_tic",n)&&(this.#c.speechTicBans+=1)})}#Be(e,t){const n=this.#u.get(e);if(!n)return;const s=n.history.slice(-5);if(s.length===0)return;const i=new Map;s.forEach(o=>{const c=this.#Le(o.text??"");c.forEach(r=>{i.set(r,(i.get(r)??0)+1)});for(let r=0;r<c.length-1;r+=1){const l=c[r],h=c[r+1];if(!l||!h)continue;const u=`${l} ${h}`;i.set(u,(i.get(u)??0)+1)}(o.keywords??[]).forEach(r=>{const l=r.toLowerCase();!l||l.length<=3||ne.has(l)||i.set(l,(i.get(l)??0)+1)})}),i.forEach((o,c)=>{o>=tn&&this.#te(e,c,"keyword",t)})}#te(e,t,n,s){const i=this.#w.get(e);if(!i)return!1;const o=t.toLowerCase(),c=i.get(o);if(c&&c.expiresAt>s)return c.expiresAt=s+te,c.hits+=1,!1;const r={token:o,source:n,createdAt:s,expiresAt:s+te,hits:c?c.hits+1:1};return i.set(o,r),this.#_e(e,i),!c}#_e(e,t){for(;t.size>sn;){const n=Array.from(t.entries()).sort((s,i)=>s[1].createdAt-i[1].createdAt)[0];if(!n)break;t.delete(n[0]),this.#c.dynamicBanReleases+=1}this.#D(e)}#D(e){const t=this.#w.get(e);if(!t||t.size===0)return;const n=Date.now();Array.from(t.entries()).forEach(([s,i])=>{i.expiresAt<=n&&t.delete(s)})}#Oe(e,t){const n=e.toLowerCase(),s=this.#a.get(n);if(s&&s.expiresAt>t){s.expiresAt=t+te,s.hits+=1;return}this.#a.set(n,{token:n,source:"global",createdAt:t,expiresAt:t+te,hits:s?s.hits+1:1}),this.#Ne()}#Ne(){for(;this.#a.size>cn;){const e=Array.from(this.#a.entries()).sort((t,n)=>t[1].createdAt-n[1].createdAt)[0];if(!e)break;this.#a.delete(e[0]),this.#c.dynamicBanReleases+=1}this.#P()}#P(e=Date.now()){this.#a.size!==0&&Array.from(this.#a.entries()).forEach(([t,n])=>{n.expiresAt<=e&&this.#a.delete(t)})}#$e(e){if(this.#p.length===0)return;const t=new Map;this.#p.forEach(n=>{t.set(n,(t.get(n)??0)+1)}),t.forEach((n,s)=>{n>=nn&&this.#Oe(s,e)}),this.#P(e)}#B(e){this.#D(e);const t=this.#w.get(e);return t?Array.from(t.keys()):[]}#_(){return this.#P(),Array.from(this.#a.keys())}#je(e){this.#D(e);const t=this.#w.get(e);return t?Array.from(t.values()):[]}#Ve(e){return this.#je(e).filter(t=>t.source==="speech_tic").map(t=>t.token)}#We(e){const t=this.#w.get(e);if(!t||t.size===0)return null;const n=Array.from(t.entries()).sort((s,i)=>s[1].createdAt-i[1].createdAt)[0];return n?(t.delete(n[0]),this.#c.dynamicBanReleases+=1,n[1].token):null}#Fe(){if(this.#a.size===0)return null;const e=Array.from(this.#a.entries()).sort((t,n)=>t[1].createdAt-n[1].createdAt)[0];return e?(this.#a.delete(e[0]),this.#c.dynamicBanReleases+=1,e[1].token):null}#He(e,t){const n=t.toLowerCase(),s=this.#w.get(e);if(s){for(const[i,o]of s.entries())if(n.includes(i))return o.hits+=1,o}for(const[i,o]of this.#a.entries())if(n.includes(i))return o.hits+=1,o;return null}#Ue(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}#ut(e){return this.#B(e)}#ze(e,t){this.#D(e),this.#P();let n=this.#B(e),s=this.#_(),i=new Set([...n,...s]),o=t.filter(r=>{const l=r.toLowerCase();return!i.has(l)});const c=[];if(o.length===0&&t.length>0&&i.size>0){const r=this.#We(e);if(r)c.push(r);else{const l=this.#Fe();l&&c.push(l)}n=this.#B(e),s=this.#_(),i=new Set([...n,...s]),o=t.filter(l=>{const h=l.toLowerCase();return!i.has(h)})}if(o.length===0&&t.length>0){const r=t.find(l=>{const h=l.toLowerCase();return h&&!ne.has(h)});r&&(o.push(r),i.delete(r.toLowerCase()),n=this.#B(e),s=this.#_())}return{filteredKeywords:o,personaHotWords:n,globalHotWords:s,dynamicBans:Array.from(i),releasedTokens:c}}#Ke(e,t){const n=e.fewShotExamples??[];if(n.length===0)return{examples:[],cooled:0};const s=Date.now(),i=this.#M.get(e.id)??new Map,o=this.#v.get(e.id)??[],c=n.map(d=>{let p=0;if(d.sceneTag&&d.sceneTag===t.tone&&(p+=1.5),d.energy&&d.energy===t.energy&&(p+=1),d.tags&&d.tags.length>0){const m=new Set(t.keywords.map(b=>b.toLowerCase()));d.tags.some(b=>m.has(b.toLowerCase()))&&(p+=.4)}d.lexicalShape&&o.includes(d.lexicalShape.toLowerCase())&&(p-=.35);const g=i.get(d.id)??0,f=s-g;if(f<He){const m=.7*(1-f/He);p-=m}return{example:d,score:p,lastUsed:g}});c.sort((d,p)=>p.score-d.score);const r=[],l=new Set;let h=0;for(const d of c){if(r.length>=Math.min(dn,n.length))break;const p=d.example.lexicalShape?.toLowerCase();if(p&&l.has(p)){h+=1;continue}r.push(d.example),p&&l.add(p)}r.forEach(d=>{i.set(d.id,s)}),this.#M.set(e.id,i);const u=this.#v.get(e.id)??[];for(r.forEach(d=>{d.lexicalShape&&u.push(d.lexicalShape.toLowerCase())});u.length>un;)u.shift();return this.#v.set(e.id,u),{examples:r,cooled:h}}#Ge(e,t){const n=Tn[t.tone]??[`The scene leans ${t.tone}—call out a detail that keeps it fresh.`],s=this.#t.map(g=>g.cueId).join("|"),i=Math.floor(this.#d(`${t.tone}:${s}`)*n.length),o=n[i%n.length],c=Mn[t.toneIntensity],r=t.toneConfidence<.5?"Tone signal feels tentative—anchor the take in concrete observations.":"",l=t.energy!=="medium"?` Energy: ${t.energy}.`:"",h=this.#V(e,t.tone),u=h?.preferLexical?.length?` Lean on expressions like ${h.preferLexical.join(", ")} when natural.`:"",d=h?.avoidLexical?.length?` Avoid leaning on phrases such as ${h.avoidLexical.join(", ")}.`:"",p=h?.punctuation&&h.punctuation!=="none"?` End with ${h.punctuation==="exclaim"?"an exclamation":h.punctuation==="question"?"a question mark":h.punctuation==="ellipsis"?"an ellipsis":"a period"} if it fits.`:"";return`${o} Intensity: ${t.toneIntensity}. ${c}${r?` ${r}`:""}${l}${u}${d}${p}`.trim()}#qe(e){const t=this.#ee(e.tone);return t<=1?null:t>=3?`We have stayed in this ${e.tone} pocket for ${t} beats—ban your previous adjectives and spotlight a different facet (sensory cues, stakes, body language).`:`This ${e.tone} vibe just repeated—pivot to a new angle or micro-detail instead of echoing earlier wording.`}#Ye({persona:e,preferences:t,scene:n}){const s=Date.now(),i=nt(this.#t),o=this.#t.map(E=>E.cueId).join("|")||"no-cue",c=st(e.styleGuidelines),l=this.#O(`density:${t.density}:${o}`,gn)(t.density),h=this.#ze(e.id,n.keywords),u=h.filteredKeywords,d=h.dynamicBans,p=`keywords:${o}:${u.join("|")}`,g=u.length?this.#O(p,yn)(u.join(", ")):this.#O(`keywords:fallback:${o}`,fn),f=this.#Ve(e.id),m=this.#Ke(e,n),b=new Set,I=[];e.disallowedPhrases.forEach(E=>{const R=E.toLowerCase();b.has(R)||(b.add(R),I.push(E))}),d.forEach(E=>{const R=E.toLowerCase();b.has(R)||(b.add(R),I.push(E))});const $=I.length?`尽量避免重复使用这些词: ${I.join(", ")}，若必须提及请换个角度或同义表达。`:null,T=f.length?`你的口头禅「${f.join("、")}」最近出现太多，本轮请不要再使用。`:null,j=this.#Ge(e,n),P=this.#qe(n),V=n.speakers.length?`Speakers in focus: ${n.speakers.join(", ")}.`:"Speaker unknown—react as an engaged viewer.",J=this.#O(`skip:${e.id}:${o}`,wn),M=this.#u.get(e.id),x=M?.lastText?`Previously you reacted with "${M.lastText}" about ${Math.max(1,Math.round((s-M.lastAt)/1e3))} seconds ago. Refer back only if it deepens your point.`:"You have not reacted recently in this scene.",A=M?.topics?.length?`Topics you touched recently: ${M.topics.join(", ")}.`:"",W=M?.history?.length?M.history.slice(-Ve).map(E=>`- ${Math.max(1,Math.round((s-E.at)/1e3))}s ago you said "${E.text}"`).join(`
`):"",z=h.personaHotWords.length?`Words you've leaned on lately: ${h.personaHotWords.join(", ")}. Switch up your wording this time.`:"",w=e.virtualUser,S=w?`You are speaking as ${w.label}${w.description?` (${w.description})`:""}.`:`You are speaking as ${e.name}.`,B=w?.traits?.length?`Traits to convey: ${w.traits.join(", ")}.`:"",F=w?.toneVariant?`Maintain a ${w.toneVariant} vibe unless the scene demands a softer touch.`:"",me=e.speechTics?.length?`Expressions you sometimes use: ${e.speechTics.join(", ")}. Drop at most one when it fits naturally.`:"",Q="You are part of a lively virtual crowd; only jump in when your perspective adds something human and fresh.",pe=w?`Keep the voice consistent with ${w.label}.`:"",Z=[e.systemPrompt,S,B,F,me,Q,`Keep it under ${e.maxWords} words.`,"Speak like a human watcher, not a narrator. Use everyday spoken English with natural contractions and occasional slang only when it fits.","Avoid quoting the subtitles verbatim; focus on your reaction or insight.",l,j,P,V,g,T,$,J].filter(Boolean).join(" "),K=n.summary||i,ee=[x,A,W?`Recent remarks:
${W}`:"",z].filter(Boolean).join(`
`),G=[`Scene summary: ${K}`,`Subtitle window:
${i}`,`Guidelines:
${c}`,ee,pe,"Instruction: Respond in one short spoken-style sentence. Keep it natural, as if chatting with friends."].filter(Boolean).join(`
`),H=[{role:"system",content:Z}];return m.examples.forEach(E=>{H.push({role:"user",content:E.user}),H.push({role:"assistant",content:E.assistant})}),H.push({role:"user",content:G}),{messages:H,telemetry:{dynamicBanCount:d.length,dynamicBanReleased:h.releasedTokens.length,evaluatedKeywordCount:n.keywords.length,filteredKeywordCount:n.keywords.length-u.length,toneRepetitionWarning:!!P,personaHotwordReminder:h.personaHotWords.length>0,speechTicReminder:f.length>0,fewShotSelected:m.examples.length,fewShotCooldownSkips:m.cooled}}}#Xe(e){if(!e)return e;let t=e;return bn.forEach(({pattern:n,replacement:s})=>{t=t.replace(n,i=>this.#Je(i,s))}),t}#Je(e,t){return e?e===e.toUpperCase()?t.toUpperCase():e[0]===e[0].toUpperCase()?t.charAt(0).toUpperCase()+t.slice(1):t:t}#Qe(e,t){const n=e.toLowerCase(),s=this.#h.includes(n),i=this.#I(e);let o=!1;if(i.length>=se){const r=this.#ne(i,se);for(const l of r){const h=this.#g.get(l);if(!(!h||h.length===0)){for(;h.length>0&&t-h[0]>ie;)h.shift();if(h.length===0){this.#g.delete(l);continue}if(t-h[h.length-1]<=ie){o=!0;break}}}}let c=!1;if(!o)for(const r of this.#b){if(t-r.timestamp>Ke)continue;if(this.#st(i,r.tokens)>=kn){c=!0;break}}return{hardDuplicate:s||o,semanticDuplicate:c}}#Ze(e,t){const n=this.#I(e);if(n.length===0)return 0;const s=new Set(n);let i=0;t.keywords.length>0&&(i=t.keywords.filter(p=>s.has(p.toLowerCase())).length/t.keywords.length);let o=0;if(t.speakers.length>0){const d=e.toLowerCase();o=t.speakers.filter(g=>d.includes(g.toLowerCase())).length/t.speakers.length}const c=t.hasQuestion&&/\?/u.test(e)?1:0,r=t.hasExclamation&&/!/u.test(e)?1:0;let l=0;if(t.summary){const d=this.#I(t.summary);if(d.length>0){const p=new Set(d);let g=0;n.forEach(f=>{p.has(f)&&(g+=1)}),l=Math.min(g/Math.max(4,d.length),1)}}const h=Math.min(n.length/14,1),u=i*.4+o*.15+c*.1+r*.05+l*.2+h*.1;return Math.max(.15,Math.min(1,u))}#et(e,t){const n=e.trim();if(!n)return 0;const i=this.#I(n).length;if(i===0||i>t.maxWords)return 0;const o=t.maxWords,c=1-Math.min(Math.abs(i-o)/Math.max(1,o),1),r=/[.!?…]$/u.test(n)?1:.4,l=/^[A-Z]/u.test(n)?1:.6,h=n.toLowerCase();if(t.disallowedPhrases.some(p=>h.includes(p.toLowerCase())))return 0;const d=c*.5+r*.3+l*.2;return Math.max(0,Math.min(1,d))}#I(e){const t=e.toLowerCase().match(/[a-z0-9']+/g);return t?t.filter(Boolean):[]}#ne(e,t){const n=[];for(let s=0;s<=e.length-t;s+=1)n.push(e.slice(s,s+t).join(" "));return n}#tt(e,t){if(e.length<se){this.#se(t);return}const n=this.#ne(e,se);for(const s of n){const i=this.#g.get(s)??[];for(i.push(t);i.length>0&&t-i[0]>ie;)i.shift();this.#g.set(s,i)}this.#se(t)}#se(e){for(const[t,n]of this.#g.entries()){for(;n.length>0&&e-n[0]>ie;)n.shift();n.length===0&&this.#g.delete(t)}}#nt(e){for(;this.#b.length>0&&e-this.#b[0].timestamp>Ke;)this.#b.shift()}#st(e,t){if(e.length===0||t.length===0)return 0;const n=new Set(e),s=new Set(t);let i=0;for(const c of n)s.has(c)&&(i+=1);const o=n.size+s.size-i;return o===0?0:i/o}#ie(e,t,n,s,i){const o=(this.#d(i)-.5)*t,c=e+o;return Math.max(n,Math.min(s,c))}#it(e,t){const n=[...e];for(;n.length>t&&this.#ae(n););return n.length>t?"":n.join(" ")}#at(e,t){const n=[...e];let s=n.join(" ");for(;s.length>t&&this.#ae(n);)s=n.join(" ");return s.length>t?"":s}#ae(e){for(let t=e.length-2;t>0;t-=1){const n=this.#ot(e[t]);if(Sn.has(n))return e.splice(t,1),!0}return e.length>2?(e.splice(e.length-2,1),!0):!1}#ot(e){return e.replace(/[.,!?;:]+$/g,"").toLowerCase()}#O(e,t){if(t.length===0)throw new Error("[orchestrator] Attempted to pick from empty list");const n=Math.floor(this.#d(e)*t.length);return t[n%t.length]}#rt(e){const t=this.#n.get(e)??{lastEmittedAt:0};t.lastEmittedAt=Date.now(),this.#n.set(e,t)}getActiveContentId(){return this.#o}resetAfterRegeneration(){this.#t=[],this.#E({resetCadence:!0}),this.#m=[],this.#p=[]}#ct(e){let t=0;for(let n=0;n<e.length;n+=1)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(36)}#lt(e,t){if(!e)return"";let n=e.trim();if(/^\[skip\]$/i.test(n))return"";const s=n.length;n=n.replace(/^"+|"+$/g,""),n=n.replace(/^[\[\(].*?[\]\)]\s*/g,""),n=n.replace(/\s+/g," ").trim();for(const i of t.disallowedPhrases){const o=new RegExp(i,"i");o.test(n)&&(n=n.replace(o,"").trim())}return n.length===0?"":(s!==n.length&&y.debug("[orchestrator] Sanitized LLM response",{persona:t.id,originalLength:s,sanitizedLength:n.length}),n)}#ht(e,t,n){const s=t.toLowerCase(),i=this.#l.get(e)??[];for(i.push(s);i.length>fe;)i.shift();for(this.#l.set(e,i),this.#h.push(s);this.#h.length>fe*this.#e.length;)this.#h.shift();const o=Date.now(),c=this.#I(t);this.#tt(c,o),this.#b.push({timestamp:o,tokens:c}),this.#nt(o);const r=this.#N.get(e)??[];for(r.push(c.length);r.length>an;)r.shift();for(this.#N.set(e,r),this.#f.push(c.length);this.#f.length>on;)this.#f.shift();const l=this.#u.get(e)??{topics:[],history:[]},h=[...l.topics,...n].filter(Boolean).map(f=>f.toLowerCase()),u=Array.from(new Set(h)).slice(-5),d=[...l.history??[],{text:t,at:o,keywords:n}];for(;d.length>Ve;)d.shift();this.#u.set(e,{topics:u,lastText:t,lastAt:o,history:d});const p=this.#s.get(e),g=p?.virtualUser?.toneVariant??p?.toneVariants?.[0];if(g)for(this.#k.push(g);this.#k.length>8;)this.#k.shift();this.#De(e,t,n),this.#$("remember",{personaId:e,text:t,keywords:n,topics:u,historySize:d.length})}}const ae=new xn,D="netflix-ai-danmaku::feedback-log";class An{async record(e){const t=e.createdAt??Date.now(),n={id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${t}-${Math.random().toString(36).slice(2,8)}`,category:e.category,note:e.note??null,createdAt:t},s=await chrome.storage.local.get(D),o=[...Array.isArray(s?.[D])?s[D]:[],n].slice(-200);return await chrome.storage.local.set({[D]:o}),n}async list(){const e=await chrome.storage.local.get(D);return Array.isArray(e?.[D])?e[D]:[]}async clear(){await chrome.storage.local.set({[D]:[]})}}const Cn=new An,In={alex:!0,jordan:!0,sam:!0,casey:!0},Ae={globalEnabled:!0,density:"medium",personaEnabled:{...In},developerMode:!1,lastUpdated:Date.now()},oe="netflix-ai-danmaku::preferences";class Rn{#e=null;#s=new Set;async get(){if(this.#e)return this.#e;const e=await chrome.storage.local.get(oe);return e?.[oe]?(this.#e=e[oe],this.#e):(this.#e=Ae,await this.set(Ae),this.#e)}async set(e){this.#e={...e,lastUpdated:Date.now()},await chrome.storage.local.set({[oe]:this.#e}),this.#n()}async update(e){const t=await this.get(),n={...t,...e,personaEnabled:{...t.personaEnabled,...e.personaEnabled},lastUpdated:Date.now()};await this.set(n)}subscribe(e){return this.#s.add(e),()=>this.#s.delete(e)}#n(){this.#e&&this.#s.forEach(e=>e(this.#e))}}const ue=new Rn;chrome.runtime.onInstalled.addListener(()=>{y.info("Netflix AI Danmaku extension installed.")});Bt().catch(a=>{y.error("[background] Failed to initialize persona registry",a)});let N=null;const X=new Map;async function re(){return N||(N=await ue.get()),N}ue.subscribe(a=>{N=a,y.setLevel(a.developerMode?"debug":"info")});chrome.runtime.onMessage.addListener((a,e,t)=>((async()=>{switch(a.type){case"PING":{t({type:"PONG",timestamp:Date.now()});return}case"REQUEST_PREFERENCES":{const n=await re();t({type:"PREFERENCES_RESPONSE",preferences:n});return}case"UPDATE_PREFERENCES":{const n=await re(),s={...n,...a.preferences,personaEnabled:{...n.personaEnabled,...a.preferences.personaEnabled},lastUpdated:Date.now()};await ue.set(s),await chrome.runtime.sendMessage({type:"PREFERENCES_RESPONSE",preferences:s}),t({type:"PREFERENCES_RESPONSE",preferences:s});return}case"CUES_BATCH":{if(!e.tab?.id){y.warn("[background] Received cues without tab context.");return}const n=await re(),{comments:s,metrics:i}=await ae.processCueBatch(a.cues,n);s.length>0&&await chrome.tabs.sendMessage(e.tab.id,{type:"COMMENTS_BATCH",comments:s}),n.developerMode&&await chrome.tabs.sendMessage(e.tab.id,{type:"METRICS_UPDATE",metrics:i}),e.tab?.id!==void 0&&await Dn(e.tab.id,i),t({type:"RENDER_STATUS",status:"idle"});return}case"PLAYBACK_STATUS_UPDATE":{ae.updatePlaybackStatus(a.status),a.status.state==="seeking"&&a.status.contentId&&Number.isFinite(a.status.positionMs)&&a.status.positionMs>=0&&await U.purgeFuture(a.status.contentId,a.status.positionMs),t({type:"RENDER_STATUS",status:"idle"});return}case"REQUEST_LLM_STATUS":{const n=e.tab?.id,i=(n!==void 0?X.get(n):null)??he.getLastStatus();n!==void 0&&X.set(n,i),t({type:"LLM_STATUS_UPDATE",status:i});return}case"REQUEST_PROMPT_VARIANTS":{const n=Ne().map(i=>({id:i.id,label:i.label,promptVersion:i.promptVersion,description:i.description})),s=ce();t({type:"PROMPT_VARIANTS_RESPONSE",activeId:s.id,variants:n});return}case"SET_PROMPT_VARIANT":{if(typeof a.id=="string")try{await Pt(a.id)}catch(i){y.warn("[background] Failed to set prompt variant",i)}const n=Ne().map(i=>({id:i.id,label:i.label,promptVersion:i.promptVersion,description:i.description})),s=ce();t({type:"PROMPT_VARIANTS_RESPONSE",activeId:s.id,variants:n});return}case"SUBMIT_USER_FEEDBACK":{try{const n=await Cn.record({category:a.feedback.category,note:a.feedback.note??null});y.info("[background] Feedback captured",{category:n.category,note:n.note}),t({type:"USER_FEEDBACK_RECORDED",entryId:n.id})}catch(n){y.warn("[background] Failed to record feedback",n),t({type:"USER_FEEDBACK_RECORDED",entryId:""})}return}case"REGENERATE_FROM_TIMESTAMP":{if(!(await re()).globalEnabled){t({type:"RENDER_STATUS",status:"idle"});return}N?.lastUpdated;let s=ae.getActiveContentId();!s&&e.tab?.id!==void 0&&(s=await Ln(e.tab.id)),s&&Number.isFinite(a.timestamp)&&a.timestamp>=0&&(await U.purgeFuture(s,a.timestamp),ae.resetAfterRegeneration()),t({type:"RENDER_STATUS",status:"idle"});return}default:y.warn("[background] Unknown message type",a)}})().catch(n=>{y.error("[background] Message handler error",n),t({type:"RENDER_STATUS",status:"error",detail:String(n)})}),!0));chrome.alarms.create("keepalive",{periodInMinutes:4});chrome.alarms.onAlarm.addListener(a=>{a.name==="keepalive"&&chrome.runtime.getPlatformInfo(()=>{y.debug("[background] keepalive ping")})});chrome.tabs.onRemoved.addListener(a=>{X.delete(a)});async function Ln(a){try{const e=await chrome.tabs.sendMessage(a,{type:"REQUEST_ACTIVE_CONTENT_ID"});if(e&&e.type==="ACTIVE_CONTENT_ID_RESPONSE")return e.contentId}catch(e){y.warn("[background] Failed to obtain active content id",e)}return null}async function Dn(a,e){const t=he.getLastStatus(),n={level:t.level,detail:t.detail};if(n.level!=="error"&&e.fallbackResponses>0){const i=`使用占位响应 ${e.fallbackResponses} 条`;n.level="degraded",n.detail=n.detail?`${n.detail}; ${i}`:i}const s=X.get(a);if(!(s&&s.level===n.level&&s.detail===n.detail)){X.set(a,n);try{await chrome.tabs.sendMessage(a,{type:"LLM_STATUS_UPDATE",status:n})}catch(i){y.debug("[background] Failed to broadcast LLM status",i)}}}const Pn="https://api.laozhang.ai/v1/chat/completions",Bn="sk-D4qOhVgUNgCXDNdzC91cB185097d40749684F182B494914b";he.configure({endpoint:Pn,apiKey:Bn});chrome.runtime.onConnect.addListener(a=>{if(a.name==="persona-stream"){const e=()=>{const n=ce(),s=et();a.postMessage({personas:s,variantId:n.id,promptVersion:n.promptVersion})},t=tt(()=>{try{e()}catch(n){y.warn("[background] Failed to push persona variant update",n)}});e(),a.onDisconnect.addListener(()=>{t()})}});(async()=>(N=await ue.get()??Ae,y.setLevel(N.developerMode?"debug":"info")))();
