import{s as p}from"./messages-BONoywxy.js";const j=200,X=5e3;function K(){return window.netflix?.appContext?.state?.playerApp?.getAPI().videoPlayer}async function B(){const t=Date.now();return new Promise(e=>{const n=()=>{const o=K(),a=o?.getAllPlayerSessionIds()[0];if(o&&a){const s=o.getVideoPlayerBySessionId(a);if(s){e(s);return}}if(Date.now()-t>=X){e(null);return}window.setTimeout(n,j)};n()})}const Q=400,Y=3,C='.player-timedtext, [data-uia="player-timedtext"]';function J(){const t={player:null,teardownFns:[],batch:[],batchTimer:null,lastDomCueSignature:null};function e(s,i){!s.text.trim()||s.text.trim().length<Y||(t.batch.push(s),t.batchTimer===null&&(t.batchTimer=window.setTimeout(()=>{const r=[...t.batch];t.batch=[],t.batchTimer=null,r.length>0&&i(r)},Q)))}function n(s){const i=r=>{if(!(r.text?.trim()??""))return;const u=A(t.player),c=I(r,u,"netflix-api");e(c,s)};!t.player||typeof t.player.on!="function"||(t.player.on("timedTextCueEntered",i),t.teardownFns.push(()=>{try{t.player?.off?.("timedTextCueEntered",i)}catch(r){console.warn("[content] Failed to detach Netflix cue handler",r)}}))}function o(s){let i=null;const r=new MutationObserver(()=>{const c=document.querySelector(C);!c||c===i||(i=c,d.disconnect(),d.observe(c,{childList:!0,subtree:!0}))}),d=new MutationObserver(()=>{const c=i??document.querySelector(C);if(!c)return;const m=ee(c);if(!m)return;const f=`${m}::${Math.floor(Date.now()/1e3)}`;if(t.lastDomCueSignature===f)return;t.lastDomCueSignature=f;const b=t.player?.getCurrentTime?.()??performance.now(),l={text:m,startTime:b,endTime:b+3e3},h=I(l,A(t.player),"dom-fallback");e(h,s)});r.observe(document.body,{childList:!0,subtree:!0});const u=document.querySelector(C);u&&(i=u,d.observe(u,{childList:!0,subtree:!0})),t.teardownFns.push(()=>{r.disconnect(),d.disconnect(),i=null})}async function a(s){return t.player=await B(),t.player?(console.info("[content] Netflix video player attached."),n(s)):console.warn("[content] Netflix video player not detected within timeout. Falling back to DOM observer."),o(s),()=>{t.batchTimer!==null&&(window.clearTimeout(t.batchTimer),t.batchTimer=null),t.teardownFns.forEach(i=>{try{i()}catch(r){console.warn("[content] Error during subtitle observer teardown",r)}}),t.teardownFns=[],t.player=null,t.lastDomCueSignature=null}}return{start:a}}function I(t,e,n){const o=Math.max(0,t.startTime??0),a=t.endTime??o,s=Math.max(0,a-o),i=t.id||`${Math.round(o)}-${Math.round(a)}-${Z(t.text)}`;return{contentId:e,text:t.text.trim(),startTime:o,endTime:a,duration:s,cueId:`${e}-${i}`,source:n}}function Z(t){let e=0;for(let n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e).toString(36)}function A(t){const e=t?.getVideoData?.(),n=e?.movieId??e?.title??"unknown";return String(n)}function ee(t){return Array.from(t.querySelectorAll("span")).map(n=>n.textContent?.trim()??"").filter(Boolean).join(" ").trim()}const te=200,ne=5e3;let x=null,F=null,U=0,N=0;function oe(t){return new Promise(e=>{window.setTimeout(e,t)})}async function ie(){for(let e=0;e<25;e+=1){const n=document.querySelector("video");if(n)return n;await oe(te)}return document.querySelector("video")}function ae(t,e){const n=t?.getCurrentTime?.();return typeof n=="number"&&Number.isFinite(n)?Math.max(0,Math.round(n*1e3)):e?Math.max(0,Math.round(e.currentTime*1e3)):0}function v(t,e,n,{force:o}={force:!1}){const a=ae(e,n),s=A(e),i={state:t,positionMs:a,contentId:s,updatedAt:Date.now()};!o&&F===t&&Math.abs(a-U)<750||(F=t,U=a,N=a,p({type:"PLAYBACK_STATUS_UPDATE",status:i}).catch(r=>{console.warn("[content] Failed to send playback status",r)}))}function T(t,e){M(),x=window.setInterval(()=>{v("playing",t,e,{force:!0})},ne)}function M(){x!==null&&(window.clearInterval(x),x=null)}async function se(){try{const[t,e]=await Promise.all([B(),ie()]);if(!e){console.warn("[content] No video element found for playback observer.");return}const n=e.paused?"paused":"playing";v(n,t,e,{force:!0}),n==="playing"&&T(t,e),e.addEventListener("playing",()=>{v("playing",t,e,{force:!0}),T(t,e)}),e.addEventListener("pause",()=>{v("paused",t,e,{force:!0}),M()}),e.addEventListener("seeking",()=>{v("seeking",t,e,{force:!0}),M()}),e.addEventListener("seeked",()=>{const o=e.paused?"paused":"playing";v(o,t,e,{force:!0}),o==="playing"&&T(t,e)}),window.addEventListener("beforeunload",()=>{M()})}catch(t){console.error("[content] Failed to initialize playback observer",t)}}function re(){return N}function O(){const t=document.querySelector("video");return t?Math.max(0,Math.round(t.currentTime*1e3)):N}const ce=":host{position:absolute;inset:0;pointer-events:none;z-index:2147483647;font-family:Inter,Helvetica Neue,Arial,sans-serif}.danmaku-container{position:absolute;inset:8% 2% auto;height:35%;display:flex;flex-direction:column;justify-content:space-between;gap:8px}.danmaku-lane{position:relative;flex:1;overflow:hidden}.danmaku-comment{position:absolute;top:0;white-space:normal;max-width:60%;padding:4px 12px;border-radius:999px;background:#1e293bbf;color:#f8fafc;font-size:15px;letter-spacing:.01em;transform:translate(100%);will-change:transform;transition:opacity .3s ease;opacity:.95;line-height:1.35}.danmaku-comment.persona-alex{background:#3b82f6cc}.danmaku-comment.persona-jordan{background:#22c55ecc}.danmaku-comment.persona-sam{background:#ec4899cc}.danmaku-comment.persona-casey{background:#f59e0bd9}@media (prefers-reduced-motion: reduce){.danmaku-comment{transition:transform .3s ease}}",de=4,k=6e3,G=32,$=350,S=90,le=190,ue=150,he=115,me=90,pe=200;class fe{constructor(e){this.host=e,this.#t=e.attachShadow({mode:"open"});const n=document.createElement("style");n.textContent=ce,this.#t.appendChild(n);const o=document.createElement("div");o.className="danmaku-container",this.#t.appendChild(o);for(let a=0;a<de;a+=1){const s=document.createElement("div");s.className="danmaku-lane",o.appendChild(s),this.#e.push({element:s,busyUntil:0})}}#t;#e=[];#n=!0;#s=new Set;#i=0;#r=0;#o=new Map;#c=new Map;#a=new Map;setEnabled(e){this.#n=e,e||this.clear()}clear(){this.#a.forEach(e=>{window.clearTimeout(e)}),this.#a.clear(),this.#e.forEach(e=>{e.element.innerHTML="",e.busyUntil=0}),this.#s.clear()}renderBatch(e){if(!this.#n)return;this.#i=0,this.#r=0;const n=[...e].sort((o,a)=>o.renderAt-a.renderAt);for(const o of n){if(this.#s.has(o.id))continue;const a=this.#m(o),s=o.id;this.#c.set(s,a.length),this.#i+=a.length,o.text.trim().length>S&&(this.#r+=1),a.forEach(i=>{this.#s.has(i.id)||(this.#s.add(i.id),this.#l(i,s))})}this.#f()}#l(e,n){if(!this.#n)return;const o=O(),a=re(),s=o>0?o:a,i=Math.max(0,e.renderAt-s);if(i>0){const r=this.#a.get(e.id);r!==void 0&&window.clearTimeout(r);const d=window.setTimeout(()=>{this.#a.delete(e.id),this.#n&&this.#d(e,n)},i);this.#a.set(e.id,d);return}this.#d(e,n)}#d(e,n){const o=this.#a.get(e.id);o!==void 0&&(window.clearTimeout(o),this.#a.delete(e.id));const a=n??this.#p(e.id),s=this.#u(a);if(s.waitMs>0){window.setTimeout(()=>{this.#n&&this.#d(e,a)},s.waitMs);return}const i=s.lane,r=Date.now(),d=Number.isFinite(e.durationMs)?Math.max(e.durationMs,k):k,u=r+d+$;i.busyUntil<u&&(i.busyUntil=u);const c=document.createElement("div");c.className=`danmaku-comment persona-${e.personaId}`,c.textContent=e.text,c.dataset.commentId=e.id,i.element.appendChild(c),requestAnimationFrame(()=>{const m=i.element.clientWidth||window.innerWidth,f=c.clientWidth,b=m+f+G,l=this.#h(b,e.text.length,e.durationMs),h=[{transform:`translateX(${m}px)`},{transform:`translateX(-${f+G}px)`}],y=c.animate(h,{duration:l,easing:"linear"}),q=Date.now()+l;i.busyUntil=Math.max(i.busyUntil,q+$);const V=i.busyUntil;y.finished.catch(()=>{}).finally(()=>{if(c.remove(),i.busyUntil===V&&(i.busyUntil=Date.now()),this.#s.delete(e.id),a){const D=(this.#c.get(a)??1)-1;D<=0?(this.#c.delete(a),this.#o.delete(a)):this.#c.set(a,D)}})})}#u(e){const n=Date.now();if(e){const s=this.#o.get(e);if(s)return{lane:s,waitMs:Math.max(0,s.busyUntil-n)}}let o=this.#e[0],a=Math.max(0,o.busyUntil-n);for(const s of this.#e){const i=Math.max(0,s.busyUntil-n);if(i===0){o=s,a=0;break}i<a&&(o=s,a=i)}return e&&this.#o.set(e,o),{lane:o,waitMs:a}}#h(e,n,o){let a=le;n>70?a=he:n>45&&(a=ue),a=Math.max(me,a);const s=e/a*1e3;return Math.max(s+pe,o,k)}#m(e){const n=e.text.trim();if(n.length<=S)return[{...e,text:n}];const o=n.slice(0,S-1).trimEnd();return[{...e,text:`${o}…`}]}#p(e){const n=e.indexOf("::");return n===-1?e:e.slice(0,n)}#f(){requestAnimationFrame(()=>{const e=this.#e.filter(n=>n.busyUntil>Date.now()).length;document.dispatchEvent(new CustomEvent("danmaku-metrics",{detail:{activeLanes:e,segmentsGenerated:this.#i,truncated:this.#r}}))})}}let E=null;function be(){if(E)return E;let t=document.getElementById("danmaku-overlay-host");return t||(t=document.createElement("div"),t.id="danmaku-overlay-host",t.style.position="absolute",t.style.inset="0",t.style.pointerEvents="none",(document.querySelector(".watch-video--player-container")??document.querySelector(".watch-video--player-view")??document.body).appendChild(t)),E=new fe(t),E}const ye=".danmaku-control-panel{position:absolute;top:10%;right:2%;width:220px;padding:12px;border-radius:12px;background:#0f172aeb;color:#f1f5f9;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;font-size:14px;pointer-events:auto;z-index:2147483647;box-shadow:0 12px 24px #0f172a59}.danmaku-control-panel.panel-collapsed .panel-body{display:none}.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:600}.panel-collapse{appearance:none;border:none;background:transparent;color:#94a3b8;font-size:16px;cursor:pointer}.panel-body{display:flex;flex-direction:column;gap:10px}.panel-row{display:flex;justify-content:space-between;align-items:center}.switch-row input[type=checkbox]{width:36px;height:18px}.panel-row select{background:#1e293bf2;color:#f8fafc;border:1px solid rgba(148,163,184,.3);border-radius:6px;padding:4px}.persona-group{flex-direction:column;gap:6px;align-items:flex-start}.persona-toggle{display:flex;justify-content:space-between;width:100%;gap:8px}.panel-button{appearance:none;border:none;border-radius:8px;padding:8px 12px;background:#2563eb;color:#f8fafc;cursor:pointer;font-weight:500}.panel-button:hover{background:#1d4ed8}.panel-status{font-size:12px;color:#cbd5f5;min-height:16px}.panel-disabled{opacity:.6}.panel-status-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#cbd5f5;margin-top:6px}.panel-status-badge{padding:2px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;background:#3b82f626;color:#bfdbfe}.panel-status-badge.status-ok{background:#22c55e33;color:#4ade80}.panel-status-badge.status-degraded{background:#eab30833;color:#facc15}.panel-status-badge.status-error{background:#ef444433;color:#f87171}.danmaku-dev-hud{position:fixed;bottom:24px;right:24px;background:#0f172ae6;color:#f8fafc;padding:12px;border-radius:10px;font-size:12px;line-height:1.4;pointer-events:none;z-index:2147483647}";class ve{#t;#e;#n;#s=new Map;#i;#r;#o;#c=!1;constructor({getPreferences:e}){this.#t=document.createElement("div"),this.#t.className="danmaku-control-panel";const n=document.createElement("style");n.textContent=ye,this.#t.appendChild(n);const o=document.createElement("div");o.className="panel-header";const a=document.createElement("span");a.textContent="AI Danmaku",o.appendChild(a);const s=document.createElement("button");s.type="button",s.className="panel-collapse",s.textContent="≡",s.addEventListener("click",()=>this.#a()),o.appendChild(s),this.#t.appendChild(o);const i=document.createElement("div");i.className="panel-body",this.#t.appendChild(i);const r=document.createElement("label");r.className="panel-row switch-row",r.textContent="启用弹幕",this.#e=document.createElement("input"),this.#e.type="checkbox",this.#e.addEventListener("change",()=>{p({type:"UPDATE_PREFERENCES",preferences:{globalEnabled:this.#e.checked}})}),r.appendChild(this.#e),i.appendChild(r);const d=document.createElement("label");d.className="panel-row",d.textContent="弹幕密度",this.#n=document.createElement("select"),["low","medium","high"].forEach(l=>{const h=document.createElement("option");h.value=l,h.textContent=l==="low"?"低":l==="medium"?"中":"高",this.#n.appendChild(h)}),this.#n.addEventListener("change",()=>{p({type:"UPDATE_PREFERENCES",preferences:{density:this.#n.value}})}),d.appendChild(this.#n),i.appendChild(d);const u=document.createElement("div");u.className="panel-row persona-group",u.innerHTML="<strong>虚拟观众</strong>",i.appendChild(u),[{id:"alex",label:"Alex"},{id:"jordan",label:"Jordan"},{id:"sam",label:"Sam"},{id:"casey",label:"Casey"}].forEach(l=>{const h=document.createElement("label");h.className="persona-toggle",h.textContent=l.label;const y=document.createElement("input");y.type="checkbox",y.addEventListener("change",()=>{p({type:"UPDATE_PREFERENCES",preferences:{personaEnabled:{[l.id]:y.checked}}})}),h.appendChild(y),u.appendChild(h),this.#s.set(l.id,y)}),this.#i=document.createElement("button"),this.#i.type="button",this.#i.className="panel-button",this.#i.textContent="重新生成",this.#i.addEventListener("click",()=>{const l=O();p({type:"REGENERATE_FROM_TIMESTAMP",timestamp:l}),this.setStatus("重新生成请求已发送"),window.setTimeout(()=>this.setStatus(""),2e3)}),i.appendChild(this.#i),this.#r=document.createElement("span"),this.#r.className="panel-status",i.appendChild(this.#r);const m=document.createElement("div");m.className="panel-status-row";const f=document.createElement("span");f.textContent="LLM 状态",m.appendChild(f),this.#o=document.createElement("span"),this.#o.className="panel-status-badge status-ok",this.#o.textContent="正常",m.appendChild(this.#o),i.appendChild(m),document.body.appendChild(this.#t);const b=e();b&&this.update(b)}update(e){this.#e.checked=e.globalEnabled,this.#n.value=e.density;for(const[n,o]of this.#s.entries())o.checked=!!e.personaEnabled[n];this.#t.classList.toggle("panel-disabled",!e.globalEnabled)}setStatus(e){this.#r.textContent=e}setLLMStatus(e){const n={ok:"正常",degraded:"降级",error:"错误"},o=e.level;this.#o.textContent=n[o]??o,this.#o.className=`panel-status-badge status-${o}`,this.#o.title=e.detail??""}#a(){this.#c=!this.#c,this.#t.classList.toggle("panel-collapsed",this.#c)}}let R=null;function ge(t){return R||(R=new ve(t)),R}class we{#t;#e={cues:0,comments:0,cacheHitRate:0,avgLLMLatencyMs:0,avgGenerationLatencyMs:0,cacheSizeActiveMb:0,cacheSizeGlobalMb:0,fallbackResponses:0,windowCommentTotal:0,activeLanes:0,segmentsGenerated:0,truncatedComments:0,avgCommentLength:0,dynamicBans:0,toneWarnings:0,hotwordReminders:0,keywordFilterRate:0};constructor(){this.#t=document.createElement("div"),this.#t.className="danmaku-dev-hud",this.#t.innerHTML=this.#n(),document.body.appendChild(this.#t)}update(e){e.cues!==void 0&&(this.#e.cues+=e.cues),e.comments!==void 0&&(this.#e.comments+=e.comments),e.cacheHitRate!==void 0&&(this.#e.cacheHitRate=e.cacheHitRate),e.avgLLMLatencyMs!==void 0&&(this.#e.avgLLMLatencyMs=e.avgLLMLatencyMs),e.avgGenerationLatencyMs!==void 0&&(this.#e.avgGenerationLatencyMs=e.avgGenerationLatencyMs),e.cacheSizeActiveMb!==void 0&&(this.#e.cacheSizeActiveMb=e.cacheSizeActiveMb),e.cacheSizeGlobalMb!==void 0&&(this.#e.cacheSizeGlobalMb=e.cacheSizeGlobalMb),e.fallbackResponses!==void 0&&(this.#e.fallbackResponses=e.fallbackResponses),e.windowCommentTotal!==void 0&&(this.#e.windowCommentTotal=e.windowCommentTotal),e.activeLanes!==void 0&&(this.#e.activeLanes=e.activeLanes),e.segmentsGenerated!==void 0&&(this.#e.segmentsGenerated=e.segmentsGenerated),e.truncatedComments!==void 0&&(this.#e.truncatedComments=e.truncatedComments),e.avgCommentLength!==void 0&&(this.#e.avgCommentLength=e.avgCommentLength),e.dynamicBans!==void 0&&(this.#e.dynamicBans=e.dynamicBans),e.toneWarnings!==void 0&&(this.#e.toneWarnings=e.toneWarnings),e.hotwordReminders!==void 0&&(this.#e.hotwordReminders=e.hotwordReminders),e.keywordFilterRate!==void 0&&(this.#e.keywordFilterRate=e.keywordFilterRate),this.#t.innerHTML=this.#n()}destroy(){this.#t.remove()}#n(){const e=(this.#e.cacheHitRate*100).toFixed(1),n=this.#e.avgLLMLatencyMs.toFixed(0),o=this.#e.avgGenerationLatencyMs.toFixed(0),a=this.#e.cacheSizeActiveMb.toFixed(2),s=this.#e.cacheSizeGlobalMb.toFixed(2),i=this.#e.avgCommentLength.toFixed(1),r=(this.#e.keywordFilterRate*100).toFixed(1);return`
      <div><strong>Dev HUD</strong></div>
      <div>字幕批次: ${this.#e.cues}</div>
      <div>弹幕输出: ${this.#e.comments}</div>
      <div>缓存命中率: ${e}%</div>
      <div>LLM延迟: ${n}ms</div>
      <div>生成耗时: ${o}ms</div>
      <div>缓存占用: ${a} / ${s} MB</div>
      <div>Fallback: ${this.#e.fallbackResponses}</div>
      <div>窗口总弹幕: ${this.#e.windowCommentTotal}</div>
      <div>活跃车道: ${this.#e.activeLanes}</div>
      <div>分段数: ${this.#e.segmentsGenerated} 截断: ${this.#e.truncatedComments}</div>
      <div>平均长度: ${i}</div>
      <div>禁词触发: ${this.#e.dynamicBans}</div>
      <div>Tone 警示: ${this.#e.toneWarnings}</div>
      <div>热词提醒: ${this.#e.hotwordReminders}</div>
      <div>关键词过滤率: ${r}%</div>
    `}}let g=null;function Ee(t){t&&!g&&(g=new we),!t&&g&&(g.destroy(),g=null)}function L(t){g?.update(t)}const z="danmaku-extension-marker";let P=null,w=null;const H=be(),_=ge({getPreferences:()=>w});function xe(){if(document.getElementById(z))return!1;const t=document.createElement("div");return t.id=z,t.style.display="none",document.documentElement.appendChild(t),!0}function W(t){w=t,H.setEnabled(t.globalEnabled),_.update(t),Ee(t.developerMode)}async function Me(t){if(t.length===0)return;P=t[t.length-1]?.contentId??P,L({cues:t.length});const e=await p({type:"CUES_BATCH",cues:t});e?.type==="RENDER_STATUS"&&e.status==="error"&&console.error("[content] Render status error",e.detail)}function Le(){if(!xe()){console.info("[content] Netflix AI Danmaku already initialized; skipping re-attach.");return}console.info("[content] Netflix AI Danmaku content script booting."),p({type:"PING"}),p({type:"REQUEST_PREFERENCES"}).then(n=>{n?.type==="PREFERENCES_RESPONSE"&&W(n.preferences)}),p({type:"REQUEST_LLM_STATUS"}).then(n=>{n?.type==="LLM_STATUS_UPDATE"&&_.setLLMStatus(n.status)}),J().start(n=>{Me(n).catch(o=>{console.error("[content] Failed to send cue batch",o)})}).then(n=>{window.addEventListener("beforeunload",n,{once:!0})}).catch(n=>{console.error("[content] Failed to start subtitle observer",n)}),se().catch(n=>{console.error("[content] Failed to start playback observer",n)})}chrome.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="COMMENTS_BATCH"){H.renderBatch(t.comments);const o=t.comments.reduce((s,i)=>s+i.text.length,0),a=t.comments.length>0?o/t.comments.length:0;L({comments:t.comments.length,avgCommentLength:a});return}if(t.type==="PREFERENCES_RESPONSE"){W(t.preferences);return}if(t.type==="METRICS_UPDATE"){const o=t.metrics.cacheHits+t.metrics.cacheMisses,a=o>0?t.metrics.cacheHits/o:0,s=t.metrics.dynamicBanTermsApplied??0,i=t.metrics.keywordEvaluations??0,r=t.metrics.filteredKeywordDrops??0,d=i>0?r/i:0;L({cacheHitRate:a,avgLLMLatencyMs:t.metrics.averageLLMLatencyMs,avgGenerationLatencyMs:t.metrics.averageGenerationLatencyMs,cacheSizeActiveMb:t.metrics.cacheSizeActiveBytes/(1024*1024),cacheSizeGlobalMb:t.metrics.cacheSizeGlobalBytes/(1024*1024),fallbackResponses:t.metrics.fallbackResponses,windowCommentTotal:t.metrics.windowCommentTotal??0,dynamicBans:s,toneWarnings:t.metrics.toneRepetitionWarnings??0,hotwordReminders:t.metrics.personaHotwordReminders??0,keywordFilterRate:d}),w?.developerMode&&(console.debug("[content] Metrics update",t.metrics),t.metrics.fallbackResponses>0&&console.warn("[content] LLM fallback responses",t.metrics.fallbackResponses));return}if(t.type==="LLM_STATUS_UPDATE"){_.setLLMStatus(t.status),w?.developerMode&&console.debug("[content] LLM status update",t.status);return}if(t.type==="REQUEST_ACTIVE_CONTENT_ID")return n({type:"ACTIVE_CONTENT_ID_RESPONSE",contentId:P}),!0});document.addEventListener("danmaku-metrics",t=>{if(!w?.developerMode)return;const e=t.detail;e&&L({activeLanes:e.activeLanes,segmentsGenerated:e.segmentsGenerated,truncatedComments:e.truncated})});Le();
