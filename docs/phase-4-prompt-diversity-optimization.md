# Phase 4 — Prompt 多样性与重复度优化计划

> 目标：解决弹幕在同一 persona（尤其是 Jordan 等分析型角色）上出现的词汇/句式高度重复问题，建立全链路的多样性约束，使系统在连续场景中仍然输出新鲜、自然的表达。

---

## 0. 背景问题回顾
- 连续场景中，`SceneTone` 被判定为同一枚举值（如 `tense`），提示词里始终写着 “Scene tone: tense”，导致 LLM 偏向使用固定词汇（chaos、tension、vibe 等）。
- `memory.topics` 与 `Notable keywords` 反复包含相同标签，模型会以“延续话题”为由重复先前用词。
- 虚拟子人格的 style 指令差异不大，缺乏专属禁词或多样性要求，LLM 选择最安全的模板化句式。
- Reranker 对重复度惩罚力度不足，同一套表达仍可能被选中。

---

## 1. 总体策略
1. **改良 SceneTone 判定与使用方式**：增加标签精度、减少提示词重复描述，结合动态禁词，避免 tone 信号成为复读触发器。
2. **Prompt 中引入动态禁词与多样性条款**：把 persona 最近输出的高频词直接禁用或要求换说法，提示模型从其他角度描述。
3. **Reranker 与记忆层加大重复惩罚**：在候选打分、记忆记录、缓存复用时更严格地识别并拒绝重复表达。
4. **虚拟子人格差异化**：为不同子人格补充更明确的语气引导、禁用词、few-shot，让他们面对相同场景时自然采用不同表达策略。
5. **监控与可视化**：新增“重复度指标”和 quick alert，让重复问题可观测、可调参。

---

## 2. 任务拆解（建议 3 周封装，按模块推进）

### Week 1 — SceneTone 与 Prompt 基础改造
- **任务 1.1：细化 SceneTone 判定**
  - 扩充 tone 枚举（例如 `thrilling`、`bittersweet`、`mystery` 等），引入情绪词典或轻量模型降低误判。
  - 产出结构新增 `intensity`/`confidence` 字段，为后续 prompt 调整提供参考。
- **任务 1.2：Tone 使用方式调整**
  - 将 `Scene tone: tense` 替换为轮换模板，并按 `intensity` 加入“探索其他细节”的提示。
  - 如果连续多次 tone 相同，在提示中加入醒目指令：“避免重复刚才的措辞，描述其他细节/角度”。
- **任务 1.3：动态关键词过滤**
  - 在 prompt 构建时维护“近期高频词”集合，将其从 `Notable keywords` 中剔除或改写为同义词。
  - 给系统消息追加 `Never reuse: {给定禁词列表}` 字段。

### Week 2 — Reranker、记忆与缓存
- **任务 2.1：重复度打分增强**
  - 对候选文本提取 n-gram，与 persona/global 记忆比对，计算 `phrasePenaltyScore`；得分过高直接丢弃或大幅减分。
  - 增大 `keywordNoveltyScore` 权重，使重复话题难以突围。
- **任务 2.2：记忆层禁词管理**
  - `#rememberOutput` 增加高频名词/形容词统计，超阈值时写入 persona 的 `disallowedPhrases`。
  - 在 prompt 末尾附带“上次用了这些词：...，请换说法”。
- **任务 2.3：缓存策略更新**
  - 缓存记录存储 `keywordHash`，回放时若场景关键词差异较大则避免复用；若差异小但禁词触发，触发“rewrite”流程。

### Week 3 — 虚拟子人格与监控
- **任务 3.1：子人格风格增强**
  - 每个 Jordan 子人格添加独立的 few-shot + 非重复要求，如“聚焦结构”、“指出镜头细节”、“引用幕后知识”等。
  - 配置子人格专属禁词/口癖，避免全部使用“it feels like…”式模板。
- **任务 3.2：多候选生成 / Rewrite**
  - 给 LLM 增加双草稿模式（A/B），如果首稿触发重复惩罚，自动改用 B 或请求 paraphrase。
  - 只有资源允许时启用，可作为可选开关。
- **任务 3.3：监控面板更新**
  - Dev HUD 新增“重复词命中率”“禁词触发次数”“重写次数”等指标。
  - 日志打点重复事件，方便运营/产品定位问题场景。

---

## 3. 成功验收标准
- 同 persona 连续两条弹幕间，重复词（n-gram >=3）下降 ≥ 50%。
- 人工评审对“语言多样性”指标评分较 Phase 3 基线提升 ≥ 30%。
- Dev HUD 观察到 `phrasePenalty`、`rewrite` 指标均在可控范围，且不会激增 fallback 调用。
- 所有自动化测试（unit + replay）通过，新增重复度测试用例覆盖率 ≥ 80%。

---

## 4. 风险与应对
- **生成时间延长**：多一次候选筛选或重写可能增加延迟 → 控制额外调用次数，设置超时降级策略。
- **禁词列表误伤自然表达**：过度约束会让文案显得生硬 → 持续监控误杀情况，支持运营手动调整。
- **场景标签仍然误判**：若 tone 判定不准确，缓存/惩罚反而出错 → 引入回放校验数据，按周更新词典和阈值。

---

## 5. 启动前准备
- 汇总 Phase 3 数据：重复率、top 重复词列表，作为对照基线。
- 确定可用预算：是否允许多一次 LLM 请求（rewrite/A-B）？若否，先做 prompt + reranker 优化。
- 调整 QA 用例：设计“连续 tense 场景”脚本，作为 Phase 4 回归测试。

---

## 6. 交付物清单
- 更新后的 `scene-analyzer`、orchestrator prompt 构建逻辑、reranker、记忆模块代码与测试。
- 虚拟子人格配置更新（speech tics、禁词、few-shot）。
- Dev HUD & 日志新增指标。
- 记录重复度对比数据与人工评审报告，整理 Phase 4 总结文档。

> 完成 Phase 4 后，系统应能保持场景语感判断的同时，显著降低同一观众在连续场景中复用相同词句的概率，为后续扩展（多语言、用户自定义偏好等）打下更稳定的生成基础。
