# 观测与指标

## 指标分层

| 类别 | 指标 | 说明 | 目标 |
| --- | --- | --- | --- |
| 多样性 | 语义重复率 (cos>0.9) | 10 分钟滑窗统计 | < 6% |
| 多样性 | n-gram 冲突率 | 4-gram 重复占比 | < 4% |
| 多样性 | 句式熵、主题熵 | 基于句式 shape 与 topic ledger | 相较基线 +12%-15% |
| 节奏 | 长度分布偏差 | 均值/标准差偏离度 | < 10% |
| 节奏 | 节奏合规率 | 状态机各态占比 vs 目标 | < 10% 偏差 |
| 风格 | tone 命中率 | toneConfig 命中项 / 总项 | ≥ 80% |
| 风格 | 口头禅超用次数 | 超阈值事件数 | 持续下降 |
| 质量 | 超长率 (>20 词) | 10 分钟窗口 | < 3% |
| 质量 | 短噪率 (<4 词) | 10 分钟窗口 | < 8% |
| 体验 | 用户隐藏/举报率 | 如有外部反馈数据 | 不上升或下降 |

## 数据来源
- `OrchestratorMetrics` 新增字段：`duplicateHardRejects`、`semanticRejects`、`lowRelevanceDrops`、`styleFitDrops`。
- 计划在阶段 2-4 增加：tone 命中率、长度/节奏偏差、口头禅统计。
- HUD（开发者模式）显示实时快照；同时写入调试日志以便回溯。

## 仪表盘规划
1. **实时面板（Dev HUD）**：显示当前窗口内重复率、拒绝原因、tone 命中率、平均长度。
2. **历史面板（Grafana/Looker）**：按日/场次汇总，支持过滤 persona、内容 ID。
3. **A/B 报告模板**：对比指标 + 用户反馈，给出通过/阻塞结论。

## 报警策略
- 语义重复率 > 10% 持续 5 分钟 → WARN。
- 节奏偏差 > 20% 或 连续 60 秒无弹幕 → WARN。
- styleFitDrops 或 lowRelevanceDrops 激增 → 检查配置/策略。

## 数据保存
- metrics 通过后台广播到 `developer-hud`；后续计划将核心指标写入持久化服务，保留 7~14 天。
- 重复索引日志（命中 n-gram / 语义重复）以采样方式记录，用于调试。
