# Phase 2 — Humanlike Danmaku Generation Initiative

> 使命：让弹幕像一群真正的观众在 Reddit 上讨论一样——少而准、多视角、口语化、带点瑕疵、有连续感与节奏错落。规划周期 4 周，可按周滚动迭代。

---

## 总体策略概览
1. **场景理解先行**：先判断“值得发声”的场景，再决定谁说、说什么，降低机械化泛滥。
2. **双层生成体系**：轻量模型/规则负责情绪与主题判断，主 LLM 在更精确的提示下生成候选弹幕。
3. **多 persona 协同**：设计多视角人物，并确保他们轮流、互动、偶尔沉默，形成真实社群氛围。
4. **调度 + 渲染协作**：通过队列、去重、节奏错峰及 lane 管理，确保同屏既不过载又不尴尬。
5. **持续反馈闭环**：自动指标 + 人工评审 + 用户反馈→定期更新提示词、参数、策略。

---

## 任务分解（按周推进）

### Week 1 — 场景理解 & Prompt 体系
- [x] **字幕场景解析模块**：
  - 抽取角色、情绪、节奏（紧张/静场/冲突等），标记“可发声”或“建议沉默”。
  - 输出 persona 感兴趣的主题标签（如冷知识、感情线、搞笑）。
- [x] **Persona 语气板重写**：
  - 更新 `systemPrompt` / `styleGuidelines`，增加“日常口语+长度约束+跳过无意义回复”规则。
  - 为每个 persona 建立“口癖 + 禁用词”配置，限制语气词滥用。
- [x] **few-shot 示例升级**：覆盖高潮、静场、接梗、沉默等场景，prompt 中加入“若无观点则输出 [skip]”。
- [x] **Prompt A/B 配置**：将提示词、few-shot、persona 参数外置（JSON/远程配置），支持运行时切换。
- [x] **短期记忆缓冲**：为 persona 保存最近 2–3 条发言主题，用于续谈或自我引用。

### Week 2 — 生成调度与密度管控
- [x] **候选池 & 评分器**：
  - 每次场景生成 2–3 个候选（不同 persona 或角度），根据相关性、情绪多样性、重复度打分。
  - 引入 `[skip]` 过滤；对超长文本优先截断或弃用。
- [x] **队列与静默策略**：
  - 单 persona 同屏最多 1 条，同窗口（如 8 秒）总数≤3；过量时按得分淘汰。
  - 维护“静默期参数”，无价值场景直接跳过，营造“有呼吸”的节奏。
- [x] **主题去重**：
  - 基于 embedding/关键字比较，与最近 20 秒弹幕相似度过高则丢弃。
  - 设计“互动场景”：A 触发后 B 可接梗，但同一主题不会被四人重复吐槽。
- [x] **缓存扩展**：缓存键加入提示词版本/情绪标签，支持重复场景复用优质弹幕。

### Week 3 — 渲染与节奏表现
- [x] **Lane 管理重构**：
  - 每条弹幕分配唯一 lane，计算可用宽度与滚动时间，避免碰撞。
  - 根据字符宽度调整速度，必要时分段展示。
- [x] **节奏错落引擎**：
  - 设置轮询+随机抖动的 persona 顺序；同 persona 需间隔≥N 秒。
  - 高潮场景允许 2 persona 交错，静场场景完全静音。
- [x] **口语与瑕疵后处理**：
  - 控制语气词密度，随机保留少量缩写/错字（≤15%），防止模板感。
  - 在必要场景加入续写提示（“…still wild”），但概率控制，避免模式化。

### Week 4 — 质量监控、工具与总结
- [x] **自动指标仪表板**：
  - 统计长度分布、语气词密度、重复率、跳过率、静默时长、Fallback 占比。
  - Dev HUD 显示 lane 占用、排队长度、截断次数。
- [x] **人工评审流程**：详见 `docs/review/manual-evaluation.md`。
  - 每周抽样（≥30 条），评审自然度/幽默度/多样性；生成“人味评分”报告。
  - 根据反馈调整 persona 激活、密度参数、口癖列表。
- [x] **用户反馈入口**：控制面板增加“太多/太机械”等 quick feedback 按钮（存储于 `feedbackStore`），供评审汇总使用。
- [x] **回放 & 离线测试工具**：已提供 `npm run replay:cues`（基于 `src/tools/replay-session.ts`）生成可共享的离线弹幕样本。
  - 开发回放脚本记录一次播放的弹幕序列，便于 Prompt/调度复现与调试。
  - 提供 CLI/脚本批量生成离线样本，供评审和 A/B 对比。
- [x] **文档化与交付**：已新增 `docs/review/manual-evaluation.md` 并更新 Phase 总结流程。
  - 更新配置说明、实验数据、评审结论；编写 Phase 总结与下一步建议。

---

## 里程碑
- **G1（Week 1 末）**：场景解析可运行，新 persona prompt 生效，提供 A/B 样本对比。
- **G2（Week 2 末）**：调度/队列落实，同屏条数与长度阈值受控；密度错落清晰。
- **G3（Week 3 末）**：lane 管理、防重叠、口语化后处理完成，实测屏幕观感自然。
- **G4（Week 4 末）**：指标仪表板、回放工具、人工评审流程上线，输出 Phase 总结报告。

> 完成上述任务后，即可进入 Phase 3（多语言扩展、个性化配置或商业化准备）。
---

## Pending Items & Dependencies
本阶段关键交付已完成，建议基于新的反馈数据和离线回放脚本制定 Phase 3 启动评审。
